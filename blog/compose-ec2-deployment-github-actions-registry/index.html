<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Amazon EC2 Deployments with GitHub Actions, Terraform, Docker &amp; Self-hosted Registry | Vue &amp; Node admin panel framework</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://adminforth.dev/blog/compose-ec2-deployment-github-actions-registry/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Amazon EC2 Deployments with GitHub Actions, Terraform, Docker &amp; Self-hosted Registry | Vue &amp; Node admin panel framework"><meta data-rh="true" name="description" content="The ultimate step-by-step guide to cost-effective, build-time-efficient, and easy managable EC2 deployments using GitHub Actions, Terraform, Docker, and a self-hosted registry."><meta data-rh="true" property="og:description" content="The ultimate step-by-step guide to cost-effective, build-time-efficient, and easy managable EC2 deployments using GitHub Actions, Terraform, Docker, and a self-hosted registry."><meta data-rh="true" property="og:image" content="https://adminforth.dev/ogs/ga-tf-aws.jpg"><meta data-rh="true" name="twitter:image" content="https://adminforth.dev/ogs/ga-tf-aws.jpg"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2025-02-19T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/ivictbor"><meta data-rh="true" property="article:tag" content="AWS,Terraform,GitHub Actions"><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://adminforth.dev/blog/compose-ec2-deployment-github-actions-registry/"><link data-rh="true" rel="alternate" href="https://adminforth.dev/blog/compose-ec2-deployment-github-actions-registry/" hreflang="en"><link data-rh="true" rel="alternate" href="https://adminforth.dev/blog/compose-ec2-deployment-github-actions-registry/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://VSIPOF54AV-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://adminforth.dev/blog/compose-ec2-deployment-github-actions-registry","mainEntityOfPage":"https://adminforth.dev/blog/compose-ec2-deployment-github-actions-registry","url":"https://adminforth.dev/blog/compose-ec2-deployment-github-actions-registry","headline":"Amazon EC2 Deployments with GitHub Actions, Terraform, Docker & Self-hosted Registry","name":"Amazon EC2 Deployments with GitHub Actions, Terraform, Docker & Self-hosted Registry","description":"The ultimate step-by-step guide to cost-effective, build-time-efficient, and easy managable EC2 deployments using GitHub Actions, Terraform, Docker, and a self-hosted registry.","datePublished":"2025-02-19T00:00:00.000Z","author":{"@type":"Person","name":"Ivan Borshchov","description":"Maintainer of AdminForth","url":"https://github.com/ivictbor","image":"https://avatars.githubusercontent.com/u/1838656?v=4"},"image":{"@type":"ImageObject","@id":"https://adminforth.dev/ogs/ga-tf-aws.jpg","url":"https://adminforth.dev/ogs/ga-tf-aws.jpg","contentUrl":"https://adminforth.dev/ogs/ga-tf-aws.jpg","caption":"title image for the blog post: Amazon EC2 Deployments with GitHub Actions, Terraform, Docker & Self-hosted Registry"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://adminforth.dev/blog","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Vue &amp; Node admin panel framework RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Vue &amp; Node admin panel framework Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-7K99Q2BH04"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-7K99Q2BH04",{anonymize_ip:!0})</script>



<link rel="search" type="application/opensearchdescription+xml" title="Vue &amp; Node admin panel framework" href="/opensearch.xml">

<script src="/scripts/adminforth.js"></script><link rel="stylesheet" href="/assets/css/styles.db85669b.css">
<script src="/assets/js/runtime~main.68cffb0b.js" defer="defer"></script>
<script src="/assets/js/main.8df6796d.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="AdminForth Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="AdminForth Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">AdminForth</b></a><a class="navbar__item navbar__link" href="/docs/tutorial/gettingStarted/">Tutorial</a><a class="navbar__item navbar__link" href="/docs/api/">API</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog/">Blog</a></div><div class="navbar__items navbar__items--right"><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div><a href="https://demo.adminforth.dev/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Live Demo<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/devforth/adminforth" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2025</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/k3s-ec2-deployment/">IaC Simplified: K3s on EC2 Deployments with Terraform, Helm, Ansible &amp; Amazon ECR</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/context7-setup-vscode/">How to set up Context7 MCP in Visual Studio Code</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/dynamic-strings-translation/">How to translate dynamic strings in AdminForth API</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/keycloak-setup-example/">Setup AdminForth Authorization via Keycloak</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/compose-aws-ec2-ecr-terraform-github-actions/">IaaC Simplified: Amazon EC2 Deployments with GitHub Actions, Terraform, Docker &amp; Amazon ECR</a></li></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class="title_f1Hy">Amazon EC2 Deployments with GitHub Actions, Terraform, Docker &amp; Self-hosted Registry</h1><div class="container_mt6G margin-vert--md"><time datetime="2025-02-19T00:00:00.000Z">February 19, 2025</time> · <!-- -->16 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/ivictbor" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://avatars.githubusercontent.com/u/1838656?v=4" alt="Ivan Borshchov"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/ivictbor" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">Ivan Borshchov</span></a></div><small class="authorTitle_nd0D" title="Maintainer of AdminForth">Maintainer of AdminForth</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p><img decoding="async" loading="lazy" alt="alt text" src="/assets/images/ga-tf-aws-fd1b40a236f46c0ffc8c09ef37abaf38.jpg" width="1200" height="630" class="img_ev3q"></p>
<p>This guide is a hackers extended addition of <a href="/blog/compose-aws-ec2-ecr-terraform-github-actions/">Deploying AdminForth to EC2 with Amazon ECR</a>. The key difference in this post that we will not use Amazon ECR but self-host registry on EC2 itself. Automatically from terraform. And will see whether we will win something in terms of build time.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="costs-for-amazon-ecr-vs-consts-for-self-hosted-registry-on-ec2">Costs for Amazon ECR vs consts for self-hosted registry on EC2<a href="#costs-for-amazon-ecr-vs-consts-for-self-hosted-registry-on-ec2" class="hash-link" aria-label="Direct link to Costs for Amazon ECR vs consts for self-hosted registry on EC2" title="Direct link to Costs for Amazon ECR vs consts for self-hosted registry on EC2">​</a></h2>
<p>Most of AWS services are formed from EC2 prices plus some extra overhead for own cost. In same way, Amazon ECR pricing is pretty same.</p>
<table><thead><tr><th>Feature</th><th>Amazon ECR</th><th>Self-hosted registry on EC2</th></tr></thead><tbody><tr><td>Storage</td><td>$0.10 per GB/month</td><td>$0.10 per GB/month for gp2 EBS volume</td></tr><tr><td>Data transfer for egress</td><td>$0.09 per GB</td><td>$0.09 per GB</td></tr></tbody></table>
<p>So as you can see there is still no difference in terms of cost. However the approach in this system allows to replace Amazon EC2 with any other cloud provider which does not charge for egress traffic.</p>
<h1>Bechnmarking build time</h1>
<p>When I implmented this solution, I was curious whether it will be faster to build images on EC2 or on CI. So I did a little bit of testing.
First I used results form <a href="/blog/compose-ec2-deployment-github-actions/">deploying AdminForth to EC2 with Terraform without registry</a> where we built images on EC2. Then I did the same test but with self-hosted registry on EC2 and compared to <a href="/blog/compose-aws-ec2-ecr-terraform-github-actions/">deploying AdminForth to EC2 with Amazon ECR</a> where we built images on CI and pushed to Amazon ECR.</p>
<table><thead><tr><th>Feature</th><th>Without Registry (build directly on EC2)</th><th>With self-hosted registry</th><th>With Amazon ECR</th></tr></thead><tbody><tr><td>Initial build time*</td><td>3m 13.541s</td><td>2m 48.412s</td><td>3m 54s</td></tr><tr><td>Rebuild time (changed <code>index.ts</code>)*</td><td>0m 51.653s</td><td>0m42.131s</td><td>0m 54.120s</td></tr></tbody></table>
<sub>* All tests done from local machine (Intel(R) Core(TM) Ultra 9 185H, Docker Desktop/WSL2 64 GB RAM, 300Mbps up/down) up to working state</sub>
<p>So it indeed own self-hosted registry is faster then ECR and overall build time of pure AdminForth is faster then building on EC2. When ECR is slower then self-hosted registry, it is because of network speed.</p>
<h1>Chellenges when you build on CI</h1>
<h1>Registry authorization and traffic encryption</h1>
<p>Hosting custom CNCF registry, from other hand is a security responsibility.</p>
<p>If you don&#x27;t protect it right, someone will be able to push any image to your registry and then pull it to your EC2 instance. This is a big security issue, so we have to protect our registry.</p>
<p>First of all we need to set some authorization to our registry so everyone who will push/pull images will be authorized. Here we have 2 options: HTTP basic auth and Client certificate auth. We will use first one as it is easier to setup. We will generate basic login and password automatically in terraform so no extra actions are needed from you.</p>
<p>But this is not enough. Basic auth is not encrypted, so someone can perform MITM attack and get your credentials. So we need to encrypt traffic between CI and registry. We can do it by using TLS certificates. So we will generate self-signed TLS certificates, and attach them to our registry.</p>
<p>Though the challenge is that we need to provide CA certificate to every daemon which will work with our registry. So we need to provide CA certificate to buildx daemon on CI, also if we want to do it from local machine, we need to provide CA certificate to local docker daemon.</p>
<h1>Practice - deploy setup</h1>
<p>Assume you have your AdminForth project in <code>myadmin</code>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-1---dockerfile-and-dockerignore">Step 1 - Dockerfile and .dockerignore<a href="#step-1---dockerfile-and-dockerignore" class="hash-link" aria-label="Direct link to Step 1 - Dockerfile and .dockerignore" title="Direct link to Step 1 - Dockerfile and .dockerignore">​</a></h2>
<p>This guide assumes you have created your AdminForth application with latest version of <code>adminforth create-app</code> command.
This command already creates a <code>Dockerfile</code> and <code>.dockerignore</code> for you, so you can use them as is.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-2---composeyml">Step 2 - compose.yml<a href="#step-2---composeyml" class="hash-link" aria-label="Direct link to Step 2 - compose.yml" title="Direct link to Step 2 - compose.yml">​</a></h2>
<p>create folder <code>deploy</code> and create file <code>compose.yml</code> inside:</p>
<div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">deploy/compose.yml</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token key atrule">services</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token key atrule">traefik</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;traefik:v2.5&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">command</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;--api.insecure=true&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;--providers.docker=true&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;--entrypoints.web.address=:80&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;80:80&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">volumes</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;/var/run/docker.sock:/var/run/docker.sock:ro&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token key atrule">myadmin</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> localhost</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain">5000/myadmin</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">build</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token key atrule">context</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> ../adminforth</span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain">app</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token key atrule">tags</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> localhost</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain">5000/myadmin</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token key atrule">cache_from</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> type=registry</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">ref=localhost</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain">5000/myadmin</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain">cache</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token key atrule">cache_to</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> type=registry</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">ref=localhost</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain">5000/myadmin</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain">cache</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">mode=max</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">compression=zstd</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">image</span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain">manifest=true</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">oci</span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain">mediatypes=true</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">pull_policy</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> always</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">restart</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> always</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">env_file</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> .env.secrets.prod</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">volumes</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> myadmin</span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain">db</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain">/code/db</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;traefik.enable=true&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;traefik.http.routers.myadmin.rule=PathPrefix(`/`)&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;traefik.http.services.myadmin.loadbalancer.server.port=3500&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;traefik.http.routers.myadmin.priority=2&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token key atrule">volumes</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  myadmin</span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain">db</span><span class="token punctuation" style="color:#f8f8f2">:</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-3---create-a-ssh-keypair">Step 3 - create a SSH keypair<a href="#step-3---create-a-ssh-keypair" class="hash-link" aria-label="Direct link to Step 3 - create a SSH keypair" title="Direct link to Step 3 - create a SSH keypair">​</a></h2>
<p>Make sure you are still in <code>deploy</code> folder, run next command:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">deploy</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token function" style="color:#e6db74">mkdir</span><span class="token plain"> .keys </span><span class="token operator" style="color:#66d9ef">&amp;&amp;</span><span class="token plain"> ssh-keygen </span><span class="token parameter variable" style="color:#f8f8f2">-f</span><span class="token plain"> .keys/id_rsa </span><span class="token parameter variable" style="color:#f8f8f2">-N</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now it should create <code>deploy/.keys/id_rsa</code> and <code>deploy/.keys/id_rsa.pub</code> files with your SSH keypair. Terraform script will put the public key to the EC2 instance and will use private key to connect to the instance. Also you will be able to use it to connect to the instance manually.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-4---create-tls-certificates-to-encrypt-traffic-between-ci-and-registry">Step 4 - create TLS certificates to encrypt traffic between CI and registry<a href="#step-4---create-tls-certificates-to-encrypt-traffic-between-ci-and-registry" class="hash-link" aria-label="Direct link to Step 4 - create TLS certificates to encrypt traffic between CI and registry" title="Direct link to Step 4 - create TLS certificates to encrypt traffic between CI and registry">​</a></h2>
<p>Make sure you are still in <code>deploy</code> folder, run next command:</p>
<p>Run next command to create TLS certificates:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">openssl req </span><span class="token parameter variable" style="color:#f8f8f2">-new</span><span class="token plain"> </span><span class="token parameter variable" style="color:#f8f8f2">-x509</span><span class="token plain"> </span><span class="token parameter variable" style="color:#f8f8f2">-days</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">3650</span><span class="token plain"> </span><span class="token parameter variable" style="color:#f8f8f2">-newkey</span><span class="token plain"> rsa:4096 </span><span class="token parameter variable" style="color:#f8f8f2">-nodes</span><span class="token plain"> </span><span class="token parameter variable" style="color:#f8f8f2">-keyout</span><span class="token plain"> .keys/ca.key </span><span class="token parameter variable" style="color:#f8f8f2">-subj</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;/CN=My Custom CA&quot;</span><span class="token plain"> </span><span class="token parameter variable" style="color:#f8f8f2">-out</span><span class="token plain"> .keys/ca.pem</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This will create <code>deploy/.keys/ca.key</code> and <code>deploy/.keys/ca.pem</code> files.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-5---gitignore-file">Step 5 - .gitignore file<a href="#step-5---gitignore-file" class="hash-link" aria-label="Direct link to Step 5 - .gitignore file" title="Direct link to Step 5 - .gitignore file">​</a></h2>
<p>Create <code>deploy/.gitignore</code> file with next content:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">.terraform/</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">.keys/</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">*.tfstate</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">*.tfstate.*</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">*.tfvars</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">tfplan</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">.env.secrets.prod</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-6---file-with-secrets-for-local-deploy">Step 6 - file with secrets for local deploy<a href="#step-6---file-with-secrets-for-local-deploy" class="hash-link" aria-label="Direct link to Step 6 - file with secrets for local deploy" title="Direct link to Step 6 - file with secrets for local deploy">​</a></h2>
<p>Create file <code>deploy/.env.secrets.prod</code></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token assign-left variable" style="color:#f8f8f2">ADMINFORTH_SECRET</span><span class="token operator" style="color:#66d9ef">=</span><span class="token operator" style="color:#66d9ef">&lt;</span><span class="token plain">your_secret</span><span class="token operator" style="color:#66d9ef">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-7---main-terraform-file-maintf">Step 7 - main terraform file main.tf<a href="#step-7---main-terraform-file-maintf" class="hash-link" aria-label="Direct link to Step 7 - main terraform file main.tf" title="Direct link to Step 7 - main terraform file main.tf">​</a></h2>
<p>First of all install Terraform as described here <a href="https://developer.hashicorp.com/terraform/install#linux" target="_blank" rel="noopener noreferrer">terraform installation</a>.</p>
<p>Create file <code>main.tf</code> in <code>deploy</code> folder:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">deploy/main.tf</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">locals {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  app_name = &quot;&lt;your_app_name&gt;&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  aws_region = &quot;us-east-1&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">provider &quot;aws&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  region = local.aws_region</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  profile = &quot;myaws&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">data &quot;aws_ami&quot; &quot;ubuntu_linux&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  most_recent = true</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  owners      = [&quot;amazon&quot;]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  filter {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    name   = &quot;name&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    values = [&quot;ubuntu/images/hvm-ssd-gp3/ubuntu-noble-24.04-amd64-server-*&quot;]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">data &quot;aws_vpc&quot; &quot;default&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  default = true</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">resource &quot;aws_eip&quot; &quot;eip&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"> domain = &quot;vpc&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">resource &quot;aws_eip_association&quot; &quot;eip_assoc&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"> instance_id   = aws_instance.app_instance.id</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"> allocation_id = aws_eip.eip.id</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">data &quot;aws_subnet&quot; &quot;default_subnet&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  filter {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    name   = &quot;vpc-id&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    values = [data.aws_vpc.default.id]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  filter {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    name   = &quot;default-for-az&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    values = [&quot;true&quot;]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  filter {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    name   = &quot;availability-zone&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    values = [&quot;${local.aws_region}a&quot;]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">resource &quot;aws_security_group&quot; &quot;instance_sg&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  name   = &quot;${local.app_name}-instance-sg&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  vpc_id = data.aws_vpc.default.id</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  ingress {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    description = &quot;Allow HTTP&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    from_port   = 80</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    to_port     = 80</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    protocol    = &quot;tcp&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    cidr_blocks = [&quot;0.0.0.0/0&quot;]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  ingress {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    description = &quot;Allow Docker registry&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    from_port   = 5000</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    to_port     = 5000</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    protocol    = &quot;tcp&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    cidr_blocks = [&quot;0.0.0.0/0&quot;]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  # SSH</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  ingress {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    description = &quot;Allow SSH&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    from_port   = 22</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    to_port     = 22</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    protocol    = &quot;tcp&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    cidr_blocks = [&quot;0.0.0.0/0&quot;]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  egress {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    description = &quot;Allow all outbound traffic&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    from_port   = 0</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    to_port     = 0</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    protocol    = &quot;-1&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    cidr_blocks = [&quot;0.0.0.0/0&quot;]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">resource &quot;aws_key_pair&quot; &quot;app_deployer&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  key_name   = &quot;terraform-deploy_${local.app_name}-key&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  public_key = file(&quot;./.keys/id_rsa.pub&quot;) # Path to your public SSH key</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">resource &quot;aws_instance&quot; &quot;app_instance&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  ami                    = data.aws_ami.ubuntu_linux.id</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  instance_type          = &quot;t3a.small&quot;  # just change it to another type if you need, check https://instances.vantage.sh/</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  subnet_id              = data.aws_subnet.default_subnet.id</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  vpc_security_group_ids = [aws_security_group.instance_sg.id]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  key_name               = aws_key_pair.app_deployer.key_name</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  # prevent accidental termination of ec2 instance and data loss</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  # if you will need to recreate the instance still (not sure why it can be?), you will need to remove this block manually by next command:</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  # &gt; terraform taint aws_instance.app_instance</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  lifecycle {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    prevent_destroy = true</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ignore_changes = [ami]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  root_block_device {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    volume_size = 20 // Size in GB for root partition</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    volume_type = &quot;gp2&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    # Even if the instance is terminated, the volume will not be deleted, delete it manually if needed</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    delete_on_termination = false</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  user_data = &lt;&lt;-EOF</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    #!/bin/bash</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    sudo apt-get update</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    sudo apt-get install ca-certificates curl</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    sudo install -m 0755 -d /etc/apt/keyrings</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    sudo chmod a+r /etc/apt/keyrings/docker.asc</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    # Add the repository to Apt sources:</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    echo \</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      &quot;deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      $(. /etc/os-release &amp;&amp; echo &quot;$VERSION_CODENAME&quot;) stable&quot; | \</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    sudo apt-get update</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin screen</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    systemctl start docker</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    systemctl enable docker</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    usermod -a -G docker ubuntu</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    echo &quot;done&quot; &gt; /home/ubuntu/user_data_done</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  EOF</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  tags = {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    Name = &quot;${local.app_name}-instance&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">resource &quot;null_resource&quot; &quot;wait_for_user_data&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  provisioner &quot;remote-exec&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    inline = [</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      &quot;echo &#x27;Waiting for EC2 software install to finish...&#x27;&quot;,</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      &quot;while [ ! -f /home/ubuntu/user_data_done ]; do echo &#x27;...&#x27;; sleep 2; done&quot;,</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      &quot;echo &#x27;EC2 software install finished.&#x27;&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    connection {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      type        = &quot;ssh&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      user        = &quot;ubuntu&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      private_key = file(&quot;./.keys/id_rsa&quot;)</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      host        = aws_eip_association.eip_assoc.public_ip</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  depends_on = [aws_instance.app_instance]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">resource &quot;null_resource&quot; &quot;setup_registry&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  provisioner &quot;local-exec&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    command = &lt;&lt;-EOF</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      echo &quot;Generating secret for local registry&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      sha256sum ./.keys/id_rsa | cut -d &#x27; &#x27; -f1 | tr -d &#x27;\n&#x27; &gt; ./.keys/registry.pure</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      echo &quot;Creating htpasswd file for local registry&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      docker run --rm --entrypoint htpasswd httpd:2 -Bbn ci-user $(cat ./.keys/registry.pure) &gt; ./.keys/registry.htpasswd</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      echo &quot;Generating server certificate for registry&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      openssl genrsa -out ./.keys/registry.key 4096</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      echo &quot;subjectAltName=DNS:appserver.local,DNS:localhost,IP:127.0.0.1&quot; &gt; san.ext</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      openssl req -new -key ./.keys/registry.key -subj &quot;/CN=appserver.local&quot; -addext &quot;$(cat san.ext)&quot; -out ./.keys/registry.csr</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      openssl x509 -req -days 365 -CA ./.keys/ca.pem -CAkey ./.keys/ca.key -set_serial 01 -in ./.keys/registry.csr -extfile san.ext -out ./.keys/registry.crt </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      echo &quot;Copying registry secret files to the instance&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      rsync -t -avz -e &quot;ssh -i ./.keys/id_rsa -o StrictHostKeyChecking=no&quot; \</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        ./.keys/registry.* ubuntu@${aws_eip_association.eip_assoc.public_ip}:/home/ubuntu/registry-auth</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    EOF</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  provisioner &quot;remote-exec&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    inline = [&lt;&lt;-EOF</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      # remove old registry if exists</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      docker rm -f registry</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      # run new registry</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      docker run -d --network host \</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        --name registry \</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        --restart always \</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        -v /home/ubuntu/registry-data:/var/lib/registry \</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        -v /home/ubuntu/registry-auth:/auth\</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        -e &quot;REGISTRY_AUTH=htpasswd&quot; \</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        -e &quot;REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm&quot; \</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        -e &quot;REGISTRY_AUTH_HTPASSWD_PATH=/auth/registry.htpasswd&quot; \</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        -e &quot;REGISTRY_HTTP_TLS_CERTIFICATE=/auth/registry.crt&quot; \</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        -e &quot;REGISTRY_HTTP_TLS_KEY=/auth/registry.key&quot; \</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        registry:2</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      EOF</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    connection {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      type        = &quot;ssh&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      user        = &quot;ubuntu&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      private_key = file(&quot;./.keys/id_rsa&quot;)</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      host        = aws_eip_association.eip_assoc.public_ip</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  triggers = {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    always_run = 1 # change number to redeploy registry (if for some reason it was removed)</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  depends_on = [null_resource.wait_for_user_data]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">resource &quot;null_resource&quot; &quot;sync_files_and_run&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  provisioner &quot;local-exec&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    command = &lt;&lt;-EOF</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      # map appserver.local to the instance (in CI we don&#x27;t know the IP, so have to use this mapping)</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      # so then in GA pipeline we will use </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      #  - name: Set up Docker Buildx</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      #   uses: docker/setup-buildx-action@v3</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      #   with:</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      #     buildkitd-config-inline: |</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      #       [registry.&quot;appserver.local:5000&quot;]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      #         ca=[&quot;deploy/.keys/ca.pem&quot;]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      grep -q &quot;appserver.local&quot; /etc/hosts || echo &quot;${aws_eip_association.eip_assoc.public_ip} appserver.local&quot; | sudo tee -a /etc/hosts</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      # hosts modification may take some time to apply</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      sleep 5</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      # generate buildx authorization</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      sha256sum ./.keys/id_rsa | cut -d &#x27; &#x27; -f1 | tr -d &#x27;\n&#x27; &gt; ./.keys/registry.pure</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      echo &#x27;{&quot;auths&quot;:{&quot;appserver.local:5000&quot;:{&quot;auth&quot;:&quot;&#x27;$(echo -n &quot;ci-user:$(cat ./.keys/registry.pure)&quot; | base64 -w 0)&#x27;&quot;}}}&#x27; &gt; ~/.docker/config.json</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      echo &quot;Running build&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      docker buildx bake --progress=plain --push --allow=fs.read=.. -f compose.yml</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      # compose temporarily it is not working https://github.com/docker/compose/issues/11072#issuecomment-1848974315</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      # docker compose --progress=plain -p app -f ./compose.yml build --push</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      # if you will change host, pleasee add -o StrictHostKeyChecking=no</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      echo &quot;Copy files to the instance&quot; </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      rsync -t -avz --mkpath -e &quot;ssh -i ./.keys/id_rsa -o StrictHostKeyChecking=no&quot; \</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        --delete \</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        --exclude &#x27;.terraform&#x27; \</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        --exclude &#x27;.keys&#x27; \</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        --exclude &#x27;tfplan&#x27; \</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        . ubuntu@${aws_eip_association.eip_assoc.public_ip}:/home/ubuntu/app/deploy/</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      EOF</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  # Run docker compose after files have been copied</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  provisioner &quot;remote-exec&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    inline = [&lt;&lt;-EOF</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      # login to docker registry</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      cat /home/ubuntu/registry-auth/registry.pure | docker login localhost:5000 -u ci-user --password-stdin</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      cd /home/ubuntu/app/deploy</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      echo &quot;Spinning up the app&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      docker compose --progress=plain -p app -f compose.yml up -d --remove-orphans</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      # cleanup unused cache (run in background to not block terraform)</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      screen -dm docker system prune -f</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      screen -dm docker exec registry registry garbage-collect /etc/docker/registry/config.yml --delete-untagged=true </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    EOF</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    connection {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      type        = &quot;ssh&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      user        = &quot;ubuntu&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      private_key = file(&quot;./.keys/id_rsa&quot;)</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      host        = aws_eip_association.eip_assoc.public_ip</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  # Ensure the resource is triggered every time based on timestamp or file hash</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  triggers = {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    always_run = timestamp()</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  depends_on = [aws_eip_association.eip_assoc, null_resource.setup_registry]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">output &quot;instance_public_ip&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  value = aws_eip_association.eip_assoc.public_ip</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">######### META, tf state ##############</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"># S3 bucket for storing Terraform state</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">resource &quot;aws_s3_bucket&quot; &quot;terraform_state&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  bucket = &quot;${local.app_name}-terraform-state&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">resource &quot;aws_s3_bucket_lifecycle_configuration&quot; &quot;terraform_state&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  bucket = aws_s3_bucket.terraform_state.bucket</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  rule {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    status = &quot;Enabled&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    id = &quot;Keep only the latest version of the state file&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    filter {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      prefix = &quot;&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    noncurrent_version_expiration {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      noncurrent_days = 30</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">resource &quot;aws_s3_bucket_versioning&quot; &quot;terraform_state&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  bucket = aws_s3_bucket.terraform_state.bucket</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  versioning_configuration {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    status = &quot;Enabled&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">resource &quot;aws_s3_bucket_server_side_encryption_configuration&quot; &quot;terraform_state&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  bucket = aws_s3_bucket.terraform_state.bucket</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  rule {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    apply_server_side_encryption_by_default {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      sse_algorithm     = &quot;AES256&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>👆 Replace <code>&lt;your_app_name&gt;</code> with your app name (no spaces, only underscores or letters)</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-71---configure-aws-profile">Step 7.1 - Configure AWS Profile<a href="#step-71---configure-aws-profile" class="hash-link" aria-label="Direct link to Step 7.1 - Configure AWS Profile" title="Direct link to Step 7.1 - Configure AWS Profile">​</a></h3>
<p>Open or create file <code>~/.aws/credentials</code> and add (if not already there):</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">[myaws]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">aws_access_key_id = &lt;your_access_key&gt;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">aws_secret_access_key = &lt;your_secret_key&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-72---run-deployment">Step 7.2 - Run deployment<a href="#step-72---run-deployment" class="hash-link" aria-label="Direct link to Step 7.2 - Run deployment" title="Direct link to Step 7.2 - Run deployment">​</a></h3>
<p>We will run first deployment from local machine to create S3 bucket for storing Terraform state. In other words this deployment will create resources needed for storing Terraform state in the cloud and runnign deployment from GitHub actions.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">terraform init</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now run deployement:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">terraform apply -auto-approve</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>👆 Please note that this command might block ask you your <code>sudo</code> password to append <code>appserver.local</code> to <code>/etc/hosts</code> file.</p>
</blockquote>
<blockquote>
<p>👆 Please note that command might show errors about pushing images, this is fine because current deployment is done here only to setup S3 bucket for state migration before migrating to cloud.</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-8---migrate-state-to-the-cloud">Step 8 - Migrate state to the cloud<a href="#step-8---migrate-state-to-the-cloud" class="hash-link" aria-label="Direct link to Step 8 - Migrate state to the cloud" title="Direct link to Step 8 - Migrate state to the cloud">​</a></h2>
<p>First deployment had to create S3 bucket for storing Terraform state. Now we need to migrate the state to the cloud.</p>
<p>Add to the end of <code>main.tf</code>:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">main.tf</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"># Configure the backend to use the S3 bucket</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">terraform {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"> backend &quot;s3&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">   bucket         = &quot;&lt;your_app_name&gt;-terraform-state&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">   key            = &quot;state.tfstate&quot;  # Define a specific path for the state file</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">   region         = &quot;us-east-1&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">   profile        = &quot;myaws&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">   use_lockfile   = true</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"> }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>👆 Replace <code>&lt;your_app_name&gt;</code> with your app name (no spaces, only underscores or letters).
Unfortunately we can&#x27;t use variables, HashiCorp thinks it is too dangerous 😥</p>
</blockquote>
<p>Now run:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">terraform init -migrate-state</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now run test deployment:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">terraform apply -auto-approve</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now you can delete local <code>terraform.tfstate</code> file and <code>terraform.tfstate.backup</code> file as they are in the cloud now.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-9---cicd---github-actions">Step 9 - CI/CD - Github Actions<a href="#step-9---cicd---github-actions" class="hash-link" aria-label="Direct link to Step 9 - CI/CD - Github Actions" title="Direct link to Step 9 - CI/CD - Github Actions">​</a></h2>
<p>Create file <code>.github/workflows/deploy.yml</code>:</p>
<div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">.github/workflows/deploy.yml</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token key atrule">name</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> Deploy myadmin</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token key atrule">run-name</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> github.actor </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> builds myadmin 🚀</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token key atrule">on</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain">push</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token key atrule">jobs</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token key atrule">Explore-GitHub-Actions</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">runs-on</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">concurrency</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token key atrule">group</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> build</span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain">group</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token key atrule">cancel-in-progress</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#ae81ff">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token key atrule">run</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> echo &quot;🎉 The job was automatically triggered by a $</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> github.event_name </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> event.&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token key atrule">run</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> echo &quot;🐧 This job is now running on a $</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> runner.os </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> server&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token key atrule">run</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> echo &quot;🔎 The name of your branch is $</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> github.ref </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain">&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> Check out repository code</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> actions/checkout@v4</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> Set up Terraform</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> hashicorp/setup</span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain">terraform@v2</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token key atrule">with</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token key atrule">terraform_version</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> 1.10.1 </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> Import Registry CA</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token key atrule">run</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">|</span><span class="token scalar string" style="color:#a6e22e"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          mkdir -p deploy/.keys</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          echo &quot;$VAULT_REGISTRY_CA_PEM&quot; &gt; deploy/.keys/ca.pem</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          echo &quot;$VAULT_REGISTRY_CA_KEY&quot; &gt; deploy/.keys/ca.key</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token key atrule">env</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token key atrule">VAULT_REGISTRY_CA_PEM</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> secrets.VAULT_REGISTRY_CA_PEM </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token key atrule">VAULT_REGISTRY_CA_KEY</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> secrets.VAULT_REGISTRY_CA_KEY </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> Set up Docker Buildx</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> docker/setup</span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain">buildx</span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain">action@v3</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token key atrule">with</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token key atrule">buildkitd-config-inline</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">|</span><span class="token scalar string" style="color:#a6e22e"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">            [registry.&quot;appserver.local:5000&quot;]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">              ca=[&quot;deploy/.keys/ca.pem&quot;]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">              </span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token comment" style="color:#8292a2;font-style:italic"># use host network for resolving appserver.local</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token key atrule">driver-opts</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> network=host</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> Import registry SSH keys</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token key atrule">run</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">|</span><span class="token scalar string" style="color:#a6e22e"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          mkdir -p deploy/.keys</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          echo &quot;$VAULT_SSH_PRIVATE_KEY&quot; &gt; deploy/.keys/id_rsa</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          echo &quot;$VAULT_SSH_PUBLIC_KEY&quot; &gt; deploy/.keys/id_rsa.pub</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          chmod 600 deploy/.keys/id_rsa*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token key atrule">env</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token key atrule">VAULT_SSH_PRIVATE_KEY</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> secrets.VAULT_SSH_PRIVATE_KEY </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token key atrule">VAULT_SSH_PUBLIC_KEY</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> secrets.VAULT_SSH_PUBLIC_KEY </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> Setup AWS credentials</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token key atrule">run</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">|</span><span class="token scalar string" style="color:#a6e22e"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          mkdir -p ~/.aws</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          cat &lt;&lt;EOL &gt; ~/.aws/credentials</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          [myaws]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          aws_access_key_id=${VAULT_AWS_ACCESS_KEY_ID}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          aws_secret_access_key=${VAULT_AWS_SECRET_ACCESS_KEY}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          EOL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token key atrule">env</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token key atrule">VAULT_AWS_ACCESS_KEY_ID</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> secrets.VAULT_AWS_ACCESS_KEY_ID </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token key atrule">VAULT_AWS_SECRET_ACCESS_KEY</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> secrets.VAULT_AWS_SECRET_ACCESS_KEY </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> Prepare env</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token key atrule">run</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">|</span><span class="token scalar string" style="color:#a6e22e"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          echo &quot;ADMINFORTH_SECRET=$VAULT_ADMINFORTH_SECRET&quot; &gt; deploy/.env.secrets.prod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token key atrule">env</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token key atrule">VAULT_ADMINFORTH_SECRET</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> secrets.VAULT_ADMINFORTH_SECRET </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> Terraform build</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token key atrule">run</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">|</span><span class="token scalar string" style="color:#a6e22e"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          cd deploy</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          terraform init -reconfigure</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          # example of unlocking tf state if needed</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          # terraform force-unlock fb397548-8697-ea93-ab80-128a4f508fdf --force</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          terraform plan -out=tfplan </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          terraform apply tfplan </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">                </span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token key atrule">run</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> echo &quot;🍏 This job&#x27;s status is $</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> job.status </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain">.&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-81---add-secrets-to-github">Step 8.1 - Add secrets to GitHub<a href="#step-81---add-secrets-to-github" class="hash-link" aria-label="Direct link to Step 8.1 - Add secrets to GitHub" title="Direct link to Step 8.1 - Add secrets to GitHub">​</a></h3>
<p>Go to your GitHub repository, then <code>Settings</code> -&gt; <code>Secrets</code> -&gt; <code>New repository secret</code> and add:</p>
<ul>
<li><code>VAULT_AWS_ACCESS_KEY_ID</code> - your AWS access key</li>
<li><code>VAULT_AWS_SECRET_ACCESS_KEY</code> - your AWS secret key</li>
<li><code>VAULT_SSH_PRIVATE_KEY</code> - execute <code>cat ~/.ssh/id_rsa</code> and paste to GitHub secrets</li>
<li><code>VAULT_SSH_PUBLIC_KEY</code> - execute <code>cat ~/.ssh/id_rsa.pub</code> and paste to GitHub secrets</li>
<li><code>VAULT_REGISTRY_CA_PEM</code> - execute <code>cat deploy/.keys/ca.pem</code> and paste to GitHub secrets</li>
<li><code>VAULT_REGISTRY_CA_KEY</code> - execute <code>cat deploy/.keys/ca.key</code> and paste to GitHub secrets</li>
<li><code>VAULT_ADMINFORTH_SECRET</code> - generate some random string and paste to GitHub secrets, e.g. <code>openssl rand -base64 32 | tr -d &#x27;\n&#x27;</code></li>
</ul>
<p>Now you can push your changes to GitHub and see how it will be deployed automatically.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="adding-secrets">Adding secrets<a href="#adding-secrets" class="hash-link" aria-label="Direct link to Adding secrets" title="Direct link to Adding secrets">​</a></h3>
<p>Once you will have sensitive tokens/passwords in your apps you have to store them in a secure way.</p>
<p>Simplest way is to use GitHub secrets.</p>
<p>Let&#x27;s imagine you have <code>OPENAI_API_KEY</code> which will be used one of AI-powered plugins of adminforth. We can&#x27;t put this key to the code, so we have to store it in GitHub secrets.</p>
<p>Open your GitHub repository, then <code>Settings</code> -&gt; <code>Secrets</code> -&gt; <code>New repository secret</code> and add <code>VAULT_OPENAI_API_KEY</code> with your key.</p>
<p>Now open GitHub actions file and add it to the <code>env</code> section:</p>
<div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">.github/workflows/deploy.yml</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> Prepare env</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token key atrule">run</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">|</span><span class="token scalar string" style="color:#a6e22e"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          echo &quot;ADMINFORTH_SECRET=$VAULT_ADMINFORTH_SECRET&quot; &gt; deploy/.env.secrets.prod</span><br></span><span class="token-line code-block-diff-add-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          echo &quot;OPENAI_API_KEY=$VAULT_OPENAI_API_KEY&quot; &gt;&gt; deploy/.env.secrets.prod</span><span class="token plain"></span><br></span><span class="token-line code-block-diff-add-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token key atrule">env</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token key atrule">VAULT_ADMINFORTH_SECRET</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> secrets.VAULT_ADMINFORTH_SECRET </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line code-block-diff-add-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token key atrule">VAULT_OPENAI_API_KEY</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> secrets.VAULT_OPENAI_API_KEY </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In the same way you can add any other secrets to your GitHub actions.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="want-to-run-builds-from-your-local-machine">Want to run builds from your local machine?<a href="#want-to-run-builds-from-your-local-machine" class="hash-link" aria-label="Direct link to Want to run builds from your local machine?" title="Direct link to Want to run builds from your local machine?">​</a></h3>
<p>This guide originally was created to run full builds from GitHub actions only, so out of the box it will fail to push images to registry from your local machine.</p>
<p>But for debug purporses you can run it from your local machine too with some addition steps.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-you-need-to-make-local-docker-buildx-builder-to-trust-self-signed-tls-certificate">1. You need to make local Docker buildx builder to trust self-signed TLS certificate<a href="#1-you-need-to-make-local-docker-buildx-builder-to-trust-self-signed-tls-certificate" class="hash-link" aria-label="Direct link to 1. You need to make local Docker buildx builder to trust self-signed TLS certificate" title="Direct link to 1. You need to make local Docker buildx builder to trust self-signed TLS certificate">​</a></h4>
<p>Create folder <code>deploy/.local</code> and create next files:</p>
<div class="language-toml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-toml codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">[registry.&quot;appserver.local:5000&quot;]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  insecure = false</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  ca = [&quot;../.keys/ca.pem&quot;]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token builtin class-name" style="color:#e6db74">cd</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;</span><span class="token string variable" style="color:#f8f8f2">$(</span><span class="token string variable function" style="color:#e6db74">dirname</span><span class="token string variable" style="color:#f8f8f2"> </span><span class="token string variable string" style="color:#a6e22e">&quot;</span><span class="token string variable string variable" style="color:#f8f8f2">$0</span><span class="token string variable string" style="color:#a6e22e">&quot;</span><span class="token string variable" style="color:#f8f8f2">)</span><span class="token string" style="color:#a6e22e">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token function" style="color:#e6db74">docker</span><span class="token plain"> buildx </span><span class="token function" style="color:#e6db74">rm</span><span class="token plain"> mybuilder </span><span class="token operator" style="color:#66d9ef">||</span><span class="token plain"> </span><span class="token boolean" style="color:#ae81ff">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token function" style="color:#e6db74">docker</span><span class="token plain"> buildx create </span><span class="token parameter variable" style="color:#f8f8f2">--name</span><span class="token plain"> mybuilder </span><span class="token parameter variable" style="color:#f8f8f2">--driver</span><span class="token plain"> docker-container   </span><span class="token parameter variable" style="color:#f8f8f2">--use</span><span class="token plain"> </span><span class="token parameter variable" style="color:#f8f8f2">--config</span><span class="token plain"> ./buildkitd.toml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now create builder:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token function" style="color:#e6db74">bash</span><span class="token plain"> .local/create-builder.sh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-you-need-to-deliver-same-secrets-from-local-machine-as-from-ci-vault">2. You need to deliver same secrets from local machine as from CI vault<a href="#2-you-need-to-deliver-same-secrets-from-local-machine-as-from-ci-vault" class="hash-link" aria-label="Direct link to 2. You need to deliver same secrets from local machine as from CI vault" title="Direct link to 2. You need to deliver same secrets from local machine as from CI vault">​</a></h4>
<p>Create file <code>deploy/.env.secrets.prod</code> with next content:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token assign-left variable" style="color:#f8f8f2">ADMINFORTH_SECRET</span><span class="token operator" style="color:#66d9ef">=</span><span class="token operator" style="color:#66d9ef">&lt;</span><span class="token plain">your secret</span><span class="token operator" style="color:#66d9ef">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Please note that if you are running builds both from GA and local, the <code>ADMINFORTH_SECRET</code> should much to GA secret. Otherwise all existing users will be logged out.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-you-need-to-add-appserverlocal-to-your-hosts-file-windowswsl-only">2. You need to add app.server.local to your hosts file (Windows/WSL only)<a href="#2-you-need-to-add-appserverlocal-to-your-hosts-file-windowswsl-only" class="hash-link" aria-label="Direct link to 2. You need to add app.server.local to your hosts file (Windows/WSL only)" title="Direct link to 2. You need to add app.server.local to your hosts file (Windows/WSL only)">​</a></h4>
<blockquote>
<p>This step is not needed on Linux / Mac because teraform provisioner will autiomatically add it to <code>/etc/hosts</code> file.
However in WSL we can&#x27;t modify Windows native hosts file, so we need to do it manually.</p>
</blockquote>
<p>In power shell run</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">Start-Process notepad &quot;C:\Windows\System32\drivers\etc\hosts&quot; -Verb runAs</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Check your public IP in Terraform output and add</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">&lt;your public ip&gt; appserver.local</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>Bad news is that instance public IP will be known only after first run, so some steps would fail because there will be no hosts mapping. However since EC2 provisioning takes some time it is even possible to copy IP from terminal and inser it to hosts file from first run 🤪</p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-using-local-build-from-multiple-projects">3. Using local build from multiple projects<a href="#3-using-local-build-from-multiple-projects" class="hash-link" aria-label="Direct link to 3. Using local build from multiple projects" title="Direct link to 3. Using local build from multiple projects">​</a></h4>
<p>The easiest way would be probably to rename <code>appserver.local</code> to unique name for each project.</p>
<p>Then you can put all certificate mappings to a <code>buildkitd.toml</code> and move it along with <code>create-builder.sh</code> script to a common folder, e.g. home</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a title="Amazon Web Services (AWS) is a cloud computing platform that provides a wide range of services for building and deploying applications." class="tag_zVej tagRegular_sFm0" href="/blog/tags/aws/">AWS</a></li><li class="tag_QGVx"><a title="Terraform is an open-source infrastructure as code software tool created by HashiCorp that enables users to define and provision data center infrastructure using a declarative configuration language." class="tag_zVej tagRegular_sFm0" href="/blog/tags/terraform/">Terraform</a></li><li class="tag_QGVx"><a title="GitHub Actions is a continuous integration and continuous deployment (CI/CD) service provided by GitHub that allows you to automate your software development workflows." class="tag_zVej tagRegular_sFm0" href="/blog/tags/github-actions/">GitHub Actions</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/compose-aws-ec2-ecr-terraform-github-actions/"><div class="pagination-nav__sublabel">Newer post</div><div class="pagination-nav__label">IaaC Simplified: Amazon EC2 Deployments with GitHub Actions, Terraform, Docker &amp; Amazon ECR</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/how-i-opensourced-my-secret-tokens/"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">How I Open-Sourced My Secret Access Tokens from GitHub, Slack, and NPM — and Who Actually Cares</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#costs-for-amazon-ecr-vs-consts-for-self-hosted-registry-on-ec2" class="table-of-contents__link toc-highlight">Costs for Amazon ECR vs consts for self-hosted registry on EC2</a></li><li><a href="#step-1---dockerfile-and-dockerignore" class="table-of-contents__link toc-highlight">Step 1 - Dockerfile and .dockerignore</a></li><li><a href="#step-2---composeyml" class="table-of-contents__link toc-highlight">Step 2 - compose.yml</a></li><li><a href="#step-3---create-a-ssh-keypair" class="table-of-contents__link toc-highlight">Step 3 - create a SSH keypair</a></li><li><a href="#step-4---create-tls-certificates-to-encrypt-traffic-between-ci-and-registry" class="table-of-contents__link toc-highlight">Step 4 - create TLS certificates to encrypt traffic between CI and registry</a></li><li><a href="#step-5---gitignore-file" class="table-of-contents__link toc-highlight">Step 5 - .gitignore file</a></li><li><a href="#step-6---file-with-secrets-for-local-deploy" class="table-of-contents__link toc-highlight">Step 6 - file with secrets for local deploy</a></li><li><a href="#step-7---main-terraform-file-maintf" class="table-of-contents__link toc-highlight">Step 7 - main terraform file main.tf</a><ul><li><a href="#step-71---configure-aws-profile" class="table-of-contents__link toc-highlight">Step 7.1 - Configure AWS Profile</a></li><li><a href="#step-72---run-deployment" class="table-of-contents__link toc-highlight">Step 7.2 - Run deployment</a></li></ul></li><li><a href="#step-8---migrate-state-to-the-cloud" class="table-of-contents__link toc-highlight">Step 8 - Migrate state to the cloud</a></li><li><a href="#step-9---cicd---github-actions" class="table-of-contents__link toc-highlight">Step 9 - CI/CD - Github Actions</a><ul><li><a href="#step-81---add-secrets-to-github" class="table-of-contents__link toc-highlight">Step 8.1 - Add secrets to GitHub</a></li><li><a href="#adding-secrets" class="table-of-contents__link toc-highlight">Adding secrets</a></li><li><a href="#want-to-run-builds-from-your-local-machine" class="table-of-contents__link toc-highlight">Want to run builds from your local machine?</a></li></ul></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/tutorial/gettingStarted/">Tutorial</a></li><li class="footer__item"><a href="https://demo.adminforth.dev/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Live Demo</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/api/">API</a></li><li class="footer__item"><a class="footer__link-item" href="/blog/archive/">Blog Archive</a></li><li class="footer__item"><a class="footer__link-item" href="/search/">Find anything</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://devforth.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">DevForth.io<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://devforth.io/contact" target="_blank" rel="noopener noreferrer" class="footer__link-item">We can develop admin panel for your project<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/devforth/adminforth" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2026 Devforth sp. z o.o.</div></div></div></footer></div>
</body>
</html>