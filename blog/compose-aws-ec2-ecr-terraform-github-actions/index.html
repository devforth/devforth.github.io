<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">IaaC Simplified: Amazon EC2 Deployments with GitHub Actions, Terraform, Docker &amp; Amazon ECR | Vue &amp; Node admin panel framework</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://adminforth.dev/blog/compose-aws-ec2-ecr-terraform-github-actions/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="IaaC Simplified: Amazon EC2 Deployments with GitHub Actions, Terraform, Docker &amp; Amazon ECR | Vue &amp; Node admin panel framework"><meta data-rh="true" name="description" content="The ultimate step-by-step guide to cost-effective, build-time-efficient, and easy managable EC2 deployments using GitHub Actions, Terraform, Docker, and a Amazon ECR registry."><meta data-rh="true" property="og:description" content="The ultimate step-by-step guide to cost-effective, build-time-efficient, and easy managable EC2 deployments using GitHub Actions, Terraform, Docker, and a Amazon ECR registry."><meta data-rh="true" property="og:image" content="https://adminforth.dev/ogs/ga-tf-ecr.jpg"><meta data-rh="true" name="twitter:image" content="https://adminforth.dev/ogs/ga-tf-ecr.jpg"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2025-02-19T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/ivictbor"><meta data-rh="true" property="article:tag" content="AWS,Terraform,GitHub Actions"><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://adminforth.dev/blog/compose-aws-ec2-ecr-terraform-github-actions/"><link data-rh="true" rel="alternate" href="https://adminforth.dev/blog/compose-aws-ec2-ecr-terraform-github-actions/" hreflang="en"><link data-rh="true" rel="alternate" href="https://adminforth.dev/blog/compose-aws-ec2-ecr-terraform-github-actions/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://VSIPOF54AV-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://adminforth.dev/blog/compose-aws-ec2-ecr-terraform-github-actions","mainEntityOfPage":"https://adminforth.dev/blog/compose-aws-ec2-ecr-terraform-github-actions","url":"https://adminforth.dev/blog/compose-aws-ec2-ecr-terraform-github-actions","headline":"IaaC Simplified: Amazon EC2 Deployments with GitHub Actions, Terraform, Docker & Amazon ECR","name":"IaaC Simplified: Amazon EC2 Deployments with GitHub Actions, Terraform, Docker & Amazon ECR","description":"The ultimate step-by-step guide to cost-effective, build-time-efficient, and easy managable EC2 deployments using GitHub Actions, Terraform, Docker, and a Amazon ECR registry.","datePublished":"2025-02-19T00:00:00.000Z","author":{"@type":"Person","name":"Ivan Borshchov","description":"Maintainer of AdminForth","url":"https://github.com/ivictbor","image":"https://avatars.githubusercontent.com/u/1838656?v=4"},"image":{"@type":"ImageObject","@id":"https://adminforth.dev/ogs/ga-tf-ecr.jpg","url":"https://adminforth.dev/ogs/ga-tf-ecr.jpg","contentUrl":"https://adminforth.dev/ogs/ga-tf-ecr.jpg","caption":"title image for the blog post: IaaC Simplified: Amazon EC2 Deployments with GitHub Actions, Terraform, Docker & Amazon ECR"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://adminforth.dev/blog","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Vue &amp; Node admin panel framework RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Vue &amp; Node admin panel framework Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-7K99Q2BH04"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-7K99Q2BH04",{anonymize_ip:!0})</script>



<link rel="search" type="application/opensearchdescription+xml" title="Vue &amp; Node admin panel framework" href="/opensearch.xml">

<script src="/scripts/adminforth.js"></script><link rel="stylesheet" href="/assets/css/styles.ba19fe4b.css">
<script src="/assets/js/runtime~main.9a574c7c.js" defer="defer"></script>
<script src="/assets/js/main.0e8729bd.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="AdminForth Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="AdminForth Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">AdminForth</b></a><a class="navbar__item navbar__link" href="/docs/tutorial/gettingStarted/">Tutorial</a><a class="navbar__item navbar__link" href="/docs/api/">API</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog/">Blog</a></div><div class="navbar__items navbar__items--right"><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div><a href="https://demo.adminforth.dev/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Live Demo<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/devforth/adminforth" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2025</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/dynamic-strings-translation/">How to translate dynamic strings in AdminForth API</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/keycloak-setup-example/">Setup AdminForth Authorization via Keycloak</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/compose-aws-ec2-ecr-terraform-github-actions/">IaaC Simplified: Amazon EC2 Deployments with GitHub Actions, Terraform, Docker &amp; Amazon ECR</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/compose-ec2-deployment-github-actions-registry/">Amazon EC2 Deployments with GitHub Actions, Terraform, Docker &amp; Self-hosted Registry</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/how-i-opensourced-my-secret-tokens/">How I Open-Sourced My Secret Access Tokens from GitHub, Slack, and NPM — and Who Actually Cares</a></li></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class="title_f1Hy">IaaC Simplified: Amazon EC2 Deployments with GitHub Actions, Terraform, Docker &amp; Amazon ECR</h1><div class="container_mt6G margin-vert--md"><time datetime="2025-02-19T00:00:00.000Z">February 19, 2025</time> · <!-- -->21 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/ivictbor" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://avatars.githubusercontent.com/u/1838656?v=4" alt="Ivan Borshchov"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/ivictbor" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">Ivan Borshchov</span></a></div><small class="authorTitle_nd0D" title="Maintainer of AdminForth">Maintainer of AdminForth</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p><img decoding="async" loading="lazy" alt="alt text" src="/assets/images/ga-tf-ecr-87ced7681bcc3685f507cc9252bc0ffe.jpg" width="1200" height="630" class="img_ev3q"></p>
<p>This guide shows how to deploy own Docker apps (with AdminForth as example) to Amazon EC2 instance with Docker and Terraform involving pushing images into Amazon ECR.</p>
<p>Needed resources:</p>
<ul>
<li>GitHub actions Free plan which includes 2000 minutes per month (1000 of 2-minute builds per month - more then enough for many projects, if you are not running tests). Extra builds would cost <code>0.008$</code> per minute.</li>
<li>AWS account where we will auto-spawn EC2 instance. We will use <code>t3a.small</code> instance (2 vCPUs, 2GB RAM) which costs <code>~14$</code> per month in <code>us-east-1</code> region (cheapest region). Also it will take <code>$2</code> per month for EBS gp2 storage (20GB) for EC2 instance.</li>
<li>Also AWS ECR will charge for <code>$0.09</code> per GB of data egress traffic (from EC2 to the internet) - this needed to load docker build cache.</li>
</ul>
<p>The setup shape:</p>
<ul>
<li>Build is done using IaaC approach with HashiCorp Terraform, so almoast no manual actions are needed from you. Every resource including EC2 server instance is described in code which is commited to repo.</li>
<li>Docker build process is done on GitHub actions server, so EC2 server is not overloaded with builds</li>
<li>Changes in infrastructure including changing server type, adding S3 Bucket, changing size of sever disk is also can be done by commiting code to repo.</li>
<li>Docker images and build cache are stored on Amazon ECR</li>
<li>Total build time for average commit to AdminForth app (with Vite rebuilds) is around 2 minutes.</li>
</ul>
<p>Previously we had a blog post about <a href="/blog/compose-ec2-deployment-github-actions/">deploying AdminForth to EC2 with Terraform without registry</a>. That method might work well but has a significant disadvantage - build process happens on EC2 itself and uses EC2 RAM and CPU. This can be a problem if your EC2 instance is well-loaded without extra free resources. Moreover, low-end EC2 instances have a small amount of RAM and CPU, so build process which involves vite/tsc/etc can be slow or even fail / cause OOM killer to crash EC2 instance.</p>
<p>So obviously to solve this problem we need to move the build process to CI, however it introduces new chellenges and we will solve them in this post.</p>
<p>Quick difference between approaches from previous post and current post:</p>
<table><thead><tr><th>Feature</th><th>Without Registry</th><th>With ECR Registry</th></tr></thead><tbody><tr><td>How build happens</td><td>Source code is rsync-ed from CI to EC2 and docker build is done there</td><td>Docker build is done on CI and docker image is pushed to registry, then Docker on EC2 pulls from registry</td></tr><tr><td>Where build is done</td><td>On EC2</td><td>On CI</td></tr><tr><td>How Docker build layers are cached</td><td>Cache is stored on EC2</td><td>GitHub actions has no own Docker cache out of the box, so it should be stored in dedicated place (we use Amazon ECR)</td></tr><tr><td>Advantages</td><td>Cheaper (no egrass cache traffik from EC2) and faster</td><td>Build is done on CI, so EC2 server is not overloaded</td></tr><tr><td>Disadvantages</td><td>Build on EC2 requires additional server RAM / requires swap / overloads CPU</td><td>More terraform code is needed. Extra cost for egress traffik to GitHub for cache transfer</td></tr><tr><td>Initial build time*</td><td>3m 13.541s</td><td>3m 54s</td></tr><tr><td>Rebuild time (changed <code>index.ts</code>)*</td><td>0m 51.653s</td><td>0m 54.120s</td></tr></tbody></table>
<sub>* All tests done from local machine (Intel(R) Core(TM) Ultra 9 185H, Docker Desktop/WSL2 64 GB RAM, 300Mbps up/down) up to working state</sub>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="chellenges-when-you-build-on-ci">Chellenges when you build on CI<a href="#chellenges-when-you-build-on-ci" class="hash-link" aria-label="Direct link to Chellenges when you build on CI" title="Direct link to Chellenges when you build on CI">​</a></h2>
<p>A little bit of theory.</p>
<p>When you move build process to CI you have to solve next chellenges:</p>
<ol>
<li>We need to deliver built docker images to EC2 somehow (and only we)</li>
<li>We need to persist cache between builds</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="delivering-images">Delivering images<a href="#delivering-images" class="hash-link" aria-label="Direct link to Delivering images" title="Direct link to Delivering images">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="exporing-images-to-tar-files">Exporing images to tar files<a href="#exporing-images-to-tar-files" class="hash-link" aria-label="Direct link to Exporing images to tar files" title="Direct link to Exporing images to tar files">​</a></h4>
<p>Simplest option which you can find is save docker images to tar files and deliver them to EC2. We can easily do it in terraform (using <code>docker save -o ...</code> command on CI and <code>docker load ...</code> command on EC2). However this option has a significant disadvantage - it is slow. Docker images are big (always include all layers, without any options), so it takes infinity to do save/load and another infinity to transfer them to EC2 (via relatively slow rsync/SSH and relatively slow GitHub actions outbound connection).</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="docker-registry">Docker registry<a href="#docker-registry" class="hash-link" aria-label="Direct link to Docker registry" title="Direct link to Docker registry">​</a></h4>
<p>Faster, right option which we will use here - involve Docker registry. Registry is a repository which stores docker images. It does it in a smart way - it saves each image as several layers, so if you will update last layer, then only last layer will be pushed to registry and then only last will be pulled to EC2.
To give you row compare - whole-layers image might take <code>1GB</code>, but last layer created by <code>npm run build</code> command might take <code>50MB</code>. And most builds you will do only last layer changes, so it will be 20 times faster to push/pull last layer than whole image.
And this is not all, registry uses TLS HTTP protocol so it is faster then SSH/rsync encrypted connection.</p>
<p>Of course you have to care about a way of registry authentication (so only you and your CI/EC2 can push/pull images).</p>
<p>What docker registry can you use? Pretty known options:</p>
<ol>
<li>Docker Hub - most famous. It is free for public images, so literally every opensource project uses it. However it is not free for private images, and you have to pay for it. Payment model is pretty strange - you pay for user who can login, like 11$ per month, you might pay for your devops only but all this sounds strange.</li>
<li>GHCR - Registry from GitHub. Has free plan but allows to store only 500MB and allows to transfer 1GB of traffic per month. Then you pay for every extra GB in storage (<code>$0.0008</code> per GB/day or <code>$0.24</code> per GB/month) and for every extra GB in traffic ($0.09 per GB). Probably small images will fit in free plan, but generally even alpine-based docker images are bigger than 500MB, so it is non-free option.</li>
<li>Amazon ECR - Same as GHCR but from Amazon. Price is <code>$0.10</code> per GB of storage per month and <code>$0.09</code> per GB of data transfer from Amazon (as all Amazon egress traffic). So it is cheaper than GHCR.</li>
<li>Self-hosted registry web system. In our software development company, we use Harbor. It is a powerful free open-source registry that can be installed to own server. It allows pushing and pulling without limit. Also, it has internal life-cycle rules that cleanup unnecessary images and layers. The main drawbacks of it are that it is not so fast to install and configure, plus you have to get a domain and another powerfull server to run it. So unless you are a software development company, it is not worth using it.</li>
<li>Self-hosted minimal CNCF Distribution <a href="https://distribution.github.io/distribution/" target="_blank" rel="noopener noreferrer">registry</a> on EC2 itself. So since we already have EC2, we can run registry on it directly. The <code>registry</code> container is pretty light-weight and it will not consume a lot of extra CPU/RAM on server. Plus images will be stored close to application so pull will be fast, however securing this right is a bit tricky. If you want to try it we have special <a href="/blog/compose-ec2-deployment-github-actions-registry/">EC2 with CNCF registry post</a>.</li>
</ol>
<p>In the post we will use Amazon ECR as registry (3rd way).</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="persisting-cache">Persisting cache<a href="#persisting-cache" class="hash-link" aria-label="Direct link to Persisting cache" title="Direct link to Persisting cache">​</a></h3>
<p>Docker builds without layer cache persistence are possible but very slow. Most builds only change a couple of layers, and having no ability to cache them will cause the Docker builder to regenerate all layers from scratch. This can, for example, increase the Docker build time from a minute to ten minutes or even more.</p>
<p>Out of the box, GitHub Actions can&#x27;t save Docker layers between builds, so you have to use external storage.</p>
<blockquote>
<p>Though some CI systems can persist docker build cache, e.g. open-source self-hosted Woodpecker CI allows it out of the box. However GitHub actions which is pretty popular, reasonably can&#x27;t allow such free storage to anyone</p>
</blockquote>
<p>So when build-in Docker cache can&#x27;t be used, there is one alternative - Docker BuildKit external cache.
So BuildKit allows you to connect external storage. There are several options, but most sweet for us is using Docker registry as cache storage (not only as images storage to deliver them to application server).</p>
<p>Drawback is that buildx which is running on GitHub action server will download cache from registry which is inside of AWS. And all AWS egress traffic is charged. So you will pay for every build which uses cache. However cache is comnpressed. To give you idea basic alpine image with AdminForth cache is 180MB. One one commercial project we did full release within 2 months and 400 builds so it took <code>400 * 180MB * $0.09 / GB = $6.48</code> for cache transfer for whole project.</p>
<blockquote>
<p><em>BuildKit cache in Compose issue</em>
Previously we used docker compose to build &amp; run our app, it can be used to both build, push and pull images, but has <a href="https://github.com/docker/compose/issues/11072#issuecomment-1848974315" target="_blank" rel="noopener noreferrer">issues with external cache connection</a>. While they are not solved we have to use <code>docker buildx bake</code> command to build images. It is not so bad, but is another point of configuration which we will cover in this post.</p>
</blockquote>
<h1>Prerequisites</h1>
<p>I will assume you run Ubuntu (Native or WSL2).</p>
<p>You should have terraform, here is official repository:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">wget -O - https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">echo &quot;deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main&quot; | sudo tee /etc/apt/sources.list.d/hashicorp.list</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">sudo apt update &amp;&amp; sudo apt install terraform</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>AWS CLI:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token function" style="color:#e6db74">sudo</span><span class="token plain"> snap </span><span class="token function" style="color:#e6db74">install</span><span class="token plain"> aws-cli </span><span class="token parameter variable" style="color:#f8f8f2">--classic</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Also you need Doker Daemon running. We recommend Docker Desktop running. ON WSL2 make sure you have Docker Desktop WSL2 integration enabled.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token function" style="color:#e6db74">docker</span><span class="token plain"> version</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h1>Practice - deploy setup</h1>
<p>Assume you have your AdminForth project in <code>myadmin</code>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-1---dockerfile-and-dockerignore">Step 1 - Dockerfile and .dockerignore<a href="#step-1---dockerfile-and-dockerignore" class="hash-link" aria-label="Direct link to Step 1 - Dockerfile and .dockerignore" title="Direct link to Step 1 - Dockerfile and .dockerignore">​</a></h2>
<p>This guide assumes you have created your AdminForth application with latest version of <code>adminforth create-app</code> command.
This command already creates a <code>Dockerfile</code> and <code>.dockerignore</code> for you, so you can use them as is.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-2---composeyml">Step 2 - compose.yml<a href="#step-2---composeyml" class="hash-link" aria-label="Direct link to Step 2 - compose.yml" title="Direct link to Step 2 - compose.yml">​</a></h2>
<p>create folder <code>deploy</code> and create file <code>compose.yml</code> inside:</p>
<div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">deploy/compose.yml</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token key atrule">services</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token key atrule">traefik</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;traefik:v2.5&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">command</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;--api.insecure=true&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;--providers.docker=true&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;--entrypoints.web.address=:80&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;80:80&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">volumes</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;/var/run/docker.sock:/var/run/docker.sock:ro&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token key atrule">myadmin</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain">MYADMIN_REPO</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">build</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token key atrule">context</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> ../adminforth</span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain">app</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token key atrule">tags</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> $</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain">MYADMIN_REPO</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token key atrule">cache_from</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> type=registry</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">ref=$</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain">MYADMIN_REPO</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain">cache</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token key atrule">cache_to</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> type=registry</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">ref=$</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain">MYADMIN_REPO</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain">cache</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">mode=max</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">compression=zstd</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">image</span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain">manifest=true</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">oci</span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain">mediatypes=true</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">pull_policy</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> always</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">restart</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> always</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">env_file</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> .env.secrets.prod</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">volumes</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> myadmin</span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain">db</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain">/code/db</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;traefik.enable=true&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;traefik.http.routers.myadmin.rule=PathPrefix(`/`)&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;traefik.http.services.myadmin.loadbalancer.server.port=3500&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;traefik.http.routers.myadmin.priority=2&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token key atrule">volumes</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  myadmin</span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain">db</span><span class="token punctuation" style="color:#f8f8f2">:</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-3---create-a-ssh-keypair">Step 3 - create a SSH keypair<a href="#step-3---create-a-ssh-keypair" class="hash-link" aria-label="Direct link to Step 3 - create a SSH keypair" title="Direct link to Step 3 - create a SSH keypair">​</a></h2>
<p>Make sure you are still in <code>deploy</code> folder, run next command:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">deploy</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token function" style="color:#e6db74">mkdir</span><span class="token plain"> .keys </span><span class="token operator" style="color:#66d9ef">&amp;&amp;</span><span class="token plain"> ssh-keygen </span><span class="token parameter variable" style="color:#f8f8f2">-f</span><span class="token plain"> .keys/id_rsa </span><span class="token parameter variable" style="color:#f8f8f2">-N</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now it should create <code>deploy/.keys/id_rsa</code> and <code>deploy/.keys/id_rsa.pub</code> files with your SSH keypair. Terraform script will put the public key to the EC2 instance and will use private key to connect to the instance. Also you will be able to use it to connect to the instance manually.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-4---create-tls-certificates-to-encrypt-traffic-between-ci-and-registry">Step 4 - create TLS certificates to encrypt traffic between CI and registry<a href="#step-4---create-tls-certificates-to-encrypt-traffic-between-ci-and-registry" class="hash-link" aria-label="Direct link to Step 4 - create TLS certificates to encrypt traffic between CI and registry" title="Direct link to Step 4 - create TLS certificates to encrypt traffic between CI and registry">​</a></h2>
<p>Make sure you are still in <code>deploy</code> folder, run next command:</p>
<p>Run next command to create TLS certificates:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">openssl req </span><span class="token parameter variable" style="color:#f8f8f2">-new</span><span class="token plain"> </span><span class="token parameter variable" style="color:#f8f8f2">-x509</span><span class="token plain"> </span><span class="token parameter variable" style="color:#f8f8f2">-days</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">3650</span><span class="token plain"> </span><span class="token parameter variable" style="color:#f8f8f2">-newkey</span><span class="token plain"> rsa:4096 </span><span class="token parameter variable" style="color:#f8f8f2">-nodes</span><span class="token plain"> </span><span class="token parameter variable" style="color:#f8f8f2">-keyout</span><span class="token plain"> .keys/ca.key </span><span class="token parameter variable" style="color:#f8f8f2">-subj</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;/CN=My Custom CA&quot;</span><span class="token plain"> </span><span class="token parameter variable" style="color:#f8f8f2">-out</span><span class="token plain"> .keys/ca.pem</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This will create <code>deploy/.keys/ca.key</code> and <code>deploy/.keys/ca.pem</code> files.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-5---gitignore-file">Step 5 - .gitignore file<a href="#step-5---gitignore-file" class="hash-link" aria-label="Direct link to Step 5 - .gitignore file" title="Direct link to Step 5 - .gitignore file">​</a></h2>
<p>Create <code>deploy/.gitignore</code> file with next content:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">.terraform/</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">.keys/</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">*.tfstate</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">*.tfstate.*</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">*.tfvars</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">tfplan</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">.env.secrets.prod</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-6---file-with-secrets-for-local-deploy">Step 6 - file with secrets for local deploy<a href="#step-6---file-with-secrets-for-local-deploy" class="hash-link" aria-label="Direct link to Step 6 - file with secrets for local deploy" title="Direct link to Step 6 - file with secrets for local deploy">​</a></h2>
<p>Create file <code>deploy/.env.secrets.prod</code></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token assign-left variable" style="color:#f8f8f2">ADMINFORTH_SECRET</span><span class="token operator" style="color:#66d9ef">=</span><span class="token operator" style="color:#66d9ef">&lt;</span><span class="token plain">your_secret</span><span class="token operator" style="color:#66d9ef">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-7---main-terraform-file-maintf">Step 7 - main terraform file main.tf<a href="#step-7---main-terraform-file-maintf" class="hash-link" aria-label="Direct link to Step 7 - main terraform file main.tf" title="Direct link to Step 7 - main terraform file main.tf">​</a></h2>
<p>First of all install Terraform as described here <a href="https://developer.hashicorp.com/terraform/install#linux" target="_blank" rel="noopener noreferrer">terraform installation</a>.</p>
<p>Create file <code>main.tf</code> in <code>deploy</code> folder:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">deploy/main.tf</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">locals {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  app_name = &quot;testtf&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  aws_region = &quot;us-east-1&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">provider &quot;aws&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  region = local.aws_region</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  profile = &quot;myaws&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">data &quot;aws_ami&quot; &quot;ubuntu_linux&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  most_recent = true</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  owners      = [&quot;amazon&quot;]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  filter {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    name   = &quot;name&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    values = [&quot;ubuntu/images/hvm-ssd-gp3/ubuntu-noble-24.04-amd64-server-*&quot;]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">data &quot;aws_vpc&quot; &quot;default&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  default = true</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">resource &quot;aws_eip&quot; &quot;eip&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"> domain = &quot;vpc&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">resource &quot;aws_eip_association&quot; &quot;eip_assoc&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"> instance_id   = aws_instance.app_instance.id</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"> allocation_id = aws_eip.eip.id</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">data &quot;aws_subnet&quot; &quot;default_subnet&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  filter {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    name   = &quot;vpc-id&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    values = [data.aws_vpc.default.id]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  filter {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    name   = &quot;default-for-az&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    values = [&quot;true&quot;]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  filter {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    name   = &quot;availability-zone&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    values = [&quot;${local.aws_region}a&quot;]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">resource &quot;aws_security_group&quot; &quot;instance_sg&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  name   = &quot;${local.app_name}-instance-sg&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  vpc_id = data.aws_vpc.default.id</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  ingress {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    description = &quot;Allow HTTP&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    from_port   = 80</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    to_port     = 80</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    protocol    = &quot;tcp&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    cidr_blocks = [&quot;0.0.0.0/0&quot;]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  ingress {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    description = &quot;Allow Docker registry&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    from_port   = 5000</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    to_port     = 5000</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    protocol    = &quot;tcp&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    cidr_blocks = [&quot;0.0.0.0/0&quot;]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  # SSH</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  ingress {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    description = &quot;Allow SSH&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    from_port   = 22</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    to_port     = 22</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    protocol    = &quot;tcp&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    cidr_blocks = [&quot;0.0.0.0/0&quot;]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  egress {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    description = &quot;Allow all outbound traffic&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    from_port   = 0</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    to_port     = 0</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    protocol    = &quot;-1&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    cidr_blocks = [&quot;0.0.0.0/0&quot;]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">resource &quot;aws_key_pair&quot; &quot;app_deployer&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  key_name   = &quot;terraform-deploy_${local.app_name}-key&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  public_key = file(&quot;./.keys/id_rsa.pub&quot;) # Path to your public SSH key</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">resource &quot;aws_instance&quot; &quot;app_instance&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  ami                    = data.aws_ami.ubuntu_linux.id</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  instance_type          = &quot;t3a.small&quot;  # just change it to another type if you need, check https://instances.vantage.sh/</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  subnet_id              = data.aws_subnet.default_subnet.id</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  vpc_security_group_ids = [aws_security_group.instance_sg.id]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  key_name               = aws_key_pair.app_deployer.key_name</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  iam_instance_profile = aws_iam_instance_profile.ec2_profile.name</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  # prevent accidental termination of ec2 instance and data loss</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  # if you will need to recreate the instance still (not sure why it can be?), you will need to remove this block manually by next command:</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  # &gt; terraform taint aws_instance.app_instance</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  lifecycle {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    prevent_destroy = true</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ignore_changes = [ami]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  root_block_device {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    volume_size = 20 // Size in GB for root partition</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    volume_type = &quot;gp2&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    # Even if the instance is terminated, the volume will not be deleted, delete it manually if needed</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    delete_on_termination = false</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  user_data = &lt;&lt;-EOF</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    #!/bin/bash</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    sudo apt-get update</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    sudo apt-get install ca-certificates curl python3 python3-pip -y</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    sudo install -m 0755 -d /etc/apt/keyrings</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    sudo chmod a+r /etc/apt/keyrings/docker.asc</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    # Add the repository to Apt sources:</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    echo \</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      &quot;deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      $(. /etc/os-release &amp;&amp; echo &quot;$VERSION_CODENAME&quot;) stable&quot; | \</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    sudo apt-get update</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin screen</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    systemctl start docker</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    systemctl enable docker</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    usermod -a -G docker ubuntu</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    sudo snap install aws-cli --classic</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    echo &quot;done&quot; &gt; /home/ubuntu/user_data_done</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  EOF</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  tags = {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    Name = &quot;${local.app_name}-instance&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">resource &quot;null_resource&quot; &quot;wait_for_user_data&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  provisioner &quot;remote-exec&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    inline = [</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      &quot;echo &#x27;Waiting for EC2 software install to finish...&#x27;&quot;,</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      &quot;while [ ! -f /home/ubuntu/user_data_done ]; do echo &#x27;...&#x27;; sleep 2; done&quot;,</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      &quot;echo &#x27;EC2 software install finished.&#x27;&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    connection {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      type        = &quot;ssh&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      user        = &quot;ubuntu&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      private_key = file(&quot;./.keys/id_rsa&quot;)</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      host        = aws_eip_association.eip_assoc.public_ip</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  depends_on = [aws_instance.app_instance]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">resource &quot;aws_ecr_repository&quot; &quot;myadmin_repo&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  name = &quot;${local.app_name}-myadmin&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  force_delete = true</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">resource &quot;aws_ecr_lifecycle_policy&quot; &quot;safe_cleanup&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  repository = aws_ecr_repository.myadmin_repo.name</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  policy = jsonencode({</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    rules = [</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        rulePriority = 1</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        description  = &quot;Delete untagged images older than 7 days&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        selection = {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          tagStatus     = &quot;untagged&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          countType     = &quot;sinceImagePushed&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          countUnit     = &quot;days&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          countNumber   = 7</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        action = {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          type = &quot;expire&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  })</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">resource &quot;local_file&quot; &quot;compose_env&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  content  = &quot;MYADMIN_REPO=${aws_ecr_repository.myadmin_repo.repository_url}&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  filename = &quot;${path.module}/.env.ecr&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">// allow ec2 instance to login to ECR too pull images</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">resource &quot;aws_iam_role&quot; &quot;ec2_role&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  name = &quot;${local.app_name}-ec2-role&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  assume_role_policy = jsonencode({</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    Version = &quot;2012-10-17&quot;,</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    Statement = [{</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      Effect = &quot;Allow&quot;,</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      Principal = {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        Service = &quot;ec2.amazonaws.com&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      Action = &quot;sts:AssumeRole&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    }]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  })</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">resource &quot;aws_iam_role_policy_attachment&quot; &quot;ecr_access&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  role       = aws_iam_role.ec2_role.name</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  policy_arn = &quot;arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryPowerUser&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">resource &quot;aws_iam_instance_profile&quot; &quot;ec2_profile&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  name = &quot;${local.app_name}-instance-profile&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  role = aws_iam_role.ec2_role.name</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">resource &quot;null_resource&quot; &quot;sync_files_and_run&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  provisioner &quot;local-exec&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    command = &lt;&lt;-EOF</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      aws ecr get-login-password --region ${local.aws_region} --profile myaws | docker login --username AWS --password-stdin ${aws_ecr_repository.myadmin_repo.repository_url}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      echo &quot;Running build&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      env $(cat .env.ecr | grep -v &quot;#&quot; | xargs) docker buildx bake --progress=plain --push --allow=fs.read=.. -f compose.yml</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      # if you will change host, pleasee add -o StrictHostKeyChecking=no</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      echo &quot;Copy files to the instance&quot; </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      rsync -t -avz --mkpath -e &quot;ssh -i ./.keys/id_rsa -o StrictHostKeyChecking=no&quot; \</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        --delete \</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        --exclude &#x27;.terraform&#x27; \</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        --exclude &#x27;.keys&#x27; \</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        --exclude &#x27;tfplan&#x27; \</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        . ubuntu@${aws_eip_association.eip_assoc.public_ip}:/home/ubuntu/app/deploy/</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      EOF</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  # Run docker compose after files have been copied</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  provisioner &quot;remote-exec&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    inline = [&lt;&lt;-EOF</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      aws ecr get-login-password --region ${local.aws_region} | docker login --username AWS --password-stdin ${aws_ecr_repository.myadmin_repo.repository_url}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      cd /home/ubuntu/app/deploy</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      echo &quot;Spinning up the app&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      docker compose --progress=plain -p app  --env-file .env.ecr -f compose.yml up -d --remove-orphans</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      # cleanup unused cache (run in background to not block terraform)</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      screen -dm docker system prune -f</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    EOF</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    connection {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      type        = &quot;ssh&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      user        = &quot;ubuntu&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      private_key = file(&quot;./.keys/id_rsa&quot;)</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      host        = aws_eip_association.eip_assoc.public_ip</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  # Ensure the resource is triggered every time based on timestamp or file hash</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  triggers = {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    always_run = timestamp()</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  depends_on = [aws_eip_association.eip_assoc, null_resource.wait_for_user_data]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">output &quot;instance_public_ip&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  value = aws_eip_association.eip_assoc.public_ip</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">######### META, tf state ##############</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"># S3 bucket for storing Terraform state</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">resource &quot;aws_s3_bucket&quot; &quot;terraform_state&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  bucket = &quot;${local.app_name}-terraform-state&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">resource &quot;aws_s3_bucket_lifecycle_configuration&quot; &quot;terraform_state&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  bucket = aws_s3_bucket.terraform_state.bucket</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  rule {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    status = &quot;Enabled&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    id = &quot;Keep only the latest version of the state file&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    filter {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      prefix = &quot;&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    noncurrent_version_expiration {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      noncurrent_days = 30</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">resource &quot;aws_s3_bucket_versioning&quot; &quot;terraform_state&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  bucket = aws_s3_bucket.terraform_state.bucket</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  versioning_configuration {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    status = &quot;Enabled&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">resource &quot;aws_s3_bucket_server_side_encryption_configuration&quot; &quot;terraform_state&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  bucket = aws_s3_bucket.terraform_state.bucket</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  rule {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    apply_server_side_encryption_by_default {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      sse_algorithm     = &quot;AES256&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>👆 Replace <code>&lt;your_app_name&gt;</code> with your app name (no spaces, only underscores or letters)</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-71---configure-aws-profile">Step 7.1 - Configure AWS Profile<a href="#step-71---configure-aws-profile" class="hash-link" aria-label="Direct link to Step 7.1 - Configure AWS Profile" title="Direct link to Step 7.1 - Configure AWS Profile">​</a></h3>
<p>Open or create file <code>~/.aws/credentials</code> and add (if not already there):</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">[myaws]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">aws_access_key_id = &lt;your_access_key&gt;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">aws_secret_access_key = &lt;your_secret_key&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-72---run-deployment">Step 7.2 - Run deployment<a href="#step-72---run-deployment" class="hash-link" aria-label="Direct link to Step 7.2 - Run deployment" title="Direct link to Step 7.2 - Run deployment">​</a></h3>
<p>We will run first deployment from local machine to create S3 bucket for storing Terraform state. In other words this deployment will create resources needed for storing Terraform state in the cloud and runnign deployment from GitHub actions.</p>
<p>In <code>deploy</code> folder run:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">terraform init</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now run deployement:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">terraform apply -auto-approve</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>👆 Please note that this command might block ask you your <code>sudo</code> password to append <code>appserver.local</code> to <code>/etc/hosts</code> file.</p>
</blockquote>
<blockquote>
<p>👆 Please note that command might show errors about pushing images, this is fine because current deployment is done here only to setup S3 bucket for state migration before migrating to cloud.</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-8---migrate-state-to-the-cloud">Step 8 - Migrate state to the cloud<a href="#step-8---migrate-state-to-the-cloud" class="hash-link" aria-label="Direct link to Step 8 - Migrate state to the cloud" title="Direct link to Step 8 - Migrate state to the cloud">​</a></h2>
<p>First deployment had to create S3 bucket for storing Terraform state. Now we need to migrate the state to the cloud.</p>
<p>Add to the end of <code>main.tf</code>:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">main.tf</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"># Configure the backend to use the S3 bucket</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">terraform {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"> backend &quot;s3&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">   bucket         = &quot;&lt;your_app_name&gt;-terraform-state&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">   key            = &quot;state.tfstate&quot;  # Define a specific path for the state file</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">   region         = &quot;us-east-1&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">   profile        = &quot;myaws&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">   use_lockfile   = true</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"> }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>👆 Replace <code>&lt;your_app_name&gt;</code> with your app name (no spaces, only underscores or letters).
Unfortunately we can&#x27;t use variables, HashiCorp thinks it is too dangerous 😥</p>
</blockquote>
<p>Now run:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">terraform init -migrate-state</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now run test deployment:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">terraform apply -auto-approve</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now you can delete local <code>terraform.tfstate</code> file and <code>terraform.tfstate.backup</code> file as they are in the cloud now.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-9---cicd---github-actions">Step 9 - CI/CD - Github Actions<a href="#step-9---cicd---github-actions" class="hash-link" aria-label="Direct link to Step 9 - CI/CD - Github Actions" title="Direct link to Step 9 - CI/CD - Github Actions">​</a></h2>
<p>Create file <code>.github/workflows/deploy.yml</code>:</p>
<div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">.github/workflows/deploy.yml</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token key atrule">name</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> Deploy myadmin</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token key atrule">run-name</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> github.actor </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> builds myadmin 🚀</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token key atrule">on</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain">push</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token key atrule">jobs</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token key atrule">Explore-GitHub-Actions</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">runs-on</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">concurrency</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token key atrule">group</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> build</span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain">group</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token key atrule">cancel-in-progress</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#ae81ff">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token key atrule">run</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> echo &quot;🎉 The job was automatically triggered by a $</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> github.event_name </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> event.&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token key atrule">run</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> echo &quot;🐧 This job is now running on a $</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> runner.os </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> server&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token key atrule">run</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> echo &quot;🔎 The name of your branch is $</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> github.ref </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain">&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> Check out repository code</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> actions/checkout@v4</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> Set up Terraform</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> hashicorp/setup</span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain">terraform@v2</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token key atrule">with</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token key atrule">terraform_version</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> 1.10.1 </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> Import Registry CA</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token key atrule">run</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">|</span><span class="token scalar string" style="color:#a6e22e"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          mkdir -p deploy/.keys</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          echo &quot;$VAULT_REGISTRY_CA_PEM&quot; &gt; deploy/.keys/ca.pem</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          echo &quot;$VAULT_REGISTRY_CA_KEY&quot; &gt; deploy/.keys/ca.key</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token key atrule">env</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token key atrule">VAULT_REGISTRY_CA_PEM</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> secrets.VAULT_REGISTRY_CA_PEM </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token key atrule">VAULT_REGISTRY_CA_KEY</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> secrets.VAULT_REGISTRY_CA_KEY </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> Set up Docker Buildx</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> docker/setup</span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain">buildx</span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain">action@v3</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> Import registry SSH keys</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token key atrule">run</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">|</span><span class="token scalar string" style="color:#a6e22e"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          mkdir -p deploy/.keys</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          echo &quot;$VAULT_SSH_PRIVATE_KEY&quot; &gt; deploy/.keys/id_rsa</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          echo &quot;$VAULT_SSH_PUBLIC_KEY&quot; &gt; deploy/.keys/id_rsa.pub</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          chmod 600 deploy/.keys/id_rsa*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token key atrule">env</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token key atrule">VAULT_SSH_PRIVATE_KEY</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> secrets.VAULT_SSH_PRIVATE_KEY </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token key atrule">VAULT_SSH_PUBLIC_KEY</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> secrets.VAULT_SSH_PUBLIC_KEY </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> Setup AWS credentials</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token key atrule">run</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">|</span><span class="token scalar string" style="color:#a6e22e"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          mkdir -p ~/.aws</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          cat &lt;&lt;EOL &gt; ~/.aws/credentials</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          [myaws]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          aws_access_key_id=${VAULT_AWS_ACCESS_KEY_ID}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          aws_secret_access_key=${VAULT_AWS_SECRET_ACCESS_KEY}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          EOL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token key atrule">env</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token key atrule">VAULT_AWS_ACCESS_KEY_ID</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> secrets.VAULT_AWS_ACCESS_KEY_ID </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token key atrule">VAULT_AWS_SECRET_ACCESS_KEY</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> secrets.VAULT_AWS_SECRET_ACCESS_KEY </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> Prepare env</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token key atrule">run</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">|</span><span class="token scalar string" style="color:#a6e22e"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          echo &quot;ADMINFORTH_SECRET=$VAULT_ADMINFORTH_SECRET&quot; &gt; deploy/.env.secrets.prod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token key atrule">env</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token key atrule">VAULT_ADMINFORTH_SECRET</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> secrets.VAULT_ADMINFORTH_SECRET </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> Terraform build</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token key atrule">run</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">|</span><span class="token scalar string" style="color:#a6e22e"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          cd deploy</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          terraform init -reconfigure</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          # example of unlocking tf state if needed</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          # terraform force-unlock fb397548-8697-ea93-ab80-128a4f508fdf --force</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          terraform plan -out=tfplan </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          terraform apply tfplan </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">                </span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token key atrule">run</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> echo &quot;🍏 This job&#x27;s status is $</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> job.status </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain">.&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-10---add-secrets-to-github">Step 10 - Add secrets to GitHub<a href="#step-10---add-secrets-to-github" class="hash-link" aria-label="Direct link to Step 10 - Add secrets to GitHub" title="Direct link to Step 10 - Add secrets to GitHub">​</a></h3>
<p>Go to your GitHub repository, then <code>Settings</code> -&gt; <code>Secrets</code> -&gt; <code>New repository secret</code> and add:</p>
<ul>
<li><code>VAULT_AWS_ACCESS_KEY_ID</code> - your AWS access key</li>
<li><code>VAULT_AWS_SECRET_ACCESS_KEY</code> - your AWS secret key</li>
<li><code>VAULT_SSH_PRIVATE_KEY</code> - execute <code>cat deploy/.keys/id_rsa</code> and paste to GitHub secrets</li>
<li><code>VAULT_SSH_PUBLIC_KEY</code> - execute <code>cat deploy/.keys/id_rsa.pub</code> and paste to GitHub secrets</li>
<li><code>VAULT_REGISTRY_CA_PEM</code> - execute <code>cat deploy/.keys/ca.pem</code> and paste to GitHub secrets</li>
<li><code>VAULT_REGISTRY_CA_KEY</code> - execute <code>cat deploy/.keys/ca.key</code> and paste to GitHub secrets</li>
<li><code>VAULT_ADMINFORTH_SECRET</code> - generate some random string and paste to GitHub secrets, e.g. <code>openssl rand -base64 32 | tr -d &#x27;\n&#x27;</code></li>
</ul>
<p>Now you can push your changes to GitHub and see how it will be deployed automatically.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="adding-secrets">Adding secrets<a href="#adding-secrets" class="hash-link" aria-label="Direct link to Adding secrets" title="Direct link to Adding secrets">​</a></h3>
<p>Once you will have sensitive tokens/passwords in your apps you have to store them in a secure way.</p>
<p>Simplest way is to use GitHub secrets.</p>
<p>Let&#x27;s imagine you have <code>OPENAI_API_KEY</code> which will be used one of AI-powered plugins of adminforth. We can&#x27;t put this key to the code, so we have to store it in GitHub secrets.</p>
<p>Open your GitHub repository, then <code>Settings</code> -&gt; <code>Secrets</code> -&gt; <code>New repository secret</code> and add <code>VAULT_OPENAI_API_KEY</code> with your key.</p>
<p>Now open GitHub actions file and add it to the <code>env</code> section:</p>
<div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">.github/workflows/deploy.yml</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> Prepare env</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token key atrule">run</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">|</span><span class="token scalar string" style="color:#a6e22e"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          echo &quot;ADMINFORTH_SECRET=$VAULT_ADMINFORTH_SECRET&quot; &gt; deploy/.env.secrets.prod</span><br></span><span class="token-line code-block-diff-add-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          echo &quot;OPENAI_API_KEY=$VAULT_OPENAI_API_KEY&quot; &gt;&gt; deploy/.env.secrets.prod</span><span class="token plain"></span><br></span><span class="token-line code-block-diff-add-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token key atrule">env</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token key atrule">VAULT_ADMINFORTH_SECRET</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> secrets.VAULT_ADMINFORTH_SECRET </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line code-block-diff-add-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token key atrule">VAULT_OPENAI_API_KEY</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> secrets.VAULT_OPENAI_API_KEY </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In the same way you can add any other secrets to your GitHub actions.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-connect-to-ec2-instance">How to connect to EC2 instance?<a href="#how-to-connect-to-ec2-instance" class="hash-link" aria-label="Direct link to How to connect to EC2 instance?" title="Direct link to How to connect to EC2 instance?">​</a></h3>
<p>To connect to EC2 instance you can use SSH.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token builtin class-name" style="color:#e6db74">cd</span><span class="token plain"> deploy</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token function" style="color:#e6db74">ssh</span><span class="token plain"> </span><span class="token parameter variable" style="color:#f8f8f2">-i</span><span class="token plain"> ./.keys/id_rsa ubuntu@</span><span class="token operator" style="color:#66d9ef">&lt;</span><span class="token plain">your_ec2_ip</span><span class="token operator" style="color:#66d9ef">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>IP address can be found in terminal output after terraform apply.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="out-of-space-on-ec2-instance-extend-ebs-volume">Out of space on EC2 instance? Extend EBS volume<a href="#out-of-space-on-ec2-instance-extend-ebs-volume" class="hash-link" aria-label="Direct link to Out of space on EC2 instance? Extend EBS volume" title="Direct link to Out of space on EC2 instance? Extend EBS volume">​</a></h3>
<p>To upgrade EBS volume size you have to do next steps:</p>
<p>In <code>main.tf</code> file:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">main.tf</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">  root_block_device {</span><br></span><span class="token-line code-block-diff-remove-line" style="color:#f8f8f2"><span class="token plain">    volume_size = 20 // Size in GB for root partition</span><br></span><span class="token-line code-block-diff-add-line" style="color:#f8f8f2"><span class="token plain">    volume_size = 40 // Size in GB for root partition</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    volume_type = &quot;gp2&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>And run build.</p>
<p>This will increase physical size of EBS volume, but you have to increase filesystem size too.</p>
<p>Login to EC2 instance:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token function" style="color:#e6db74">ssh</span><span class="token plain"> </span><span class="token parameter variable" style="color:#f8f8f2">-i</span><span class="token plain"> ./.keys/id_rsa ubuntu@</span><span class="token operator" style="color:#66d9ef">&lt;</span><span class="token plain">your_ec2_ip</span><span class="token operator" style="color:#66d9ef">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>You can find your EC2 IP in AWS console by visiting EC2 -&gt; Instances -&gt; Your instance -&gt; IPv4 Public IP</p>
</blockquote>
<p>Now run next commands:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">lsblk</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This would show something like this:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">NAME    MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">loop0     </span><span class="token number" style="color:#ae81ff">7</span><span class="token plain">:0    </span><span class="token number" style="color:#ae81ff">0</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">99</span><span class="token plain">.4M  </span><span class="token number" style="color:#ae81ff">1</span><span class="token plain"> loop /snap/core/10908</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">nvme0n1 </span><span class="token number" style="color:#ae81ff">259</span><span class="token plain">:0    </span><span class="token number" style="color:#ae81ff">0</span><span class="token plain">   40G  </span><span class="token number" style="color:#ae81ff">0</span><span class="token plain"> disk</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">└─nvme0n1p1 </span><span class="token number" style="color:#ae81ff">259</span><span class="token plain">:1    </span><span class="token number" style="color:#ae81ff">0</span><span class="token plain">   20G  </span><span class="token number" style="color:#ae81ff">0</span><span class="token plain"> part /</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here we see that <code>nvme0n1</code> is our disk and <code>nvme0n1p1</code> is our partition.</p>
<p>Now to extend partition run:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token function" style="color:#e6db74">sudo</span><span class="token plain"> growpart /dev/nvme0n1 </span><span class="token number" style="color:#ae81ff">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token function" style="color:#e6db74">sudo</span><span class="token plain"> resize2fs /dev/nvme0n1p1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This will extend partition to the full disk size. No reboot is needed.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="want-slack-notifications-about-build">Want slack notifications about build?<a href="#want-slack-notifications-about-build" class="hash-link" aria-label="Direct link to Want slack notifications about build?" title="Direct link to Want slack notifications about build?">​</a></h3>
<p>Create Slack channel and add <a href="https://slack.com/apps/A0F7YS25R-incoming-webhooks" target="_blank" rel="noopener noreferrer">Slack app</a> to it.</p>
<p>Then create webhook URL and add it to GitHub secrets as <code>SLACK_WEBHOOK_URL</code>.</p>
<p>Add this steps to the end of your GitHub actions file:</p>
<div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_Ktv7">.github/workflows/deploy.yml</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> Notify Slack on success</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token key atrule">if</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> success()</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token key atrule">run</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">|</span><span class="token scalar string" style="color:#a6e22e"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          curl -X POST -H &#x27;Content-type: application/json&#x27; --data \</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          &quot;{\&quot;text\&quot;: \&quot;✅ *${{ github.actor }}* successfully built *${{ github.ref_name }}* with commit \\\&quot;${{ github.event.head_commit.message }}\\\&quot;.\n:link: &lt;${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Build&gt; | :link: &lt;${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|View Commit&gt;\&quot;}&quot; \</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          $SLACK_WEBHOOK_URL </span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token key atrule">env</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token key atrule">SLACK_WEBHOOK_URL</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> secrets.SLACK_WEBHOOK_URL </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> Notify Slack on failure</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token key atrule">if</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> failure()</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token key atrule">run</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">|</span><span class="token scalar string" style="color:#a6e22e"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          curl -X POST -H &#x27;Content-type: application/json&#x27; --data \</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          &quot;{\&quot;text\&quot;: \&quot;❌ *${{ github.actor }}* failed to build *${{ github.ref_name }}* with commit \\\&quot;${{ github.event.head_commit.message }}\\\&quot;.\n:link: &lt;${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Build&gt; | :link: &lt;${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|View Commit&gt;\&quot;}&quot; \</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          $SLACK_WEBHOOK_URL </span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token key atrule">env</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token key atrule">SLACK_WEBHOOK_URL</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> secrets.SLACK_WEBHOOK_URL </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a title="Amazon Web Services (AWS) is a cloud computing platform that provides a wide range of services for building and deploying applications." class="tag_zVej tagRegular_sFm0" href="/blog/tags/aws/">AWS</a></li><li class="tag_QGVx"><a title="Terraform is an open-source infrastructure as code software tool created by HashiCorp that enables users to define and provision data center infrastructure using a declarative configuration language." class="tag_zVej tagRegular_sFm0" href="/blog/tags/terraform/">Terraform</a></li><li class="tag_QGVx"><a title="GitHub Actions is a continuous integration and continuous deployment (CI/CD) service provided by GitHub that allows you to automate your software development workflows." class="tag_zVej tagRegular_sFm0" href="/blog/tags/github-actions/">GitHub Actions</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/keycloak-setup-example/"><div class="pagination-nav__sublabel">Newer post</div><div class="pagination-nav__label">Setup AdminForth Authorization via Keycloak</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/compose-ec2-deployment-github-actions-registry/"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">Amazon EC2 Deployments with GitHub Actions, Terraform, Docker &amp; Self-hosted Registry</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#chellenges-when-you-build-on-ci" class="table-of-contents__link toc-highlight">Chellenges when you build on CI</a><ul><li><a href="#delivering-images" class="table-of-contents__link toc-highlight">Delivering images</a></li><li><a href="#persisting-cache" class="table-of-contents__link toc-highlight">Persisting cache</a></li></ul></li><li><a href="#step-1---dockerfile-and-dockerignore" class="table-of-contents__link toc-highlight">Step 1 - Dockerfile and .dockerignore</a></li><li><a href="#step-2---composeyml" class="table-of-contents__link toc-highlight">Step 2 - compose.yml</a></li><li><a href="#step-3---create-a-ssh-keypair" class="table-of-contents__link toc-highlight">Step 3 - create a SSH keypair</a></li><li><a href="#step-4---create-tls-certificates-to-encrypt-traffic-between-ci-and-registry" class="table-of-contents__link toc-highlight">Step 4 - create TLS certificates to encrypt traffic between CI and registry</a></li><li><a href="#step-5---gitignore-file" class="table-of-contents__link toc-highlight">Step 5 - .gitignore file</a></li><li><a href="#step-6---file-with-secrets-for-local-deploy" class="table-of-contents__link toc-highlight">Step 6 - file with secrets for local deploy</a></li><li><a href="#step-7---main-terraform-file-maintf" class="table-of-contents__link toc-highlight">Step 7 - main terraform file main.tf</a><ul><li><a href="#step-71---configure-aws-profile" class="table-of-contents__link toc-highlight">Step 7.1 - Configure AWS Profile</a></li><li><a href="#step-72---run-deployment" class="table-of-contents__link toc-highlight">Step 7.2 - Run deployment</a></li></ul></li><li><a href="#step-8---migrate-state-to-the-cloud" class="table-of-contents__link toc-highlight">Step 8 - Migrate state to the cloud</a></li><li><a href="#step-9---cicd---github-actions" class="table-of-contents__link toc-highlight">Step 9 - CI/CD - Github Actions</a><ul><li><a href="#step-10---add-secrets-to-github" class="table-of-contents__link toc-highlight">Step 10 - Add secrets to GitHub</a></li><li><a href="#adding-secrets" class="table-of-contents__link toc-highlight">Adding secrets</a></li><li><a href="#how-to-connect-to-ec2-instance" class="table-of-contents__link toc-highlight">How to connect to EC2 instance?</a></li><li><a href="#out-of-space-on-ec2-instance-extend-ebs-volume" class="table-of-contents__link toc-highlight">Out of space on EC2 instance? Extend EBS volume</a></li><li><a href="#want-slack-notifications-about-build" class="table-of-contents__link toc-highlight">Want slack notifications about build?</a></li></ul></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/tutorial/gettingStarted/">Tutorial</a></li><li class="footer__item"><a href="https://demo.adminforth.dev/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Live Demo</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/api/">API</a></li><li class="footer__item"><a class="footer__link-item" href="/blog/archive/">Blog Archive</a></li><li class="footer__item"><a class="footer__link-item" href="/search/">Find anything</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://devforth.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">DevForth.io<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://devforth.io/contact" target="_blank" rel="noopener noreferrer" class="footer__link-item">We can develop admin panel for your project<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/devforth/adminforth" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Devforth sp. z o.o.</div></div></div></footer></div>
</body>
</html>