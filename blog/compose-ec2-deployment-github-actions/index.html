<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.1">
<title data-rh="true">Deploy AdminForth to EC2 with terraform on CI | Vue &amp; Node admin panel framework</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://adminforth.dev/img/og.jpg"><meta data-rh="true" name="twitter:image" content="https://adminforth.dev/img/og.jpg"><meta data-rh="true" property="og:url" content="https://adminforth.dev/blog/compose-ec2-deployment-github-actions/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Deploy AdminForth to EC2 with terraform on CI | Vue &amp; Node admin panel framework"><meta data-rh="true" name="description" content="Here is more advanced snippet to deploy AdminForth to Terraform."><meta data-rh="true" property="og:description" content="Here is more advanced snippet to deploy AdminForth to Terraform."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2024-11-14T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/ivictbor"><meta data-rh="true" property="article:tag" content="AWS,Terraform,GitHub Actions"><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://adminforth.dev/blog/compose-ec2-deployment-github-actions/"><link data-rh="true" rel="alternate" href="https://adminforth.dev/blog/compose-ec2-deployment-github-actions/" hreflang="en"><link data-rh="true" rel="alternate" href="https://adminforth.dev/blog/compose-ec2-deployment-github-actions/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://VSIPOF54AV-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://adminforth.dev/blog/compose-ec2-deployment-github-actions","mainEntityOfPage":"https://adminforth.dev/blog/compose-ec2-deployment-github-actions","url":"https://adminforth.dev/blog/compose-ec2-deployment-github-actions","headline":"Deploy AdminForth to EC2 with terraform on CI","name":"Deploy AdminForth to EC2 with terraform on CI","description":"Here is more advanced snippet to deploy AdminForth to Terraform.","datePublished":"2024-11-14T00:00:00.000Z","author":{"@type":"Person","name":"Ivan Borshchov","description":"Maintainer of AdminForth","url":"https://github.com/ivictbor","image":"https://avatars.githubusercontent.com/u/1838656?v=4"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://adminforth.dev/blog","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Vue &amp; Node admin panel framework RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Vue &amp; Node admin panel framework Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-7K99Q2BH04"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-7K99Q2BH04",{anonymize_ip:!0})</script>



<link rel="search" type="application/opensearchdescription+xml" title="Vue &amp; Node admin panel framework" href="/opensearch.xml">

<script src="/scripts/adminforth.js"></script><link rel="stylesheet" href="/assets/css/styles.49950da2.css">
<script src="/assets/js/runtime~main.1f2c0133.js" defer="defer"></script>
<script src="/assets/js/main.d09aff94.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||"light"),document.documentElement.setAttribute("data-theme-choice",t||"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo.svg"><link rel="preload" as="image" href="https://avatars.githubusercontent.com/u/1838656?v=4"><div role="region" aria-label="Skip to main content"><a class="skipToContent_Mndp" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="AdminForth Logo" class="themedComponent_abzR themedComponent--light_IjiB"><img src="/img/logo.svg" alt="AdminForth Logo" class="themedComponent_abzR themedComponent--dark_O3Fz"></div><b class="navbar__title text--truncate">AdminForth</b></a><a class="navbar__item navbar__link" href="/docs/tutorial/gettingStarted/">Tutorial</a><a class="navbar__item navbar__link" href="/docs/api/">API</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog/">Blog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div class="navbarSearchContainer_IZ8R"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Meta+k)" aria-keyshortcuts="Meta+k"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 24 24" aria-hidden="true"><circle cx="11" cy="11" r="8" stroke="currentColor" fill="none" stroke-width="1.4"></circle><path d="m21 21-4.3-4.3" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div><a href="https://demo.adminforth.dev/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Live Demo<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_wSz0"><use href="#theme-svg-external-link"></use></svg></a><a href="https://github.com/devforth/adminforth" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_wSz0"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_OprV colorModeToggle_GWyB"><button class="clean-btn toggleButton_g_ff toggleButtonDisabled_uc5P" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_DwfO lightToggleIcon_JliJ"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_DwfO darkToggleIcon_dakX"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_DwfO systemToggleIcon_WIBr"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_BBNw"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_qhJt thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_JvAI margin-bottom--md">Recent posts</div><div role="group"><h3 class="yearGroupHeading_i2NZ">2025</h3><ul class="sidebarItemList_kmV_ clean-list"><li class="sidebarItem_L71H"><a class="sidebarItemLink_f9W6" href="/blog/dynamic-strings-translation/">How to translate dynamic strings in AdminForth API</a></li><li class="sidebarItem_L71H"><a class="sidebarItemLink_f9W6" href="/blog/keycloak-setup-example/">Setup AdminForth Authorization via Keycloak</a></li><li class="sidebarItem_L71H"><a class="sidebarItemLink_f9W6" href="/blog/compose-ec2-deployment-github-actions-registry/">Amazon EC2 Deployments with GitHub Actions, Terraform, Docker &amp; Self-hosted Registry</a></li><li class="sidebarItem_L71H"><a class="sidebarItemLink_f9W6" href="/blog/compose-aws-ec2-ecr-terraform-github-actions/">IaaC Simplified: Amazon EC2 Deployments with GitHub Actions, Terraform, Docker &amp; Amazon ECR</a></li><li class="sidebarItem_L71H"><a class="sidebarItemLink_f9W6" href="/blog/how-i-opensourced-my-secret-tokens/">How I Open-Sourced My Secret Access Tokens from GitHub, Slack, and NPM — and Who Actually Cares</a></li></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class="title_UqYT">Deploy AdminForth to EC2 with terraform on CI</h1><div class="container_M_zN margin-vert--md"><time datetime="2024-11-14T00:00:00.000Z">November 14, 2024</time> · <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_rNfl"><div class="avatar margin-bottom--sm"><a href="https://github.com/ivictbor" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_pvK4" src="https://avatars.githubusercontent.com/u/1838656?v=4" alt="Ivan Borshchov"></a><div class="avatar__intro authorDetails_lYv3"><div class="avatar__name"><a href="https://github.com/ivictbor" target="_blank" rel="noopener noreferrer"><span class="authorName__okt" translate="no">Ivan Borshchov</span></a></div><small class="authorTitle_bjdg" title="Maintainer of AdminForth">Maintainer of AdminForth</small><div class="authorSocials_Rumv"></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p>Here is more advanced snippet to deploy AdminForth to Terraform.</p>
<p>Here Terraform state will be stored in the cloud, so you can run this deployment from any machine including stateless CI/CD.</p>
<p>We will use GitHub Actions as CI/CD, but you can use any other CI/CD, for example self-hosted free WoodpeckerCI.</p>
<p>Assume you have your AdminForth project in <code>myadmin</code>.</p>
<h2 class="anchor anchorWithStickyNavbar_fMI7" id="step-1---dockerfile-and-dockerignore">Step 1 - Dockerfile and .dockerignore<a href="#step-1---dockerfile-and-dockerignore" class="hash-link" aria-label="Direct link to Step 1 - Dockerfile and .dockerignore" title="Direct link to Step 1 - Dockerfile and .dockerignore" translate="no">​</a></h2>
<p>This guide assumes you have created your AdminForth application with latest version of <code>adminforth create-app</code> command.
This command already creates a <code>Dockerfile</code> and <code>.dockerignore</code> for you, so you can use them as is.</p>
<h2 class="anchor anchorWithStickyNavbar_fMI7" id="step-2---composeyml">Step 2 - compose.yml<a href="#step-2---composeyml" class="hash-link" aria-label="Direct link to Step 2 - compose.yml" title="Direct link to Step 2 - compose.yml" translate="no">​</a></h2>
<p>Create folder <code>deploy</code> and create file <code>compose.yml</code> inside:</p>
<div class="language-yml codeBlockContainer_zbXh theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_VeI8">deploy/compose.yml</div><div class="codeBlockContent_RvPW"><pre tabindex="0" class="prism-code language-yml codeBlock_hldk thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_aHhF"><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token key atrule">services</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token key atrule">traefik</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;traefik:v2.5&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">command</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;--api.insecure=true&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;--providers.docker=true&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;--entrypoints.web.address=:80&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;80:80&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">volumes</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;/var/run/docker.sock:/var/run/docker.sock:ro&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token key atrule">myadmin</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">build</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> ../myadmin</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">restart</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> always</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">env_file</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> ./myadmin/.env.secrets.prod</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">volumes</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> myadmin</span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain">db</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain">/code/db</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;traefik.enable=true&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;traefik.http.routers.myadmin.rule=PathPrefix(`/`)&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;traefik.http.services.myadmin.loadbalancer.server.port=3500&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;traefik.http.routers.myadmin.priority=2&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token key atrule">volumes</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  myadmin</span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain">db</span><span class="token punctuation" style="color:#f8f8f2">:</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_fMI7" id="step-3---create-a-ssh-keypair">Step 3 - create a SSH keypair<a href="#step-3---create-a-ssh-keypair" class="hash-link" aria-label="Direct link to Step 3 - create a SSH keypair" title="Direct link to Step 3 - create a SSH keypair" translate="no">​</a></h2>
<p>Make sure you are in <code>deploy</code> folder, run next command here:</p>
<div class="language-bash codeBlockContainer_zbXh theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_VeI8">deploy</div><div class="codeBlockContent_RvPW"><pre tabindex="0" class="prism-code language-bash codeBlock_hldk thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_aHhF"><span class="token-line" style="color:#f8f8f2"><span class="token function" style="color:#e6db74">mkdir</span><span class="token plain"> .keys </span><span class="token operator" style="color:#66d9ef">&amp;&amp;</span><span class="token plain"> ssh-keygen </span><span class="token parameter variable" style="color:#f8f8f2">-f</span><span class="token plain"> .keys/id_rsa </span><span class="token parameter variable" style="color:#f8f8f2">-N</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;&quot;</span><br></span></code></pre></div></div>
<p>Now it should create <code>deploy/.keys/id_rsa</code> and <code>deploy/.keys/id_rsa.pub</code> files with your SSH keypair. Terraform script will put the public key to the EC2 instance and will use private key to connect to the instance. Also you will be able to use it to connect to the instance manually.</p>
<h2 class="anchor anchorWithStickyNavbar_fMI7" id="step-4---gitignore-file">Step 4 - .gitignore file<a href="#step-4---gitignore-file" class="hash-link" aria-label="Direct link to Step 4 - .gitignore file" title="Direct link to Step 4 - .gitignore file" translate="no">​</a></h2>
<p>Create <code>deploy/.gitignore</code> file with next content:</p>
<div class="language-bash codeBlockContainer_zbXh theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_RvPW"><pre tabindex="0" class="prism-code language-bash codeBlock_hldk thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_aHhF"><span class="token-line" style="color:#f8f8f2"><span class="token plain">.terraform/</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">.keys/</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">*.tfstate</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">*.tfstate.*</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">*.tfvars</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">tfplan</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">.env.secrets.prod</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_fMI7" id="step-5---main-terraform-file-maintf">Step 5 - Main terraform file main.tf<a href="#step-5---main-terraform-file-maintf" class="hash-link" aria-label="Direct link to Step 5 - Main terraform file main.tf" title="Direct link to Step 5 - Main terraform file main.tf" translate="no">​</a></h2>
<p>First of all install Terraform as described here <a href="https://developer.hashicorp.com/terraform/install#linux" target="_blank" rel="noopener noreferrer">terraform installation</a>.</p>
<p>Create file <code>main.tf</code> in <code>deploy</code> folder:</p>
<div class="language-hcl codeBlockContainer_zbXh theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_VeI8">deploy/main.tf</div><div class="codeBlockContent_RvPW"><pre tabindex="0" class="prism-code language-hcl codeBlock_hldk thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_aHhF"><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">locals {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  app_name = &quot;&lt;your_app_name&gt;&quot; # replace with your app name</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  aws_region = &quot;eu-central-1&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">provider &quot;aws&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  region = local.aws_region</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  profile = &quot;myaws&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">data &quot;aws_ami&quot; &quot;ubuntu_linux&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  most_recent = true</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  owners      = [&quot;amazon&quot;]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  filter {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    name   = &quot;name&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    values = [&quot;ubuntu/images/hvm-ssd-gp3/ubuntu-noble-24.04-amd64-server-*&quot;]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">data &quot;aws_vpc&quot; &quot;default&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  default = true</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">resource &quot;aws_eip&quot; &quot;eip&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"> domain = &quot;vpc&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">resource &quot;aws_eip_association&quot; &quot;eip_assoc&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"> instance_id   = aws_instance.app_instance.id</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"> allocation_id = aws_eip.eip.id</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">data &quot;aws_subnet&quot; &quot;default_subnet&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  filter {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    name   = &quot;vpc-id&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    values = [data.aws_vpc.default.id]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  filter {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    name   = &quot;default-for-az&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    values = [&quot;true&quot;]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  filter {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    name   = &quot;availability-zone&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    values = [&quot;${local.aws_region}a&quot;]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">resource &quot;aws_security_group&quot; &quot;instance_sg&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  name   = &quot;${local.app_name}-instance-sg&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  vpc_id = data.aws_vpc.default.id</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  ingress {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    description = &quot;Allow HTTP&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    from_port   = 80</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    to_port     = 80</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    protocol    = &quot;tcp&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    cidr_blocks = [&quot;0.0.0.0/0&quot;]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  # SSH</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  ingress {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    description = &quot;Allow SSH&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    from_port   = 22</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    to_port     = 22</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    protocol    = &quot;tcp&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    cidr_blocks = [&quot;0.0.0.0/0&quot;]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  egress {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    description = &quot;Allow all outbound traffic&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    from_port   = 0</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    to_port     = 0</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    protocol    = &quot;-1&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    cidr_blocks = [&quot;0.0.0.0/0&quot;]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">resource &quot;aws_key_pair&quot; &quot;app_deployer&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  key_name   = &quot;terraform-deploy_${local.app_name}-key&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  public_key = file(&quot;./.keys/id_rsa.pub&quot;) # Path to your public SSH key</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">resource &quot;aws_instance&quot; &quot;app_instance&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  ami                    = data.aws_ami.ubuntu_linux.id</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  instance_type          = &quot;t3a.small&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  subnet_id              = data.aws_subnet.default_subnet.id</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  vpc_security_group_ids = [aws_security_group.instance_sg.id]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  key_name               = aws_key_pair.app_deployer.key_name</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  # prevent accidental termination of ec2 instance and data loss</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  # if you will need to recreate the instance still (not sure why it can be?), you will need to remove this block manually by next command:</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  # &gt; terraform taint aws_instance.app_instance</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  lifecycle {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    prevent_destroy = true</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ignore_changes = [ami]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  root_block_device {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    volume_size = 20 // Size in GB for root partition</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    volume_type = &quot;gp2&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    # Even if the instance is terminated, the volume will not be deleted, delete it manually if needed</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    delete_on_termination = false</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  user_data = &lt;&lt;-EOF</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    #!/bin/bash</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    sudo apt-get update</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    sudo apt-get install ca-certificates curl</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    sudo install -m 0755 -d /etc/apt/keyrings</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    sudo chmod a+r /etc/apt/keyrings/docker.asc</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    # Add the repository to Apt sources:</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    echo \</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      &quot;deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      $(. /etc/os-release &amp;&amp; echo &quot;$VERSION_CODENAME&quot;) stable&quot; | \</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    sudo apt-get update</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    systemctl start docker</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    systemctl enable docker</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    usermod -a -G docker ubuntu</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    echo &quot;done&quot; &gt; /home/ubuntu/user_data_done</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  EOF</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  tags = {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    Name = &quot;${local.app_name}-instance&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">resource &quot;null_resource&quot; &quot;wait_for_user_data&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  provisioner &quot;remote-exec&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    inline = [</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      &quot;echo &#x27;Waiting for EC2 software install to finish...&#x27;&quot;,</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      &quot;while [ ! -f /home/ubuntu/user_data_done ]; do echo &#x27;...&#x27;; sleep 2; done&quot;,</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      &quot;echo &#x27;EC2 software install finished.&#x27;&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    connection {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      type        = &quot;ssh&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      user        = &quot;ubuntu&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      private_key = file(&quot;./.keys/id_rsa&quot;)</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      host        = aws_eip_association.eip_assoc.public_ip</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  depends_on = [aws_instance.app_instance]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">resource &quot;null_resource&quot; &quot;sync_files_and_run&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  # Use rsync to exclude node_modules, .git, db</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  provisioner &quot;local-exec&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    # heredoc syntax</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    # remove files that where deleted on the source</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    command = &lt;&lt;-EOF</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    #  -o StrictHostKeyChecking=no</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    rsync -t -av -e &quot;ssh -i ./.keys/id_rsa -o StrictHostKeyChecking=no&quot; \</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      --delete \</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      --exclude &#x27;node_modules&#x27; \</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      --exclude &#x27;.git&#x27; \</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      --exclude &#x27;.terraform&#x27; \</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      --exclude &#x27;terraform*&#x27; \</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      --exclude &#x27;tfplan&#x27; \</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      --exclude &#x27;.keys&#x27; \</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      --exclude &#x27;.vscode&#x27; \</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      --exclude &#x27;.env&#x27; \</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      --exclude &#x27;db&#x27; \</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      ../ ubuntu@${aws_eip_association.eip_assoc.public_ip}:/home/ubuntu/app/</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    EOF</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  # Run docker compose after files have been copied</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  provisioner &quot;remote-exec&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    inline = [</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      # please note that prune might destroy build cache and make build slower, however it releases disk space</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      &quot;docker system prune -f&quot;,</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      # &quot;docker buildx prune -f --filter &#x27;type!=exec.cachemount&#x27;&quot;,</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      &quot;cd /home/ubuntu/app/deploy&quot;,</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      &quot;COMPOSE_BAKE=true docker compose --progress=plain -p app -f compose.yml up --build -d&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    connection {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      type        = &quot;ssh&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      user        = &quot;ubuntu&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      private_key = file(&quot;./.keys/id_rsa&quot;)</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      host        = aws_eip_association.eip_assoc.public_ip</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  # Ensure the resource is triggered every time based on timestamp or file hash</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  triggers = {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    always_run = timestamp()</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  depends_on = [null_resource.wait_for_user_data, aws_eip_association.eip_assoc]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">output &quot;instance_public_ip&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  value = aws_eip_association.eip_assoc.public_ip</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">######### This scetion is for tf state storage ##############</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"># S3 bucket for storing Terraform state</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">resource &quot;aws_s3_bucket&quot; &quot;terraform_state&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  bucket = &quot;${local.app_name}-terraform-state&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">resource &quot;aws_s3_bucket_lifecycle_configuration&quot; &quot;terraform_state&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  bucket = aws_s3_bucket.terraform_state.bucket</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  rule {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    status = &quot;Enabled&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    id = &quot;Keep only the latest version of the state file&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    filter {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      prefix = &quot;&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    noncurrent_version_expiration {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      noncurrent_days = 30</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">resource &quot;aws_s3_bucket_versioning&quot; &quot;terraform_state&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  bucket = aws_s3_bucket.terraform_state.bucket</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  versioning_configuration {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    status = &quot;Enabled&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">resource &quot;aws_s3_bucket_server_side_encryption_configuration&quot; &quot;terraform_state&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  bucket = aws_s3_bucket.terraform_state.bucket</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  rule {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    apply_server_side_encryption_by_default {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      sse_algorithm     = &quot;AES256&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span></code></pre></div></div>
<blockquote>
<p>👆 Replace <code>&lt;your_app_name&gt;</code> with your app name (no spaces, only underscores or letters)</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_fMI7" id="step-51---configure-aws-profile">Step 5.1 - Configure AWS Profile<a href="#step-51---configure-aws-profile" class="hash-link" aria-label="Direct link to Step 5.1 - Configure AWS Profile" title="Direct link to Step 5.1 - Configure AWS Profile" translate="no">​</a></h3>
<p>Open or create file ~/.aws/credentials and add (if not already there):</p>
<div class="language-ini codeBlockContainer_zbXh theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_RvPW"><pre tabindex="0" class="prism-code language-ini codeBlock_hldk thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_aHhF"><span class="token-line" style="color:#f8f8f2"><span class="token plain">[myaws]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">aws_access_key_id = &lt;your_access_key&gt;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">aws_secret_access_key = &lt;your_secret_key&gt;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_fMI7" id="step-52---run-deployment">Step 5.2 - Run deployment<a href="#step-52---run-deployment" class="hash-link" aria-label="Direct link to Step 5.2 - Run deployment" title="Direct link to Step 5.2 - Run deployment" translate="no">​</a></h3>
<p>To run the deployment first time, you need to run:</p>
<div class="language-bash codeBlockContainer_zbXh theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_RvPW"><pre tabindex="0" class="prism-code language-bash codeBlock_hldk thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_aHhF"><span class="token-line" style="color:#f8f8f2"><span class="token plain">terraform init</span><br></span></code></pre></div></div>
<p>Now run deployement:</p>
<div class="language-bash codeBlockContainer_zbXh theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_RvPW"><pre tabindex="0" class="prism-code language-bash codeBlock_hldk thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_aHhF"><span class="token-line" style="color:#f8f8f2"><span class="token plain">terraform apply -auto-approve</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_fMI7" id="step-6---migrate-state-to-the-cloud">Step 6 - Migrate state to the cloud<a href="#step-6---migrate-state-to-the-cloud" class="hash-link" aria-label="Direct link to Step 6 - Migrate state to the cloud" title="Direct link to Step 6 - Migrate state to the cloud" translate="no">​</a></h2>
<p>First deployment had to create S3 bucket for storing Terraform state. Now we need to migrate the state to the cloud.</p>
<p>Add to the end of <code>main.tf</code>:</p>
<div class="language-hcl codeBlockContainer_zbXh theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_VeI8">main.tf</div><div class="codeBlockContent_RvPW"><pre tabindex="0" class="prism-code language-hcl codeBlock_hldk thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_aHhF"><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"># Configure the backend to use the S3 bucket</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">terraform {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"> backend &quot;s3&quot; {</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">   bucket         = &quot;&lt;your_app_name&gt;-terraform-state&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">   key            = &quot;state.tfstate&quot;  # Define a specific path for the state file</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">   region         = &quot;eu-central-1&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">   profile        = &quot;myaws&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">   use_lockfile   = true</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"> }</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">}</span><br></span></code></pre></div></div>
<blockquote>
<p>👆 Replace <code>&lt;your_app_name&gt;</code> with your app name (no spaces, only underscores or letters).
Unfortunately we can&#x27;t use variables, HashiCorp thinks it is too dangerous 😥</p>
</blockquote>
<p>Now run:</p>
<div class="language-bash codeBlockContainer_zbXh theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_RvPW"><pre tabindex="0" class="prism-code language-bash codeBlock_hldk thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_aHhF"><span class="token-line" style="color:#f8f8f2"><span class="token plain">terraform init -migrate-state</span><br></span></code></pre></div></div>
<p>Now run test deployment:</p>
<div class="language-bash codeBlockContainer_zbXh theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_RvPW"><pre tabindex="0" class="prism-code language-bash codeBlock_hldk thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_aHhF"><span class="token-line" style="color:#f8f8f2"><span class="token plain">terraform apply -auto-approve</span><br></span></code></pre></div></div>
<p>Now you can delete local <code>terraform.tfstate</code> file and <code>terraform.tfstate.backup</code> file as they are in the cloud now.</p>
<h2 class="anchor anchorWithStickyNavbar_fMI7" id="step-7---cicd---github-actions">Step 7 - CI/CD - Github Actions<a href="#step-7---cicd---github-actions" class="hash-link" aria-label="Direct link to Step 7 - CI/CD - Github Actions" title="Direct link to Step 7 - CI/CD - Github Actions" translate="no">​</a></h2>
<p>Create file <code>.github/workflows/deploy.yml</code>:</p>
<div class="language-yml codeBlockContainer_zbXh theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_VeI8">.github/workflows/deploy.yml</div><div class="codeBlockContent_RvPW"><pre tabindex="0" class="prism-code language-yml codeBlock_hldk thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_aHhF"><span class="token-line" style="color:#f8f8f2"><span class="token key atrule">name</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> Deploy </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token key atrule">run-name</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> github.actor </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> builds app 🚀</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token key atrule">on</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain">push</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token key atrule">jobs</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token key atrule">Explore-GitHub-Actions</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">runs-on</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token key atrule">run</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> echo &quot;🎉 The job was automatically triggered by a $</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> github.event_name </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> event.&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token key atrule">run</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> echo &quot;🐧 This job is now running on a $</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> runner.os </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> server&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token key atrule">run</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> echo &quot;🔎 The name of your branch is $</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> github.ref </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain">&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> Check out repository code</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> actions/checkout@v4</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> Set up Terraform</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> hashicorp/setup</span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain">terraform@v2</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token key atrule">with</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token key atrule">terraform_version</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> 1.10.1 </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token key atrule">run</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> echo &quot;💡 The $</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> github.repository </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> repository has been cloned to the runner.&quot;</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> Prepare env</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token key atrule">run</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">|</span><span class="token scalar string" style="color:#a6e22e"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          echo &quot;ADMINFORTH_SECRET=$VAULT_ADMINFORTH_SECRET&quot; &gt; deploy/.env.secrets.prod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token key atrule">env</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token key atrule">VAULT_ADMINFORTH_SECRET</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> secrets.VAULT_ADMINFORTH_SECRET </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> Start building</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token key atrule">env</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token key atrule">VAULT_AWS_ACCESS_KEY_ID</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> secrets.VAULT_AWS_ACCESS_KEY_ID </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token key atrule">VAULT_AWS_SECRET_ACCESS_KEY</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> secrets.VAULT_AWS_SECRET_ACCESS_KEY </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token key atrule">VAULT_SSH_PRIVATE_KEY</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> secrets.VAULT_SSH_PRIVATE_KEY </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token key atrule">VAULT_SSH_PUBLIC_KEY</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> secrets.VAULT_SSH_PUBLIC_KEY </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token key atrule">run</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">|</span><span class="token scalar string" style="color:#a6e22e"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token scalar string" style="color:#a6e22e">          /bin/sh -x deploy/deploy.sh</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token key atrule">run</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> echo &quot;🍏 This job&#x27;s status is $</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"> job.status </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain">.&quot;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_fMI7" id="step-71---create-deploy-script">Step 7.1 - Create deploy script<a href="#step-71---create-deploy-script" class="hash-link" aria-label="Direct link to Step 7.1 - Create deploy script" title="Direct link to Step 7.1 - Create deploy script" translate="no">​</a></h3>
<p>Now create file <code>deploy/deploy.sh</code>:</p>
<div class="language-bash codeBlockContainer_zbXh theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockTitle_VeI8">deploy/deploy.sh</div><div class="codeBlockContent_RvPW"><pre tabindex="0" class="prism-code language-bash codeBlock_hldk thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_aHhF"><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#8292a2;font-style:italic"># cd to dir of script</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token builtin class-name" style="color:#e6db74">cd</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;</span><span class="token string variable" style="color:#f8f8f2">$(</span><span class="token string variable function" style="color:#e6db74">dirname</span><span class="token string variable" style="color:#f8f8f2"> </span><span class="token string variable string" style="color:#a6e22e">&quot;</span><span class="token string variable string variable" style="color:#f8f8f2">$0</span><span class="token string variable string" style="color:#a6e22e">&quot;</span><span class="token string variable" style="color:#f8f8f2">)</span><span class="token string" style="color:#a6e22e">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token function" style="color:#e6db74">mkdir</span><span class="token plain"> </span><span class="token parameter variable" style="color:#f8f8f2">-p</span><span class="token plain"> ~/.aws ./.keys</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token function" style="color:#e6db74">cat</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">&lt;&lt;</span><span class="token string" style="color:#a6e22e">EOF</span><span class="token string bash punctuation" style="color:#f8f8f2"> </span><span class="token string bash punctuation operator" style="color:#66d9ef">&gt;</span><span class="token string bash punctuation" style="color:#f8f8f2"> ~/.aws/credentials</span><span class="token string" style="color:#a6e22e"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token string" style="color:#a6e22e">[myaws]</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token string" style="color:#a6e22e">aws_access_key_id=</span><span class="token string variable" style="color:#f8f8f2">$VAULT_AWS_ACCESS_KEY_ID</span><span class="token string" style="color:#a6e22e"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token string" style="color:#a6e22e">aws_secret_access_key=</span><span class="token string variable" style="color:#f8f8f2">$VAULT_AWS_SECRET_ACCESS_KEY</span><span class="token string" style="color:#a6e22e"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token string" style="color:#a6e22e">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token function" style="color:#e6db74">cat</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">&lt;&lt;</span><span class="token string" style="color:#a6e22e">EOF</span><span class="token string bash punctuation" style="color:#f8f8f2"> </span><span class="token string bash punctuation operator" style="color:#66d9ef">&gt;</span><span class="token string bash punctuation" style="color:#f8f8f2"> ./.keys/id_rsa</span><span class="token string" style="color:#a6e22e"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token string" style="color:#a6e22e"></span><span class="token string variable" style="color:#f8f8f2">$VAULT_SSH_PRIVATE_KEY</span><span class="token string" style="color:#a6e22e"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token string" style="color:#a6e22e">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token function" style="color:#e6db74">cat</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">&lt;&lt;</span><span class="token string" style="color:#a6e22e">EOF</span><span class="token string bash punctuation" style="color:#f8f8f2"> </span><span class="token string bash punctuation operator" style="color:#66d9ef">&gt;</span><span class="token string bash punctuation" style="color:#f8f8f2"> ./.keys/id_rsa.pub</span><span class="token string" style="color:#a6e22e"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token string" style="color:#a6e22e"></span><span class="token string variable" style="color:#f8f8f2">$VAULT_SSH_PUBLIC_KEY</span><span class="token string" style="color:#a6e22e"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token string" style="color:#a6e22e">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token function" style="color:#e6db74">chmod</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">600</span><span class="token plain"> ./.keys/id_rsa*</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#8292a2;font-style:italic"># force Terraform to reinitialize the backend without migrating the state.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">terraform init </span><span class="token parameter variable" style="color:#f8f8f2">-reconfigure</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">terraform plan </span><span class="token parameter variable" style="color:#f8f8f2">-out</span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain">tfplan</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">terraform apply tfplan</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_fMI7" id="step-72---add-secrets-to-github">Step 7.2 - Add secrets to GitHub<a href="#step-72---add-secrets-to-github" class="hash-link" aria-label="Direct link to Step 7.2 - Add secrets to GitHub" title="Direct link to Step 7.2 - Add secrets to GitHub" translate="no">​</a></h3>
<p>Go to your GitHub repository, then <code>Settings</code> -&gt; <code>Secrets</code> -&gt; <code>New repository secret</code> and add:</p>
<ul>
<li><code>VAULT_AWS_ACCESS_KEY_ID</code> - your AWS access key</li>
<li><code>VAULT_AWS_SECRET_ACCESS_KEY</code> - your AWS secret key</li>
<li><code>VAULT_SSH_PRIVATE_KEY</code> - make <code>cat ~/.ssh/id_rsa</code> and paste to GitHub secrets</li>
<li><code>VAULT_SSH_PUBLIC_KEY</code> - make <code>cat ~/.ssh/id_rsa.pub</code> and paste to GitHub secrets</li>
<li><code>VAULT_ADMINFORTH_SECRET</code> - your AdminForth secret - random string, for example <code>openssl rand -base64 32 | tr -d &#x27;\n&#x27;</code></li>
</ul>
<p>Now you can push your changes to GitHub and see how it will be deployed automatically.</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_pnIT padding--none margin-left--sm"><li class="tag_qqdV"><a rel="tag" title="Amazon Web Services (AWS) is a cloud computing platform that provides a wide range of services for building and deploying applications." class="tag_vGdz tagRegular_nwg7" href="/blog/tags/aws/">AWS</a></li><li class="tag_qqdV"><a rel="tag" title="Terraform is an open-source infrastructure as code software tool created by HashiCorp that enables users to define and provision data center infrastructure using a declarative configuration language." class="tag_vGdz tagRegular_nwg7" href="/blog/tags/terraform/">Terraform</a></li><li class="tag_qqdV"><a rel="tag" title="GitHub Actions is a continuous integration and continuous deployment (CI/CD) service provided by GitHub that allows you to automate your software development workflows." class="tag_vGdz tagRegular_nwg7" href="/blog/tags/github-actions/">GitHub Actions</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/backup-database-to-aws-glacier/"><div class="pagination-nav__sublabel">Newer post</div><div class="pagination-nav__label">Backup database to AWS Glacier</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/compose-ec2-deployment/"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">Deploy AdminForth to EC2 with terraform (without CI)</div></a></nav></main><div class="col col--2"><div class="tableOfContents_zXaw thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#step-1---dockerfile-and-dockerignore" class="table-of-contents__link toc-highlight">Step 1 - Dockerfile and .dockerignore</a></li><li><a href="#step-2---composeyml" class="table-of-contents__link toc-highlight">Step 2 - compose.yml</a></li><li><a href="#step-3---create-a-ssh-keypair" class="table-of-contents__link toc-highlight">Step 3 - create a SSH keypair</a></li><li><a href="#step-4---gitignore-file" class="table-of-contents__link toc-highlight">Step 4 - .gitignore file</a></li><li><a href="#step-5---main-terraform-file-maintf" class="table-of-contents__link toc-highlight">Step 5 - Main terraform file main.tf</a><ul><li><a href="#step-51---configure-aws-profile" class="table-of-contents__link toc-highlight">Step 5.1 - Configure AWS Profile</a></li><li><a href="#step-52---run-deployment" class="table-of-contents__link toc-highlight">Step 5.2 - Run deployment</a></li></ul></li><li><a href="#step-6---migrate-state-to-the-cloud" class="table-of-contents__link toc-highlight">Step 6 - Migrate state to the cloud</a></li><li><a href="#step-7---cicd---github-actions" class="table-of-contents__link toc-highlight">Step 7 - CI/CD - Github Actions</a><ul><li><a href="#step-71---create-deploy-script" class="table-of-contents__link toc-highlight">Step 7.1 - Create deploy script</a></li><li><a href="#step-72---add-secrets-to-github" class="table-of-contents__link toc-highlight">Step 7.2 - Add secrets to GitHub</a></li></ul></li></ul></div></div></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/tutorial/gettingStarted/">Tutorial</a></li><li class="footer__item"><a href="https://demo.adminforth.dev/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Live Demo</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/api/">API</a></li><li class="footer__item"><a class="footer__link-item" href="/blog/archive/">Blog Archive</a></li><li class="footer__item"><a class="footer__link-item" href="/search/">Find anything</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://devforth.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">DevForth.io<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_wSz0"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://devforth.io/contact" target="_blank" rel="noopener noreferrer" class="footer__link-item">We can develop admin panel for your project<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_wSz0"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/devforth/adminforth" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_wSz0"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Devforth sp. z o.o.</div></div></div></footer></div>
</body>
</html>