"use strict";(self.webpackChunkadminforth=self.webpackChunkadminforth||[]).push([[8643],{4661:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>a,default:()=>u,frontMatter:()=>o,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"tutorial/Plugins/TwoFactorsAuth","title":"Two-Factor Authentication Plugin","description":"The Two-Factor Authentication Plugin provides an additional layer of security to the application by requiring users to provide a second form of authentication in addition to their password. This plugin supports  authenticator apps.","source":"@site/docs/tutorial/05-Plugins/02-TwoFactorsAuth.md","sourceDirName":"tutorial/05-Plugins","slug":"/tutorial/Plugins/TwoFactorsAuth","permalink":"/docs/tutorial/Plugins/TwoFactorsAuth","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":2,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"AuditLog","permalink":"/docs/tutorial/Plugins/AuditLog"},"next":{"title":"ForeignInlineList","permalink":"/docs/tutorial/Plugins/ForeignInlineList"}}');var s=t(4848),r=t(8453);const o={},a="Two-Factor Authentication Plugin",d={},l=[{value:"Installation",id:"installation",level:2},{value:"Disabling Two-Factor Authentication locally",id:"disabling-two-factor-authentication-locally",level:2},{value:"Select which users should use Two-Factor Authentication",id:"select-which-users-should-use-two-factor-authentication",level:2},{value:"Allow Specific Users to Skip Two-Factor Authentication Setup",id:"allow-specific-users-to-skip-two-factor-authentication-setup",level:2}];function c(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",header:"header",img:"img",p:"p",pre:"pre",strong:"strong",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"two-factor-authentication-plugin",children:"Two-Factor Authentication Plugin"})}),"\n",(0,s.jsx)(n.p,{children:"The Two-Factor Authentication Plugin provides an additional layer of security to the application by requiring users to provide a second form of authentication in addition to their password. This plugin supports  authenticator apps."}),"\n",(0,s.jsx)(n.h2,{id:"installation",children:"Installation"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"npm i @adminforth/two-factors-auth --save\n"})}),"\n",(0,s.jsx)(n.p,{children:"Plugin is already installed into adminforth, to import:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="/users.ts"',children:"import TwoFactorsAuthPlugin from '@adminforth/two-factors-auth';\n"})}),"\n",(0,s.jsx)(n.p,{children:"Plugin required some additional setup, to make it work properly. It should be added to the resource auth resource. In our example we will add it to the user resource ."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:"title='./schema.prisma'",children:"model users {\n  id            String     @id\n  created_at    DateTime\n  email         String   @unique\n  role          String\n  password_hash String\n//diff-add\n  secret2fa     String?\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:"Then:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"npx --yes prisma migrate dev --name init\n"})}),"\n",(0,s.jsxs)(n.p,{children:["And add it to ",(0,s.jsx)(n.code,{children:"users.ts"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'tittle="./resources/users.ts"',children:"{\n    table: 'users',\n//diff-add\n    plugins: [\n//diff-add\n        new TwoFactorsAuthPlugin ({ twoFaSecretFieldName: 'secret2fa', timeStepWindow: 1 }),\n//diff-add\n    ],\n    columns: [\n        ...\n//diff-add\n        {\n//diff-add\n            name: 'secret2fa',\n//diff-add\n            showIn: { all: false },\n//diff-add\n            backendOnly: true,\n//diff-add\n        }\n    ],\n  }\n"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["\ud83d\udca1 ",(0,s.jsx)(n.strong,{children:"Note"}),": Time-Step Size"]}),"\n",(0,s.jsxs)(n.p,{children:["By default, ",(0,s.jsx)(n.code,{children:"timeStepWindow"})," is set to ",(0,s.jsx)(n.code,{children:"1"}),", which means the Two-Factor Authentication Plugin will check the current 30-second time-step, as well as one step before and after, to validate a TOTP code. This aligns with ",(0,s.jsx)(n.a,{href:"https://www.rfc-editor.org/rfc/rfc6238",children:"RFC 6238"})," best practices to accommodate slight clock drift between the server and the user's device."]}),"\n",(0,s.jsxs)(n.p,{children:["For example, if a code is generated between ",(0,s.jsx)(n.strong,{children:"12:00:00"})," and ",(0,s.jsx)(n.strong,{children:"12:00:30"}),", it will typically expire at ",(0,s.jsx)(n.strong,{children:"12:00:30"}),". However, with a ",(0,s.jsx)(n.code,{children:"timeStepWindow"})," of ",(0,s.jsx)(n.code,{children:"1"}),", the plugin will continue to accept it up to ",(0,s.jsx)(n.strong,{children:"12:00:59"})," (the \u201cnext\u201d 30-second step), preventing users from being locked out if their device clock is a few seconds off. Once the clock hits ",(0,s.jsx)(n.strong,{children:"12:01:00"}),", that previous code will be treated as expired."]}),"\n",(0,s.jsxs)(n.p,{children:["If you find users frequently encountering code mismatches due to clock drift, you can increase ",(0,s.jsx)(n.code,{children:"timeStepWindow"})," to ",(0,s.jsx)(n.code,{children:"2"}),". ",(0,s.jsx)(n.strong,{children:"However, be cautious: larger windows can reduce overall security!"})]}),"\n",(0,s.jsxs)(n.p,{children:["\u2757 With a ",(0,s.jsx)(n.code,{children:"timeStepWindow"})," set to ",(0,s.jsx)(n.code,{children:"0"}),", the plugin will pass all the expired codes, which is not secure and should only be used for testing purposes."]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Thats it! Two-Factor Authentication is now enabled:\n",(0,s.jsx)(n.img,{alt:"alt text",src:t(9454).A+"",width:"3700",height:"1932"})]}),"\n",(0,s.jsx)(n.h2,{id:"disabling-two-factor-authentication-locally",children:"Disabling Two-Factor Authentication locally"}),"\n",(0,s.jsxs)(n.p,{children:["If it is not convenient to enter the code every time you log in during local development, you can disable Two-Factor Authentication\nfor the dev environment using ",(0,s.jsx)(n.code,{children:"usersFilterToApply"})," option."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:"title='./index.ts'",children:"\n    plugins: [\n        new TwoFactorsAuthPlugin ({\n          twoFaSecretFieldName: 'secret2fa',\n//diff-add\n          usersFilterToApply: (adminUser: AdminUser) => {\n//diff-add\n            // if this method returns true, 2FA will be enforced for this user, if returns false - 2FA will be disabled\n//diff-add\n            if (process.env.NODE_ENV === 'development') {\n//diff-add\n              return false;\n//diff-add\n            }\n//diff-add\n            return true;\n//diff-add\n          },\n        }),\n    ],\n"})}),"\n",(0,s.jsx)(n.h2,{id:"select-which-users-should-use-two-factor-authentication",children:"Select which users should use Two-Factor Authentication"}),"\n",(0,s.jsx)(n.p,{children:"By default plugin enforces Two-Factor Authentication for all users."}),"\n",(0,s.jsxs)(n.p,{children:["If you wish to enforce 2FA only for specific users, you can again use ",(0,s.jsx)(n.code,{children:"usersFilterToApply"})," option:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:"title='./users.ts'",children:"  usersFilterToApply: (adminUser: AdminUser) => {\n    // disable 2FA for users which email is 'adminforth' or 'adminguest'\n    return !(['adminforth', 'adminguest'].includes(adminUser.dbUser.email));\n  },\n"})}),"\n",(0,s.jsx)(n.p,{children:"You can even add a boolean column to the user table to store whether the user should use 2FA or not:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:"title='./users.ts'",children:"{\n    resourceId: 'users',\n    ...\n    columns: [\n        ...\n        {\n            name: 'use2fa',\n        }\n        ...\n    ],\n    options: {\n      allowedActions: {\n        delete: ({ adminUser }: { adminUser: AdminUser }) => {\n          // only superadmin can delete users\n          return adminUser.dbUser.role === 'superadmin';\n        },\n        create: ({ adminUser }: { adminUser: AdminUser }) => {\n          // only superadmin can create users\n          return adminUser.dbUser.role === 'superadmin';\n        },\n        edit: ({ adminUser, meta }: { adminUser: AdminUser }) => {\n          // user can modify only his own record\n          const { oldRecord } = meta;\n          return adminUser.dbUser.id === oldRecord.id;\n        },\n      }\n    },\n    plugins: [\n        new TwoFactorsAuthPlugin ({\n          twoFaSecretFieldName: 'secret2fa',\n          usersFilterToApply: (adminUser: AdminUser) => {\n            return adminUser.dbUser.use2fa;\n          },\n        }),\n    ],\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"allow-specific-users-to-skip-two-factor-authentication-setup",children:"Allow Specific Users to Skip Two-Factor Authentication Setup"}),"\n",(0,s.jsx)(n.p,{children:"By default, all users are required to setup Two-Factor Authentication."}),"\n",(0,s.jsxs)(n.p,{children:["If you want to allow specific users to skip the 2FA setup, you can use the ",(0,s.jsx)(n.code,{children:"usersFilterToAllowSkipSetup"})," option:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:"title='./users.ts'",children:"...\nplugins: [\n        new TwoFactorsAuthPlugin ({\n          twoFaSecretFieldName: 'secret2fa',\n          ...\n        //diff-add\n          usersFilterToAllowSkipSetup: (adminUser: AdminUser) => {\n            //diff-add\n            // allow skip setup 2FA for users which email is 'adminforth' or 'adminguest'\n            //diff-add\n            return !(['adminforth', 'adminguest'].includes(adminUser.dbUser.email));\n            //diff-add\n          },\n        }),\n],\n...\n"})})]})}function u(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},9454:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/image-1-1aa4ed0aa37a198c7c9e14c981db42dd.png"},8453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>a});var i=t(6540);const s={},r=i.createContext(s);function o(e){const n=i.useContext(r);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);