"use strict";(self.webpackChunkadminforth=self.webpackChunkadminforth||[]).push([[4647],{42459:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>p,frontMatter:()=>r,metadata:()=>o,toc:()=>c});var a=s(74848),t=s(28453);const r={slug:"k3s-ec2-deployment",title:"IaC Simplified: K3s on EC2 Deployments with Terraform, Helm & Amazon ECR",authors:"kirilldorr",tags:["aws","terraform","helm","k3s"],description:"The ultimate step-by-step guide to cost-effective, build-time-efficient, and easy managable EC2 deployments using K3s, Terraform, Docker, and a Amazon ECR registry."},i=void 0,o={permalink:"/blog/k3s-ec2-deployment",source:"@site/blog/2025-11-04-k3s-ec2-deployment/index.md",title:"IaC Simplified: K3s on EC2 Deployments with Terraform, Helm & Amazon ECR",description:"The ultimate step-by-step guide to cost-effective, build-time-efficient, and easy managable EC2 deployments using K3s, Terraform, Docker, and a Amazon ECR registry.",date:"2025-11-04T00:00:00.000Z",tags:[{inline:!1,label:"AWS",permalink:"/blog/tags/aws",description:"Amazon Web Services (AWS) is a cloud computing platform that provides a wide range of services for building and deploying applications."},{inline:!1,label:"Terraform",permalink:"/blog/tags/terraform",description:"Terraform is an open-source infrastructure as code software tool created by HashiCorp that enables users to define and provision data center infrastructure using a declarative configuration language."},{inline:!1,label:"Helm",permalink:"/blog/tags/helm",description:"The package manager for Kubernetes"},{inline:!1,label:"k3s",permalink:"/blog/tags/k3s",description:"k3s is a lightweight version of k8s (kubernetes) that is also used for container orchestration but uses fewer resources."}],readingTime:13.825,hasTruncateMarker:!0,authors:[{name:"Kyrylo Doropii",title:"DevOps Engineer of AdminForth",url:"https://github.com/kirilldorr",imageURL:"https://avatars.githubusercontent.com/u/181721742?s=96&v=4",key:"kirilldorr"}],frontMatter:{slug:"k3s-ec2-deployment",title:"IaC Simplified: K3s on EC2 Deployments with Terraform, Helm & Amazon ECR",authors:"kirilldorr",tags:["aws","terraform","helm","k3s"],description:"The ultimate step-by-step guide to cost-effective, build-time-efficient, and easy managable EC2 deployments using K3s, Terraform, Docker, and a Amazon ECR registry."},unlisted:!1,nextItem:{title:"How to set up Context7 MCP in Visual Studio Code",permalink:"/blog/context7-setup-vscode"}},l={authorsImageUrls:[void 0]},c=[{value:"Why exactly K3s?",id:"why-exactly-k3s",level:2},{value:"How we will store containers?",id:"how-we-will-store-containers",level:2},{value:"Step 1 - create a SSH keypair",id:"step-1---create-a-ssh-keypair",level:2},{value:"Step 2 - create key pairs",id:"step-2---create-key-pairs",level:2},{value:"Step 3 - .gitignore file",id:"step-3---gitignore-file",level:2},{value:"Step 4 - file with secrets for local deploy",id:"step-4---file-with-secrets-for-local-deploy",level:2},{value:"Step 5 - Terraform folder",id:"step-5---terraform-folder",level:2},{value:"Step 6 - Helm",id:"step-6---helm",level:3},{value:"Step 7 - Provider Helm",id:"step-7---provider-helm",level:3},{value:"Step 8 - Control Helm",id:"step-8---control-helm",level:3},{value:"step 9 - ES2 settings instantiation",id:"step-9---es2-settings-instantiation",level:3},{value:"Step 10 - Configure AWS Profile",id:"step-10---configure-aws-profile",level:3},{value:"Step 11 - Run deployment",id:"step-11---run-deployment",level:3},{value:"All done!",id:"all-done",level:3}];function d(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.p,{children:"This guide shows how to deploy own Docker apps (with AdminForth as example) to Amazon EC2 instance with K3s and Terraform involving pushing images into Amazon ECR."}),"\n",(0,a.jsx)(n.p,{children:"Needed resources:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["AWS account where we will auto-spawn EC2 instance. We will use ",(0,a.jsx)(n.code,{children:"t3a.small"})," instance (2 vCPUs, 2GB RAM) which costs ",(0,a.jsx)(n.code,{children:"~14$"})," per month in ",(0,a.jsx)(n.code,{children:"us-west-2"})," region (cheapest region). Also it will take ",(0,a.jsx)(n.code,{children:"$2"})," per month for EBS gp2 storage (20GB) for EC2 instance."]}),"\n",(0,a.jsxs)(n.li,{children:["Also AWS ECR will charge for ",(0,a.jsx)(n.code,{children:"$0.09"})," per GB of data egress traffic (from EC2 to the internet) - this needed to load docker build cache."]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"The setup shape:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Build is done using IaaC approach with HashiCorp Terraform, so almoast no manual actions are needed from you. Every resource including EC2 server instance is described in code which is commited to repo."}),"\n",(0,a.jsx)(n.li,{children:"Docker build process is done on GitHub actions server, so EC2 server is not overloaded with builds"}),"\n",(0,a.jsx)(n.li,{children:"Docker images and build cache are stored on Amazon ECR"}),"\n",(0,a.jsx)(n.li,{children:"Total build time for average commit to AdminForth app (with Vite rebuilds) is around 3 minutes."}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"why-exactly-k3s",children:"Why exactly K3s?"}),"\n",(0,a.jsx)(n.p,{children:"Previously, our blog featured posts about different types of application deployment, but without the use of Kubernetes. This post will look at the cheapest option for deploying an application using k3s (a lightweight version of k8s Kubernetes). This option is more interesting than most of the alternatives, primarily because of its automation and scalability (it is, of course, inferior to the \u201colder\u201d K8s, but it also requires significantly fewer resources)."}),"\n",(0,a.jsx)(n.h2,{id:"how-we-will-store-containers",children:"How we will store containers?"}),"\n",(0,a.jsx)(n.p,{children:"The ECR repository will be used for storage. Since we are working with AWS, this is the most reliable option. The image must be assembled from local files on the machine and then sent to the Amazon server. All instructions for performing these actions will be provided below."}),"\n",(0,a.jsx)(n.h1,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,a.jsx)(n.p,{children:"I will assume you run Ubuntu (Native or WSL2)."}),"\n",(0,a.jsx)(n.p,{children:"You should have terraform, here is official repository:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'wget -O - https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg\necho "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list\nsudo apt update && sudo apt install terraform\n'})}),"\n",(0,a.jsx)(n.p,{children:"AWS CLI:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"sudo snap install aws-cli --classic\n"})}),"\n",(0,a.jsx)(n.p,{children:"HELM:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'curl https://baltocdn.com/helm/signing.asc | sudo tee /etc/apt/trusted.gpg.d/helm.asc\nsudo apt-get install apt-transport-https --yes\necho "deb https://baltocdn.com/helm/stable/debian/ all main" | sudo tee /etc/apt/sources.list.d/helm-stable-debian.list\nsudo apt-get install helm\n'})}),"\n",(0,a.jsx)(n.p,{children:"Also you need Doker Daemon running. We recommend Docker Desktop running. ON WSL2 make sure you have Docker Desktop WSL2 integration enabled."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"docker version\n"})}),"\n",(0,a.jsxs)(n.p,{children:["It is also worth having ",(0,a.jsx)(n.code,{children:"kubectl"})," locally on your machine for more convenient interaction with nodes and pods, but this is not mandatory."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"\n'})}),"\n",(0,a.jsx)(n.h1,{id:"practice---deploy-setup",children:"Practice - deploy setup"}),"\n",(0,a.jsxs)(n.p,{children:["Assume you have your AdminForth project in ",(0,a.jsx)(n.code,{children:"myadmin"}),"."]}),"\n",(0,a.jsx)(n.h2,{id:"step-1---create-a-ssh-keypair",children:"Step 1 - create a SSH keypair"}),"\n",(0,a.jsxs)(n.p,{children:["Make sure you are still in ",(0,a.jsx)(n.code,{children:"deploy"})," folder, run next command:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",metastring:'title="deploy"',children:'mkdir .keys && ssh-keygen -f .keys/id_rsa -N ""\n'})}),"\n",(0,a.jsxs)(n.p,{children:["Now it should create ",(0,a.jsx)(n.code,{children:"deploy/.keys/id_rsa"})," and ",(0,a.jsx)(n.code,{children:"deploy/.keys/id_rsa.pub"})," files with your SSH keypair. Terraform script will put the public key to the EC2 instance and will use private key to connect to the instance. Also you will be able to use it to connect to the instance manually."]}),"\n",(0,a.jsx)(n.h2,{id:"step-2---create-key-pairs",children:"Step 2 - create key pairs"}),"\n",(0,a.jsx)(n.p,{children:"I recommend doing this on the official AWS website. Go to EC2>Key pairs>Create key pair, name the new pair k3s-keys, and leave the default settings. Then move the downloaded .pem file to the myadmin/deploy/.keys directory."}),"\n",(0,a.jsx)(n.h2,{id:"step-3---gitignore-file",children:"Step 3 - .gitignore file"}),"\n",(0,a.jsxs)(n.p,{children:["Create ",(0,a.jsx)(n.code,{children:"deploy/.gitignore"})," file with next content:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:".terraform/\n.keys/\n*.tfstate\n*.tfstate.*\n*.tfvars\ntfplan\n.env.secrets.prod\nsa-dash.yaml\nsession-manager-plugin.deb\n.env.secrets.prod\n.terraform.lock.hcl\nk3s.yaml\n"})}),"\n",(0,a.jsx)(n.h2,{id:"step-4---file-with-secrets-for-local-deploy",children:"Step 4 - file with secrets for local deploy"}),"\n",(0,a.jsxs)(n.p,{children:["Create file ",(0,a.jsx)(n.code,{children:"deploy/.env.secrets.prod"})]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"ADMINFORTH_SECRET=<your_secret>\n"})}),"\n",(0,a.jsx)(n.h2,{id:"step-5---terraform-folder",children:"Step 5 - Terraform folder"}),"\n",(0,a.jsxs)(n.p,{children:["First of all install Terraform as described here ",(0,a.jsx)(n.a,{href:"https://developer.hashicorp.com/terraform/install#linux",children:"terraform installation"}),"."]}),"\n",(0,a.jsx)(n.p,{children:"After this create folder ../deploy/terraform"}),"\n",(0,a.jsxs)(n.p,{children:["Create file ",(0,a.jsx)(n.code,{children:"main.tf"})," in ",(0,a.jsx)(n.code,{children:"deploy"})," folder:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-hcl",metastring:'title="deploy/terraform/main.tf"',children:'\nterraform {\n  required_providers {\n    aws = {\n      source  = "hashicorp/aws"\n      version = "~> 5.0"\n    }\n  }\n\n}\n\nlocals {\n  aws_region           = "us-west-2"\n  vpc_cidr             = "10.0.0.0/16"\n  subnet_a_cidr        = "10.0.10.0/24"\n  subnet_b_cidr        = "10.0.11.0/24"\n  az_a                 = "us-west-2a"\n  az_b                 = "us-west-2b"\n  cluster_name         = "myappk3s"\n  app_name             = <your_app_name>\n  app_source_code_path = "../../"\n\n  app_container_port = 3500\n  service_port       = 80\n  admin_secret       = "your_secret"\n\n  ingress_ports = [\n    { from = 22, to = 22, protocol = "tcp", desc = "SSH" },\n    { from = 80, to = 80, protocol = "tcp", desc = "App HTTP (Traefik)" },\n    { from = 443, to = 443, protocol = "tcp", desc = "App HTTPS (Traefik)" },\n    { from = 6443, to = 6443, protocol = "tcp", desc = "Kubernetes API" }\n  ]\n}\n\nprovider "aws" {\n  region = local.aws_region\n}\n\nprovider "kubernetes" {\n  config_path = "../k3s.yaml"\n}\n\ndata "aws_ami" "ubuntu_22_04" {\n  most_recent = true\n  owners      = ["099720109477"] # Canonical ubuntu account ID\n\n  filter {\n    name   = "name"\n    values = ["ubuntu/images/hvm-ssd/ubuntu-jammy-22.04-amd64-server-*"]\n  }\n}\n\nresource "aws_instance" "k3s_server" {\n  instance_type = "t3a.small"\n  ami           = data.aws_ami.ubuntu_22_04.id\n\n  iam_instance_profile = aws_iam_instance_profile.k3s_instance_profile.name\n\n  subnet_id                   = aws_subnet.public_a.id\n  vpc_security_group_ids      = [aws_security_group.app_sg.id]\n  associate_public_ip_address = true\n  key_name                    = "k3s-keys"\n\n  tags = {\n    Name = local.cluster_name\n  }\n\n  depends_on = [\n    null_resource.docker_build_and_push\n  ]\n\n  user_data = templatefile("../user_data.sh.tpl", {\n    app_name           = local.app_name\n    aws_region         = local.aws_region\n    admin_secret       = local.admin_secret\n    app_container_port = local.app_container_port\n    service_port       = local.service_port\n    ecr_registry_id    = aws_ecr_repository.app_repo.registry_id\n    ecr_image_full     = "${aws_ecr_repository.app_repo.repository_url}:latest"\n    }\n  )\n\n  # prevent accidental termination of ec2 instance and data loss\n  lifecycle {\n    #create_before_destroy = true       #uncomment in production\n    #prevent_destroy       = true       #uncomment in production\n    ignore_changes = [ami]\n  }\n\n  root_block_device {\n    volume_size = 10 // Size in GB for root partition\n    volume_type = "gp2"\n\n    # Even if the instance is terminated, the volume will not be deleted, delete it manually if needed\n    delete_on_termination = true #change to false in production if data persistence is needed\n  }\n\n}\n\nresource "null_resource" "get_kubeconfig" {\n  depends_on = [aws_instance.k3s_server]\n\n  provisioner "local-exec" {\n    command     = <<-EOT\n      set -e\n      for i in {1..15}; do\n        if nc -z ${aws_instance.k3s_server.public_ip} 22; then\n          break\n        fi\n        sleep 5\n      done\n\n      for i in {1..15}; do\n        scp -q -o StrictHostKeyChecking=no -i ../.keys/k3s-keys.pem \\\n          ubuntu@${aws_instance.k3s_server.public_dns}:/home/ubuntu/k3s.yaml ../k3s.yaml && {\n            sleep 5\n            exit 0\n          }\n\n        echo "k3s.yaml not found yet (attempt $i/15), retrying in 10s..."\n        sleep 10\n      done\n    EOT\n    interpreter = ["/bin/bash", "-c"]\n  }\n}\n'})}),"\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsxs)(n.p,{children:["\ud83d\udc46 Replace ",(0,a.jsx)(n.code,{children:"<your_app_name>"})," with your app name (no spaces, only underscores or letters)"]}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["We will also need a file ",(0,a.jsx)(n.code,{children:"container.tf"})]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-hcl",metastring:'title="deploy/terraform/container.tf"',children:'\nresource "aws_ecr_repository" "app_repo" {\n  name = local.app_name\n\n  image_tag_mutability = "MUTABLE"\n  image_scanning_configuration {\n    scan_on_push = true\n  }\n  force_delete = true\n}\n\ndata "aws_caller_identity" "current" {}\n\nresource "null_resource" "docker_build_and_push" {\n\n  depends_on = [aws_ecr_repository.app_repo]\n\n  provisioner "local-exec" {\n    command = <<-EOT\n      set -e\n      unset DOCKER_HOST\n      \n      REPO_URL="${aws_ecr_repository.app_repo.repository_url}"\n      ACCOUNT_ID="${data.aws_caller_identity.current.account_id}"\n      REGION="${local.aws_region}"\n      \n      echo "LOG: Logging in to ECR..."\n      aws ecr get-login-password --region $${REGION} | docker login --username AWS --password-stdin $${ACCOUNT_ID}.dkr.ecr.$${REGION}.amazonaws.com\n      \n      echo "LOG: Building Docker image..."\n      docker -H unix:///var/run/docker.sock build --pull -t $${REPO_URL}:latest ${local.app_source_code_path}\n\n      echo "LOG: Pushing image to ECR..."\n      docker -H unix:///var/run/docker.sock push $${REPO_URL}:latest\n\n      echo "LOG: Build and push complete."\n    EOT\n\n    interpreter = ["/bin/bash", "-c"]\n  }\n}\n'})}),"\n",(0,a.jsx)(n.p,{children:"This file contains a script that builds the Docker image locally. This is done for more flexible deployment. When changing the program code, there is no need to manually update the image on EC2 or in the repository. It is updated automatically with each terraform apply. Below is a table showing the time it takes to build this image from scratch and with minimal changes."}),"\n",(0,a.jsxs)(n.table,{children:[(0,a.jsx)(n.thead,{children:(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.th,{children:"Feature"}),(0,a.jsx)(n.th,{children:"Time"})]})}),(0,a.jsxs)(n.tbody,{children:[(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"Initial build time*"}),(0,a.jsx)(n.td,{children:"0m45.445s"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"Rebuild time (changed index.ts)*"}),(0,a.jsx)(n.td,{children:"0m26.757s"})]})]})]}),"\n",(0,a.jsx)("sub",{children:"* All tests done from local machine (Intel(R) Core(TM) i7 9760H, Docker Desktop/Ubuntu 32 GB RAM, 300Mbps up/down) up to working state"}),"\n",(0,a.jsxs)(n.p,{children:["Also, ",(0,a.jsx)(n.code,{children:"resvpc.tf"})]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-hcl",metastring:'title="deploy/terraform/resvpc.tf"',children:'resource "aws_vpc" "main" {\n  cidr_block = local.vpc_cidr\n\n  enable_dns_support   = true\n  enable_dns_hostnames = true\n\n  tags = { Name = "main-vpc" }\n}\n\nresource "aws_subnet" "public_a" {\n  vpc_id                  = aws_vpc.main.id\n  cidr_block              = local.subnet_a_cidr\n  map_public_ip_on_launch = true\n  availability_zone       = local.az_a\n  tags = {\n    Name = "public-a"\n  }\n}\n\nresource "aws_subnet" "public_b" {\n  vpc_id                  = aws_vpc.main.id\n  cidr_block              = local.subnet_b_cidr\n  map_public_ip_on_launch = true\n  availability_zone       = local.az_b\n  tags = {\n    Name = "public-b"\n  }\n}\n\nresource "aws_internet_gateway" "igw" {\n  vpc_id = aws_vpc.main.id\n  tags   = { Name = "main-igw" }\n}\n\nresource "aws_route_table" "public_rt" {\n  vpc_id = aws_vpc.main.id\n  route {\n    cidr_block = "0.0.0.0/0"\n    gateway_id = aws_internet_gateway.igw.id\n  }\n  tags = { Name = "public-rt" }\n}\n\nresource "aws_route_table_association" "public_a_assoc" {\n  subnet_id      = aws_subnet.public_a.id\n  route_table_id = aws_route_table.public_rt.id\n}\n\nresource "aws_route_table_association" "public_b_assoc" {\n  subnet_id      = aws_subnet.public_b.id\n  route_table_id = aws_route_table.public_rt.id\n}\n\nresource "aws_security_group" "app_sg" {\n  name   = "app-sg-k3s"\n  vpc_id = aws_vpc.main.id\n\n  dynamic "ingress" {\n    for_each = local.ingress_ports\n    content {\n      from_port   = ingress.value.from\n      to_port     = ingress.value.to\n      protocol    = ingress.value.protocol\n      cidr_blocks = ["0.0.0.0/0"]\n      description = ingress.value.desc\n    }\n  }\n\n  egress {\n    from_port   = 0\n    to_port     = 0\n    protocol    = "-1"\n    cidr_blocks = ["0.0.0.0/0"]\n  }\n}\n\nresource "aws_iam_role" "k3s_node_role" {\n  name = "k3s-node-role"\n  assume_role_policy = jsonencode({\n    Version = "2012-10-17"\n    Statement = [{\n      Effect    = "Allow"\n      Principal = { Service = "ec2.amazonaws.com" }\n      Action    = "sts:AssumeRole"\n    }]\n  })\n}\n\nresource "aws_iam_role_policy_attachment" "ecr_read_only_attach" {\n  policy_arn = "arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly"\n  role       = aws_iam_role.k3s_node_role.name\n}\n\nresource "aws_iam_role_policy_attachment" "ssm_core_policy" {\n  policy_arn = "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore"\n  role       = aws_iam_role.k3s_node_role.name\n}\n\nresource "aws_iam_instance_profile" "k3s_instance_profile" {\n  name = "k3s-instance-profile"\n  role = aws_iam_role.k3s_node_role.name\n}\n'})}),"\n",(0,a.jsxs)(n.p,{children:["And ",(0,a.jsx)(n.code,{children:"outputs.tf"})]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-hcl",metastring:'title="deploy/terraform/outputs.tf"',children:'\noutput "app_endpoint" {\n  value = "http://${aws_instance.k3s_server.public_dns}"\n}\n\noutput "kubectl_config_command" {\n  value = "scp -i .keys/k3s-keys.pem ubuntu@${aws_instance.k3s_server.public_dns}:/home/ubuntu/k3s.yaml ~/.kube/config-k3s && export KUBECONFIG=~/.kube/config-k3s"\n}\n\noutput "ssh_connect_command" {\n  value = "ssh -i .keys/k3s-keys.pem ubuntu@${aws_instance.k3s_server.public_dns}"\n}\n\noutput "instance_public_ip" {\n  value = aws_instance.k3s_server.public_ip\n}\n\noutput "ecr_repository_url" {\n  value = aws_ecr_repository.app_repo.repository_url\n}\n\nresource "null_resource" "output_to_file" {\n  provisioner "local-exec" {\n    command = "terraform output -json > ../terraform_outputs.json"\n  }\n  depends_on = [null_resource.get_kubeconfig]\n}\n'})}),"\n",(0,a.jsx)(n.h3,{id:"step-6---helm",children:"Step 6 - Helm"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"Helm"})," is a command-line tool and a set of libraries that helps manage applications in Kubernetes."]}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"Helm Chart (Chart)"})," is a package containing everything needed to run an application in Kubernetes. It's the equivalent of ",(0,a.jsx)(n.code,{children:"apt"})," or ",(0,a.jsx)(n.code,{children:"yum"})," packages in Linux."]}),"\n",(0,a.jsx)(n.p,{children:"A chart has this structure:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"helm_charts/\n\u251c\u2500\u2500 Chart.yaml        # Metadata about the chart (name, version)\n\u251c\u2500\u2500 values.yaml       # Default values (configuration)\n\u2514\u2500\u2500 templates/        # Folder with Kubernetes templates (YAML files)\n    \u251c\u2500\u2500 deployment.yaml\n    \u251c\u2500\u2500 service.yaml\n    \u251c\u2500\u2500 ingress.yaml\n    \u2514\u2500\u2500 ...\n"})}),"\n",(0,a.jsx)(n.h3,{id:"step-7---provider-helm",children:"Step 7 - Provider Helm"}),"\n",(0,a.jsx)(n.p,{children:"Now we need to create .../deploy/helm and .../deploy/helm/helm_charts folders"}),"\n",(0,a.jsxs)(n.p,{children:["you need to create a file ",(0,a.jsx)(n.code,{children:"Chart.yaml"})," in it"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",metastring:'title="deploy/helm/helm_charts/Chart.yaml"',children:'apiVersion: v2\nname: myappk3s\ndescription: Helm chart for myadmin app\nversion: 0.1.0\nappVersion: "1.0.0"\n'})}),"\n",(0,a.jsxs)(n.p,{children:["And ",(0,a.jsx)(n.code,{children:"values.yaml"})]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",metastring:'title="deploy/helm/helm_charts/values.yaml"',children:'appName: myappk3s\ncontainerPort: 3500\nservicePort: 80\nadminSecret: "your_secret"\n'})}),"\n",(0,a.jsx)(n.p,{children:"After this create .../deploy/helm/helm_charts/templates folder"}),"\n",(0,a.jsx)(n.p,{children:"And create files here:"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.code,{children:"deployment.yaml"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",metastring:'title="deploy/helm/helm_charts/templates/deployment.yaml"',children:'apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: {{ .Values.appName }}-deployment\n  namespace: {{ .Values.appName }}\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: {{ .Values.appName }}\n  template:\n    metadata:\n      labels:\n        app: {{ .Values.appName }}\n    spec:\n      containers:\n      - name: {{ .Values.appName }}\n        image: "{{ .Values.ecrImageFull }}" \n        ports:\n        - containerPort: {{ .Values.containerPort }}\n        env:\n        - name: "ADMINFORTH_SECRET"\n          value: "{{ .Values.adminSecret }}"\n'})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.code,{children:"ingress.yaml"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",metastring:'title="deploy/helm/helm_charts/templates/ingress.yaml"',children:"apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: {{ .Values.appName }}-ingress\n  namespace: {{ .Values.appName }}\nspec:\n  rules:\n  - http:\n      paths:\n      - path: /\n        pathType: Prefix\n        backend:\n          service:\n            name: {{ .Values.appName }}-service\n            port:\n              number: {{ .Values.servicePort }}\n"})}),"\n",(0,a.jsxs)(n.p,{children:["And ",(0,a.jsx)(n.code,{children:"service.yaml"})]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",metastring:'title="deploy/helm/helm_charts/templates/service.yaml"',children:"apiVersion: v1\nkind: Service\nmetadata:\n  name: {{ .Values.appName }}-service\n  namespace: {{ .Values.appName }}\nspec:\n  type: ClusterIP\n  selector:\n    app: {{ .Values.appName }}\n  ports:\n  - port: {{ .Values.servicePort }}\n    targetPort: {{ .Values.containerPort }}\n\n"})}),"\n",(0,a.jsx)(n.h3,{id:"step-8---control-helm",children:"Step 8 - Control Helm"}),"\n",(0,a.jsxs)(n.p,{children:["For controlling helm we also use terraform, so we need to create one more folder ../deploy/helm/terraform\nAnd inside it are the files: ",(0,a.jsx)(n.code,{children:"main.tf"}),", ",(0,a.jsx)(n.code,{children:"outputs.tf"}),", ",(0,a.jsx)(n.code,{children:"variables.tf"}),", ",(0,a.jsx)(n.code,{children:"terraform.tfvars"}),"."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-hcl",metastring:'title="deploy/helm/terraform/main.tf"',children:'terraform {\n  required_providers {\n    aws = {\n      source  = "hashicorp/aws"\n      version = "~> 5.0"\n    }\n    kubernetes = {\n      source  = "hashicorp/kubernetes"\n      version = ">= 2.0.0, < 3.0.0"\n    }\n    helm = {\n      source  = "hashicorp/helm"\n      version = ">= 3.0.0"\n    }\n  }\n}\n\nprovider "kubernetes" {\n  config_path = "../../k3s.yaml"\n}\n\nprovider "helm" {\n  kubernetes = {\n    config_path = "../../k3s.yaml"\n  }\n}\n\ndata "local_file" "config_file" {\n  filename = "../../terraform_outputs.json"\n}\n\nlocals {\n  config = jsondecode(data.local_file.config_file.content)\n}\n\nresource "kubernetes_namespace" "myappk3s" {\n  metadata {\n    name = "myappk3s"\n\n    labels = {\n      "app.kubernetes.io/managed-by" = "Helm"\n    }\n\n    annotations = {\n      "meta.helm.sh/release-name"      = "myapp"\n      "meta.helm.sh/release-namespace" = "myappk3s"\n    }\n  }\n}\n\nresource "helm_release" "myapp" {\n  name             = "myapp"\n  chart            = "../helm_charts"\n  namespace        = kubernetes_namespace.myappk3s.metadata.0.name\n  create_namespace = false\n\n  set = [\n    {\n      name  = "ecrImageFull"\n      value = local.config.ecr_repository_url.value\n    },\n    {\n      name  = "image.tag"\n      value = "latest"\n    },\n    {\n      name  = "adminSecret"\n      value = var.admin_secret\n    },\n    {\n      name  = "ingress.enabled"\n      value = "true"\n    },\n    {\n      name  = "ingress.hosts[0].host"\n      value = "${local.config.instance_public_ip.value}.nip.io"\n    },\n    {\n      name  = "ingress.hosts[0].paths[0].path"\n      value = "/"\n    },\n    {\n      name  = "ingress.hosts[0].paths[0].pathType"\n      value = "Prefix"\n    },\n    {\n      name  = "appName"\n      value = var.cluster_name\n    }\n  ]\n  depends_on = [kubernetes_namespace.myappk3s]\n}\n'})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-hcl",metastring:'title="deploy/helm/terraform/variables.tf"',children:'variable "admin_secret" {\n  description = "Admin secret for the application"\n  type        = string\n}\n\nvariable "cluster_name" {\n  description = "The name of the cluster"\n  type        = string\n}\n\nvariable "app_name" {\n  type    = string\n  default = "myapp"\n}\n'})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-hcl",metastring:'title="deploy/helm/terraform/outputs.tf"',children:'data "local_file" "json_file" {\n  filename = "../../terraform_outputs.json"\n}\n\nlocals {\n  duplicated_json = jsondecode(data.local_file.json_file.content)\n}\n\noutput "ssh_connect_command" {\n  value = local.duplicated_json["ssh_connect_command"]["value"]\n}\n\noutput "kubectl_config_command" {\n  value = local.duplicated_json["kubectl_config_command"]["value"]\n}\n\noutput "app_endpoint" {\n  value = local.duplicated_json["app_endpoint"]["value"]\n}\n'})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-hcl",metastring:'title="deploy/helm/terraform/terraform.tfstate"',children:'admin_secret = "your_secret"\ncluster_name = "myappk3s"\napp_name     = "myapp"\n'})}),"\n",(0,a.jsx)(n.h3,{id:"step-9---es2-settings-instantiation",children:"step 9 - ES2 settings instantiation"}),"\n",(0,a.jsx)(n.p,{children:"The configuration will be performed using a small bash script."}),"\n",(0,a.jsxs)(n.p,{children:["Fot this step we need to return to ../deploy folder and create ",(0,a.jsx)(n.code,{children:"user_data.sh.tpl"})]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",metastring:'title="deploy/userdata.sh.tpl"',children:'#!/bin/bash -e\n\necho "LOG update apt..."\nexport DEBIAN_FRONTEND=noninteractive\napt-get update -y\n\necho "LOG Installing Docker&AWS CLI..."\napt-get install -y apt-transport-https ca-certificates curl gnupg lsb-release awscli\n\ncurl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg\n\necho "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null\n\napt-get update -y\napt-get install -y docker-ce docker-ce-cli containerd.io\n\necho "LOG Starting Docker..."\nsystemctl start docker\nsystemctl enable docker\nusermod -a -G docker ubuntu\n\nECR_REGISTRY="${ecr_registry_id}.dkr.ecr.${aws_region}.amazonaws.com"\n\necho "LOG Gettong ETC password..."\nECR_PASSWORD=""\nRETRY_COUNT=0\nMAX_RETRIES=12 \n\nuntil [ $RETRY_COUNT -ge $MAX_RETRIES ]; do\n  \n  ECR_PASSWORD=$(aws ecr get-login-password --region ${aws_region} 2>/dev/null)\n  if [ -n "$ECR_PASSWORD" ]; then\n    echo "LOG Successfull."\n    break\n  fi\n  RETRY_COUNT=$((RETRY_COUNT+1))\n  echo "LOG Retry (for 5s)..."\n  sleep 5\ndone\n\nif [ -z "$ECR_PASSWORD" ]; then\n  echo "LOG ERROR: Unable to retrieve ECR password after $MAX_RETRIES attempts."\n  exit 1\nfi\n\necho $ECR_PASSWORD | docker login --username AWS --password-stdin $ECR_REGISTRY\n\nif [ $? -ne 0 ]; then\n  echo "LOG ERROR: Docker login to ECR failed."\n  exit 1\nfi\necho "LOG Docker login successful."\n\necho "LOG Waiting for Docker socket..."\ntimeout 60 sh -c \'until docker info > /dev/null 2>&1; do echo "LOG Waiting for Docker socket..."; sleep 3; done\'\n\nif ! docker info > /dev/null 2>&1; then\n  echo "LOG ERROR: Docker socket not available after timeout."\n  exit 1\nfi\n\necho "LOG Turning off ufw..."\nufw disable || echo "LOG ufw not installed, skipping disable."\n\necho "LOG Retrieving public IP..."\nPUBLIC_IP=$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4)\n\necho "LOG Installing K3s \u0437 --tls-san=$${PUBLIC_IP}..."\ncurl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="--docker --tls-san $${PUBLIC_IP}" sh -\n\necho "LOG Waiting for k3s.yaml to be created..."\nSTART_TIME=$(date +%s)\nuntil [ -f /etc/rancher/k3s/k3s.yaml ]; do\n  CURRENT_TIME=$(date +%s)\n  if (( CURRENT_TIME - START_TIME > 300 )); then\n    echo "LOG ERROR: Timeout waiting for k3s.yaml."\n    echo "LOG k3s.yaml status check:"\n    systemctl status k3s.service || systemctl status k3s-server.service || echo "LOG Failed to get k3s service status"\n    echo "LOG Last 50 lines of k3s logs:"\n    journalctl -u k3s.service -n 50 --no-pager || journalctl -u k3s-server.service -n 50 --no-pager || echo "LOG Failed to get k3s logs"\n    exit 1\n  fi\n  echo "LOG Waiting for k3s.yaml... (passed $(( CURRENT_TIME - START_TIME )) seconds)"\n  sleep 5\ndone\n\necho "LOG k3s.yaml found."\n\necho "LOG Updating k3s.yaml with public IP..."\nsed -i "s/127.0.0.1/$${PUBLIC_IP}/g" /etc/rancher/k3s/k3s.yaml\n\necho "LOG Copying k3s.yaml to /home/ubuntu/k3s.yaml..."\ncp /etc/rancher/k3s/k3s.yaml /home/ubuntu/k3s.yaml\nchown ubuntu:ubuntu /home/ubuntu/k3s.yaml\n'})}),"\n",(0,a.jsx)(n.h3,{id:"step-10---configure-aws-profile",children:"Step 10 - Configure AWS Profile"}),"\n",(0,a.jsxs)(n.p,{children:["Open or create file ",(0,a.jsx)(n.code,{children:"~/.aws/credentials"})," and add (if not already there):"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ini",children:"[myaws]\naws_access_key_id = <your_access_key>\naws_secret_access_key = <your_secret_key>\n"})}),"\n",(0,a.jsx)(n.h3,{id:"step-11---run-deployment",children:"Step 11 - Run deployment"}),"\n",(0,a.jsxs)(n.p,{children:["All deployment-related actions are automated and recorded in the script in ",(0,a.jsx)(n.code,{children:"user_data.sh.tpl"}),", so no additional actions are required. To deploy the application, you only need to enter a few commands listed below and wait a few minutes. After that, you will be able to connect to the web application using the link you will receive in ",(0,a.jsx)(n.code,{children:"terraform_output"}),". Next, if you wish, you can add GitHub Actions. To do this, follow the instructions in ",(0,a.jsx)(n.a,{href:"https://adminforth.dev/blog/compose-aws-ec2-ecr-terraform-github-actions/#chellenges-when-you-build-on-ci",children:"our other post"}),"."]}),"\n",(0,a.jsx)(n.p,{children:"In ../deploy/terraform folder"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"terraform init\n"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"terraform apply -auto-approve\n"})}),"\n",(0,a.jsx)(n.p,{children:"Wait for terraform complete the creation of all resources and change directory"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"cd ../../helm/terraform\n"})}),"\n",(0,a.jsx)(n.p,{children:"And repeat the steps in this directory"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"terraform init\n"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"terraform apply -auto-approve\n"})}),"\n",(0,a.jsx)(n.h3,{id:"all-done",children:"All done!"}),"\n",(0,a.jsx)(n.p,{children:"Your application is now deployed on Amazon EC2 and available on the Internet."})]})}function p(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},28453:(e,n,s)=>{s.d(n,{R:()=>i,x:()=>o});var a=s(96540);const t={},r=a.createContext(t);function i(e){const n=a.useContext(r);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),a.createElement(r.Provider,{value:n},e.children)}}}]);