"use strict";(self.webpackChunkadminforth=self.webpackChunkadminforth||[]).push([[6998],{53995:(n,e,a)=>{a.r(e),a.d(e,{assets:()=>i,contentTitle:()=>r,default:()=>c,frontMatter:()=>o,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"tutorial/Plugins/background-jobs","title":"Background jobs","description":"BackgroundJobsPlugin adds a durable background-job system to AdminForth. Jobs are stored in your data store (via a resource), executed by registered handlers, and automatically resumed after server restarts.","source":"@site/docs/tutorial/08-Plugins/23-background-jobs.md","sourceDirName":"tutorial/08-Plugins","slug":"/tutorial/Plugins/background-jobs","permalink":"/docs/tutorial/Plugins/background-jobs","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":23,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Many2Many","permalink":"/docs/tutorial/Plugins/many2many"},"next":{"title":"Upload","permalink":"/docs/tutorial/Plugins/05-0-upload"}}');var s=a(74848),d=a(28453);const o={},r="Background jobs",i={},l=[{value:"Setup",id:"setup",level:2},{value:"Usage",id:"usage",level:2},{value:"Custom job state renderer",id:"custom-job-state-renderer",level:2}];function u(n){const e={code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,d.R)(),...n.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.header,{children:(0,s.jsx)(e.h1,{id:"background-jobs",children:"Background jobs"})}),"\n",(0,s.jsx)(e.p,{children:"BackgroundJobsPlugin adds a durable background-job system to AdminForth. Jobs are stored in your data store (via a resource), executed by registered handlers, and automatically resumed after server restarts."}),"\n",(0,s.jsx)(e.h2,{id:"setup",children:"Setup"}),"\n",(0,s.jsx)(e.p,{children:"First, install the plugin:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"npm i @adminforth/background-jobs\n"})}),"\n",(0,s.jsx)(e.p,{children:"and create a resource for jobs:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",metastring:'title="./resources/jobs.ts"',children:"import AdminForth, { AdminForthDataTypes } from 'adminforth';\nimport type { AdminForthResourceInput, AdminUser } from 'adminforth';\nimport { randomUUID } from 'crypto';\nimport BackgroundJobsPlugin from '@adminforth/background-jobs';\n\nasync function allowedForSuperAdmin({ adminUser }: { adminUser: AdminUser }): Promise<boolean> {\n  return adminUser.dbUser.role === 'superadmin';\n}\n\nexport default {\n  dataSource: 'maindb',\n  table: 'jobs',\n  resourceId: 'jobs',\n  label: 'Jobs',\n  options: {\n    allowedActions: {\n      edit: allowedForSuperAdmin,\n      delete: allowedForSuperAdmin,\n    },\n  },\n  columns: [\n    {\n      name: 'id',\n      primaryKey: true,\n      type: AdminForthDataTypes.STRING,\n      fillOnCreate: ({ initialRecord, adminUser }) => randomUUID(),\n      showIn: {\n        edit: false,\n        create: false,\n      },\n    },\n    {\n      name: 'name',\n      type: AdminForthDataTypes.STRING,\n    },\n    {\n      name: 'created_at',\n      type: AdminForthDataTypes.DATETIME,\n      showIn: {\n        edit: false,\n        create: false,\n      },\n      fillOnCreate: ({ initialRecord, adminUser }) => (new Date()).toISOString(),\n    },\n    {\n      name: 'finished_at',\n      type: AdminForthDataTypes.DATETIME,\n      showIn: {\n        edit: false,\n        create: false,\n      },\n    },\n    {\n      name: 'started_by',\n      type: AdminForthDataTypes.STRING,\n      foreignResource: {\n        resourceId: 'adminuser',\n        searchableFields: [\"id\", \"email\"],\n      }\n    },\n    {\n      name: 'state',\n      type: AdminForthDataTypes.JSON,\n    },\n    {\n      name: 'progress',\n      type: AdminForthDataTypes.STRING,\n    },\n    {\n      name: 'status',\n      type: AdminForthDataTypes.STRING,\n      enum: [\n        {\n          label: 'IN_PROGRESS',\n          value: 'IN_PROGRESS',\n        },\n        {\n          label: 'DONE',\n          value: 'DONE',\n        },\n        {\n          label: 'DONE_WITH_ERRORS',\n          value: 'DONE_WITH_ERRORS',\n        },\n        {\n          label: 'CANCELLED',\n          value: 'CANCELLED',\n        }\n      ]\n    },\n    {\n      name: 'job_handler_name',\n      type: AdminForthDataTypes.STRING,\n    },\n  ],\n  plugins: [\n    new BackgroundJobsPlugin({\n      createdAtField: 'created_at',\n      finishedAtField: 'finished_at',\n      startedByField: 'started_by',\n      stateField: 'state',\n      progressField: 'progress',\n      statusField: 'status',\n      nameField: 'name',\n      jobHandlerField: 'job_handler_name',\n    })\n  ]\n} as AdminForthResourceInput;\n"})}),"\n",(0,s.jsx)(e.h2,{id:"usage",children:"Usage"}),"\n",(0,s.jsx)(e.p,{children:"The plugin saves tasks and keeps executing them even after a server restart, so you should register job task handlers at the start of the AdminForth application."}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",metastring:'title="./index.ts"',children:"  //diff-add\n  import BackgroundJobsPlugin from '@adminforth/background-jobs';\n  //diff-add\n  import jobs_resource from './resources/jobs.js';\n  \n  ...\n\n  resources: [\n    \n    ...\n\n    //diff-add\n    jobs_resource,\n\n    ...\n\n  ],\n\n  ...\n\n  admin.express.serve(app);\n\n  admin.discoverDatabases().then(async () => {\n    if (await admin.resource('adminuser').count() === 0) {\n      await admin.resource('adminuser').create({\n        email: 'adminforth',\n        password_hash: await AdminForth.Utils.generatePasswordHash('adminforth'),\n        role: 'superadmin',\n      });\n    }\n  });\n\n  //diff-add\n  const backgroundJobsPlugin = admin.getPluginByClassName<BackgroundJobsPlugin>('BackgroundJobsPlugin');\n  \n  //diff-add\n  backgroundJobsPlugin.registerTaskHandler({\n    //diff-add\n    // job handler name\n    //diff-add\n    jobHandlerName: 'example_job_handler',\n    //diff-add\n    //handler function\n    //diff-add\n    handler: async ({ setTaskStateField, getTaskStateField }) => {\n      //diff-add\n      const state = await getTaskStateField();\n      //diff-add\n      console.log('State of the task at the beginning of the job handler:', state);\n      //diff-add\n      await new Promise(resolve => setTimeout(resolve, 3000));\n      //diff-add\n      await setTaskStateField({[state.step]: `Step ${state.step} completed`});\n      //diff-add\n      const updatedState = await getTaskStateField();\n      //diff-add\n      console.log('State of the task after setting the new state in the job handler:', updatedState);\n      //diff-add\n    },\n    //diff-add\n    //limit of tasks, that are running in parallel\n    //diff-add\n    parallelLimit: 1\n    //diff-add\n  })\n\n  ...\n\n"})}),"\n",(0,s.jsx)(e.p,{children:"After registering a handler, you can create a job. For example:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",metastring:'title="./index.ts"',children:"\n  ...\n\n  if (fileURLToPath(import.meta.url) === path.resolve(process.argv[1])) {\n    const app = express();\n    app.use(express.json());\n\n    //diff-add\n    app.post(`${ADMIN_BASE_URL}/api/create-job/`,\n    //diff-add\n      admin.express.authorize(\n        //diff-add\n        async (req: any, res: any) => {\n          //diff-add\n          const backgroundJobsPlugin = admin.getPluginByClassName<BackgroundJobsPlugin>('default');\n          //diff-add\n          if (!backgroundJobsPlugin) {\n            //diff-add\n            res.status(404).json({ error: 'BackgroundJobsPlugin not found' });\n            //diff-add\n            return;\n            //diff-add\n          }\n          //diff-add\n          backgroundJobsPlugin.startNewJob(\n            //diff-add\n            'Example Job', //job name\n            //diff-add\n            req.adminUser, // adminuser\n            //diff-add\n            [\n              //diff-add\n              { state: { step: 1 } },\n              //diff-add\n              { state: { step: 2 } },\n              //diff-add\n              { state: { step: 3 } },\n              //diff-add\n              { state: { step: 4 } },\n              //diff-add\n              { state: { step: 5 } },\n              //diff-add\n              { state: { step: 6 } },\n              //diff-add\n            ], //initial tasks\n            //diff-add\n            'example_job_handler', //job handler name\n            //diff-add\n          )\n          //diff-add\n          res.json({ok: true, message: 'Job started' });\n          //diff-add\n        }\n        //diff-add\n      ),\n      //diff-add\n    );\n\n  ...\n\n"})}),"\n",(0,s.jsx)(e.h2,{id:"custom-job-state-renderer",children:"Custom job state renderer"}),"\n",(0,s.jsx)(e.p,{children:"There may be cases when you need to display the state of job tasks. For this, you can register a custom component."}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",metastring:'title="./custom/JobCustomComponent.vue"',children:"<template>\n  <div class=\"w-[1000px] h-[500px] bg-gray-100 rounded-lg p-4 flex flex-col items-center justify-center  \">\n    <Button class=\"h-10\" @click=\"loadTasks\">\n      Get Job Tasks\n    </Button>\n    {{ tasks }}\n  </div>\n</template>\n\n\n<script setup lang=\"ts\">\nimport { Button, JsonViewer } from '@/afcl';\nimport { onMounted, onUnmounted, ref } from 'vue';\nimport websocket from '@/websocket';\nimport type { AdminForthComponentDeclarationFull } from 'adminforth';\n\n\nconst tasks = ref<{state: Record<string, any>, status: string}[]>([]);\n\n\nconst props = defineProps<{\n  meta: any;\n  getJobTasks: (limit?: number, offset?: number) => Promise<{state: Record<string, any>, status: string}[]>;\n  job: {\n    id: string;\n    name: string;\n    status: 'IN_PROGRESS' | 'DONE' | 'DONE_WITH_ERRORS' | 'CANCELLED';\n    progress: number; // 0 to 100\n    createdAt: Date;\n    customComponent?: AdminForthComponentDeclarationFull; \n  };\n}>();\n\nconst loadTasks = async () => {\n  tasks.value = await props.getJobTasks(10, 0);\n  console.log('Loaded tasks for job:', tasks.value);\n}\n\n\nonMounted(async () => {\n  loadTasks();\n  websocket.subscribe(`/background-jobs-task-update/${props.job.id}`, (data: { taskIndex: number, status?: string, state?: Record<string, any> }) => {\n    console.log('Received WebSocket message for job:', data.status);\n    \n    if (data.state) {\n      tasks.value[data.taskIndex].state = data.state;\n    }\n    if (data.status) {\n      tasks.value[data.taskIndex].status = data.status;\n    }\n\n  });\n});\n\nonUnmounted(() => {\n  console.log('Unsubscribing from WebSocket for job:', props.job.id);\n  websocket.unsubscribe(`/background-jobs-task-update/${props.job.id}`);\n});\n\n\n<\/script>\n"})}),"\n",(0,s.jsx)(e.p,{children:"Now register this component explicitly:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",metastring:'title="./index.ts"',children:"export const admin = new AdminForth({\n  baseUrl: ADMIN_BASE_URL,\n  auth: {\n    usersResourceId: 'adminuser',\n    usernameField: 'email',\n    passwordHashField: 'password_hash',\n    rememberMeDuration: '30d', \n    loginBackgroundImage: 'https://images.unsplash.com/photo-1534239697798-120952b76f2b?q=80&w=3389&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D',\n    loginBackgroundPosition: '1/2',\n    loginPromptHTML: async () => { \n      const adminforthUserExists = await admin.resource(\"adminuser\").count(Filters.EQ('email', 'adminforth')) > 0;\n      if (adminforthUserExists) {\n        return \"Please use <b>adminforth</b> as username and <b>adminforth</b> as password\"\n      }\n    },\n  },\n\n  //diff-add\n  componentsToExplicitRegister: [\n    //diff-add\n    { \n      //diff-add\n      file: '@@/JobCustomComponent.vue',\n      //diff-add\n      meta: {\n        //diff-add\n        label: 'Job Custom Component',\n        //diff-add\n      }\n      //diff-add\n    }\n    //diff-add\n  ],\n  ...\n\n"})}),"\n",(0,s.jsx)(e.p,{children:"Finally, register this component alongside the job task handler:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",metastring:'title="./index.ts"',children:"  ...\n\n  const backgroundJobsPlugin = admin.getPluginByClassName<BackgroundJobsPlugin>('default');\n  \n  backgroundJobsPlugin.registerTaskHandler({\n    jobHandlerName: 'example_job_handler', // Handler name\n    handler: async ({ setTaskStateField, getTaskStateField }) => { //handler function\n      const state = await getTaskStateField();\n      console.log('State of the task at the beginning of the job handler:', state);\n      await new Promise(resolve => setTimeout(resolve, 3000));\n      await setTaskStateField({[state.step]: `Step ${state.step} completed`});\n      const updatedState = await getTaskStateField();\n      console.log('State of the task after setting the new state in the job handler:', updatedState);\n    },\n    parallelLimit: 1 //parallel tasks limit\n  })\n\n  //diff-add\n  backgroundJobsPlugin.registerTaskDetailsComponent({\n    //diff-add\n    jobHandlerName: 'example_job_handler', // Handler name\n    //diff-add\n    component: { \n      //diff-add\n      file: '@@/JobCustomComponent.vue'  //custom component for the job details\n      //diff-add\n    },\n    //diff-add\n  })\n\n\n\n"})})]})}function c(n={}){const{wrapper:e}={...(0,d.R)(),...n.components};return e?(0,s.jsx)(e,{...n,children:(0,s.jsx)(u,{...n})}):u(n)}},28453:(n,e,a)=>{a.d(e,{R:()=>o,x:()=>r});var t=a(96540);const s={},d=t.createContext(s);function o(n){const e=t.useContext(d);return t.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function r(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(s):n.components||s:o(n.components),t.createElement(d.Provider,{value:e},n.children)}}}]);