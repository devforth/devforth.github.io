"use strict";(self.webpackChunkadminforth=self.webpackChunkadminforth||[]).push([[7184],{4926:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>s,default:()=>h,frontMatter:()=>a,metadata:()=>o,toc:()=>d});const o=JSON.parse('{"id":"tutorial/deploy","title":"Deploy in Docker","description":"In general you can already run your index.ts file which we created in Getting Started","source":"@site/docs/tutorial/04-deploy.md","sourceDirName":"tutorial","slug":"/tutorial/deploy","permalink":"/docs/tutorial/deploy","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":4,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Websocket","permalink":"/docs/tutorial/Customization/websocket"},"next":{"title":"AdminForth Adapters","permalink":"/docs/tutorial/ListOfAdapters"}}');var r=t(4848),i=t(8453);const a={},s="Deploy in Docker",l={},d=[{value:"Dockerfile",id:"dockerfile",level:2},{value:"Building the image",id:"building-the-image",level:2},{value:"Automating deployments with CI",id:"automating-deployments-with-ci",level:2},{value:"Adding SSL (https) to AdminForth",id:"adding-ssl-https-to-adminforth",level:2},{value:"Subpath deployment",id:"subpath-deployment",level:2}];function c(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"deploy-in-docker",children:"Deploy in Docker"})}),"\n",(0,r.jsxs)(n.p,{children:["In general you can already run your ",(0,r.jsx)(n.code,{children:"index.ts"})," file which we created in ",(0,r.jsx)(n.a,{href:"/docs/tutorial/gettingStarted",children:"Getting Started"}),"\nwith ",(0,r.jsx)(n.code,{children:"ts-node"})," command in any node environment."]}),"\n",(0,r.jsx)(n.p,{children:"It will start the server on configured HTTP port and you can use any proxy like Traefik/Nginx to expose it to the internet and add SSL Layer."}),"\n",(0,r.jsx)(n.h2,{id:"dockerfile",children:"Dockerfile"}),"\n",(0,r.jsxs)(n.p,{children:["If you created your AdminForth application with ",(0,r.jsx)(n.code,{children:"adminforth create-app"})," command you already have a ",(0,r.jsx)(n.code,{children:"Dockerfile"})," in your project."]}),"\n",(0,r.jsx)(n.p,{children:"You can use it to build your AdminForth application in Docker container."}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.p,{children:["\u26a0\ufe0f Please note that ",(0,r.jsx)(n.code,{children:"Dockerfile"})," has ",(0,r.jsx)(n.code,{children:"npx adminforth bundle"})," command which pre-bundles your AdminForth SPA\nat build time. If you will remove it, your AdminForth application will still work, but will cause some downtime during app restart/redeploy because bundling will happen at runtime after you start the ",(0,r.jsx)(n.code,{children:"index.ts"})," file. When ",(0,r.jsx)(n.code,{children:"npx adminforth bundle"})," command is executed at build time, the call do ",(0,r.jsx)(n.code,{children:"bundleNow()"})," inside of ",(0,r.jsx)(n.code,{children:"index.ts"})," file will actually do nothing."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"building-the-image",children:"Building the image"}),"\n",(0,r.jsx)(n.p,{children:"Now you can build your image:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"docker build -t myadminapp .\n"})}),"\n",(0,r.jsx)(n.p,{children:"And run container with:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"docker run -p 3500:3500 \\\n  -e ADMINFORTH_SECRET=CHANGEME \\\n  -v $(pwd)/db:/code/db \\\n  myadminapp\n"})}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"-v $(pwd)/db:/code/db"})," is needed only if you are using SQLite database."]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["Now open your browser and go to ",(0,r.jsx)(n.code,{children:"http://localhost:3500"})," to see your AdminForth application running in Docker container."]}),"\n",(0,r.jsx)(n.h2,{id:"automating-deployments-with-ci",children:"Automating deployments with CI"}),"\n",(0,r.jsxs)(n.p,{children:["If you are looking for a professional way to deploy your AdminForth application, you can follow our blog post ",(0,r.jsx)(n.a,{href:"http://localhost:3000/blog/compose-aws-ec2-ecr-terraform-github-actions/",children:"how to deploy your AdminForth application with Terraform From GitHub actions"})]}),"\n",(0,r.jsx)(n.h2,{id:"adding-ssl-https-to-adminforth",children:"Adding SSL (https) to AdminForth"}),"\n",(0,r.jsx)(n.p,{children:"There are lots of ways today to put your application behind SSL gateway. You might simply put AdminForth instance behind free Cloudflare CDN, change 3500 port to 80 and Cloudflare will automatically add SSL layer and faster CDN for your application."}),"\n",(0,r.jsx)(n.p,{children:"However as a bonus here we will give you independent way to add free LetsEncrypt SSL layer to your AdminForth application."}),"\n",(0,r.jsxs)(n.p,{children:["In a folder which contains folder of your AdminForth application (e.g. ",(0,r.jsx)(n.code,{children:"adminforth-app"}),") create a file ",(0,r.jsx)(n.code,{children:"compose.yml"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",metastring:"title='./compose.yml'",children:'version: \'3.8\'\n\nservices:\n  traefik:\n    image: "traefik:v2.5"\n    command:\n      - "--api.insecure=true"\n      - "--providers.docker=true"\n      - "--entrypoints.web.address=:80"\n      - "--entrypoints.websecure.address=:443"\n      - "--certificatesresolvers.myresolver.acme.httpchallenge=true"\n      - "--certificatesresolvers.myresolver.acme.httpchallenge.entrypoint=web"\n      - "--certificatesresolvers.myresolver.acme.email=demo@devforth.io" #  \u261d\ufe0f replace with your email\n      - "--certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json"\n    ports:\n      - "80:80"\n      - "443:443"\n    volumes:\n      - "/var/run/docker.sock:/var/run/docker.sock:ro"\n      - "./letsencrypt:/letsencrypt"\n    labels:\n      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"\n      - "traefik.http.routers.http-catchall.rule=hostregexp(`{host:.+}`)"\n      - "traefik.http.routers.http-catchall.entrypoints=web"\n      - "traefik.http.routers.http-catchall.middlewares=redirect-to-https"\n      - "traefik.http.routers.http-catchall.tls=false"\n\n  adminforth:\n    build: ./adminforth-app\n    environment:\n      - NODE_ENV=production\n      - ADMINFORTH_SECRET=!CHANGEME! # \u261d\ufe0f replace with your secret\n    labels:\n      - "traefik.enable=true"\n      - "traefik.http.routers.adminforth.tls=true"\n      - "traefik.http.routers.adminforth.tls.certresolver=myresolver"\n      - "traefik.http.routers.adminforth.rule=PathPrefix(`/`)"\n      - "traefik.http.services.adminforth.loadbalancer.server.port=3500"\n      - "traefik.http.routers.adminforth.priority=1"\n    # needed only if you are using SQLite\n    volumes:\n      - db:/code/db\n\n# needed only if you are using SQLite\nvolumes:\n  db:\n\nnetworks:\n  default:\n    driver: bridge\n'})}),"\n",(0,r.jsx)(n.p,{children:"Now pull this compose file and all directories to your server and run:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"docker compose -p stack-my-app -f compose.yml up -d --build --remove-orphans --wait\n"})}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"\u261d\ufe0f You can also test this compose stack locally on your machine but SSL will not work,\nso locally you can ignore Chrome warning about SSL and test your AdminForth application."}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"subpath-deployment",children:"Subpath deployment"}),"\n",(0,r.jsxs)(n.p,{children:["If you want to deploy your AdminForth application to a sub-folder like ",(0,r.jsx)(n.code,{children:"https://mydomain.com/admin"})," you\nshould do the following:"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Open ",(0,r.jsx)(n.code,{children:"index.ts"})," file and change ",(0,r.jsx)(n.code,{children:"ADMIN_BASE_URL"})," constant to your subpath:"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",metastring:"title='./index.ts'",children:"//diff-remove\nconst ADMIN_BASE_URL = '';\n//diff-add\nconst ADMIN_BASE_URL = '/admin/';\n"})}),"\n",(0,r.jsxs)(n.ol,{start:"2",children:["\n",(0,r.jsxs)(n.li,{children:["Open ",(0,r.jsx)(n.code,{children:"compose.yml"})," file and change ",(0,r.jsx)(n.code,{children:"traefik.http.routers.adminforth.rule"})," to your subpath:"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yml",metastring:"title='./compose.yml'",children:'      ...\n       - "traefik.http.routers.adminforth.tls.certresolver=myresolver"\n//diff-remove\n      - "traefik.http.routers.adminforth.rule=PathPrefix(`/`)"\n//diff-add\n      - "traefik.http.routers.adminforth.rule=PathPrefix(`/admin/`)"\n'})}),"\n",(0,r.jsx)(n.p,{children:"Redeploy compose."}),"\n",(0,r.jsxs)(n.p,{children:["Now you can access your AdminForth application by going to ",(0,r.jsx)(n.code,{children:"https://mydomain.com/admin"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["If you want to automate the deployment process with CI follow ",(0,r.jsx)(n.a,{href:"https://devforth.io/blog/onlogs-open-source-simplified-web-logs-viewer-for-dockers/",children:"our docker - traefik guide"})]}),"\n",(0,r.jsx)(n.h1,{id:"nginx-version",children:"Nginx version"}),"\n",(0,r.jsx)(n.p,{children:"If you are using Nginx instead of traefik, here is siple proxy pass config:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'server {\n  listen 80;\n  server_name demo.adminforth.dev;\n\n  charset utf-8;\n  client_max_body_size 75M;\n\n  gzip on;\n  gzip_disable "msie6";\n  gzip_vary on;\n  gzip_proxied any;\n  gzip_comp_level 8;\n  gzip_buffers 16 8k;\n  gzip_http_version 1.1;\n  gzip_min_length 2000;\n  gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript application/vnd.ms-fontobject application/x-font-ttf font/opentype image/svg+xml image/x-icon;\n\n  location / {\n      proxy_read_timeout 220s;\n      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n      proxy_set_header Host $http_host;\n      proxy_redirect off;\n      proxy_pass http://127.0.0.1:3500;\n  }\n}\n'})}),"\n",(0,r.jsx)(n.h1,{id:"environment-variables-best-practices",children:"Environment variables best practices"}),"\n",(0,r.jsxs)(n.p,{children:["Use ",(0,r.jsx)(n.code,{children:".env"})," file for sensitive variables like ",(0,r.jsx)(n.code,{children:"OPENAI_API_KEY"})," locally."]}),"\n",(0,r.jsxs)(n.p,{children:["Use ",(0,r.jsx)(n.code,{children:".env.prod"})," and ",(0,r.jsx)(n.code,{children:".env.local"})," for non-sensitive variables which are different for production and local environemnts (like NODE_ENV, SOME_EXTERNAL_API_BASE, etc)."]}),"\n",(0,r.jsxs)(n.p,{children:["Sensitive variables like ",(0,r.jsx)(n.code,{children:"OPENAI_API_KEY"})," in production should be passed directly to docker container or use secrets from your vault."]}),"\n",(0,r.jsx)(n.h1,{id:"if-you-are-not-using-docker",children:"If you are not using Docker"}),"\n",(0,r.jsx)(n.p,{children:"You can actually ship your AdminForth application without Docker as well."}),"\n",(0,r.jsxs)(n.p,{children:["Most important thing is remember in such case is to use ",(0,r.jsx)(n.code,{children:"npx adminforth bundle"})," command after you installed node modules and before you do actual restart of your application to avoid downtimes."]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>s});var o=t(6540);const r={},i=o.createContext(r);function a(e){const n=o.useContext(i);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),o.createElement(i.Provider,{value:n},e.children)}}}]);