"use strict";(self.webpackChunkadminforth=self.webpackChunkadminforth||[]).push([[7865],{5191:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>o,default:()=>u,frontMatter:()=>i,metadata:()=>a,toc:()=>l});var s=n(4848),r=n(8453);const i={},o="Hooks",a={id:"tutorial/Customization/hooks",title:"Hooks",description:"Hooks are used to:",source:"@site/docs/tutorial/03-Customization/04-hooks.md",sourceDirName:"tutorial/03-Customization",slug:"/tutorial/Customization/hooks",permalink:"/docs/tutorial/Customization/hooks",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:4,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Virtual columns",permalink:"/docs/tutorial/Customization/virtualColumns"},next:{title:"Limiting actions access",permalink:"/docs/tutorial/Customization/limitingAccess"}},d={},l=[{value:"Modify the data before it is saved to the database",id:"modify-the-data-before-it-is-saved-to-the-database",level:2},{value:"Limiting access to user-related data",id:"limiting-access-to-user-related-data",level:2},{value:"List of entities",id:"list-of-entities",level:3},{value:"Dropdown list of foreignResource",id:"dropdown-list-of-foreignresource",level:3},{value:"Show entity",id:"show-entity",level:3},{value:"All hooks",id:"all-hooks",level:2}];function c(e){const t={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.h1,{id:"hooks",children:"Hooks"}),"\n",(0,s.jsx)(t.p,{children:"Hooks are used to:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"modify the data before it is saved to the database on create or update"}),"\n",(0,s.jsx)(t.li,{children:"execute something after data were saved or deleted"}),"\n",(0,s.jsx)(t.li,{children:"change the query before fetching items from the database"}),"\n",(0,s.jsx)(t.li,{children:"modify the fetched data before it is displayed in the list and show"}),"\n",(0,s.jsxs)(t.li,{children:["prevent the request to db depending on some condition (Better use ",(0,s.jsx)(t.a,{href:"/docs/tutorial/Customization/limitingAccess",children:"allowedActions"})," for this)"]}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"modify-the-data-before-it-is-saved-to-the-database",children:"Modify the data before it is saved to the database"}),"\n",(0,s.jsxs)(t.p,{children:["Let's add reference to ",(0,s.jsx)(t.code,{children:"adminUser"})," when user creates a new apartment:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-ts",metastring:"title='./resources/apartments.ts'",children:"// diff-add\nimport type { AdminUser } from  'adminforth';\n\n{\n  ...\n  resourceId: 'aparts',\n  columns: [\n    ...\n    {\n      name: 'realtor_id',\n      ...\n//diff-add\n      showIn: ['list', 'show', 'edit'], // don't even show this field in create\n      ...\n    },\n    ...\n  ],\n  ...\n//diff-add\n  hooks: {\n//diff-add\n    create: {\n//diff-add\n      beforeSave: async ({ adminUser, record }: { adminUser: AdminUser, record: any }) => {\n//diff-add\n        record.realtor_id = adminUser.dbUser.id;\n//diff-add\n        return { ok: true, record };\n//diff-add\n      }\n//diff-add\n    }\n//diff-add\n  }\n}\n"})}),"\n",(0,s.jsx)(t.h2,{id:"limiting-access-to-user-related-data",children:"Limiting access to user-related data"}),"\n",(0,s.jsx)(t.h3,{id:"list-of-entities",children:"List of entities"}),"\n",(0,s.jsx)(t.p,{children:"For example we can prevent the user to see Apartments created by other users. Superadmin user still can see all:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-ts",metastring:"title='./resources/apartments.ts'",children:'{\n  ...\n  hooks: {\n    list: {\n      beforeDatasourceRequest: async ({\n        query, adminUser, resource,\n      }: {\n        query: any; adminUser: AdminUser; resource: AdminForthResource;\n      }) => {\n        if (adminUser.dbUser.role === "superadmin") {\n          return { ok: true };\n        }\n        if (!query.filters || query.filters.length === 0) {\n          query.filters = [];\n        }\n        // skip existing realtor_id filter if it comes from UI Filters (right panel)\n        query.filters = query.filters.filter((filter: any) => filter.field !== "realtor_id");\n        query.filters.push({\n          field: "realtor_id",\n          value: adminUser.dbUser.id,\n          operator: "eq",\n        });\n        return { ok: true };\n      },\n    },\n  },\n}\n'})}),"\n",(0,s.jsx)(t.p,{children:"This hook will prevent the user to see Apartments created by other users in list, however user if will be able to discover\nthe apartment id, will be able to use show page to see the apartment details. Let's limit it as well:"}),"\n",(0,s.jsx)(t.h3,{id:"dropdown-list-of-foreignresource",children:"Dropdown list of foreignResource"}),"\n",(0,s.jsxs)(t.p,{children:["By default if there is ",(0,s.jsx)(t.code,{children:"foreignResource"})," like we use for demo on ",(0,s.jsx)(t.code,{children:"realtor_id"})," column, the filter will suggest a\nselect dropdown with list of all Realtors. This might be a leak to get id's of other users. Let's limit it:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-ts",metastring:"title='./resources/apartments.ts'",children:'{\n  ...\n  hooks: {\n    dropdownList: {\n      beforeDatasourceRequest: async ({ adminUser, query }: { adminUser: AdminUser, query: any }) => {\n        if (adminUser.dbUser.role !== "superadmin") {\n          query.filters = [{field: "id", value: adminUser.dbUser.id, operator: "eq"}];\n        };\n        return {\n          "ok": true,\n        };\n      }\n    },\n  },\n}\n'})}),"\n",(0,s.jsx)(t.p,{children:"In our case we limit the dropdown list to show only the current user, however you can use same sample to list only objects who are related to the current user in case if you will have relation configurations which require to show related objects which belongs to the current user."}),"\n",(0,s.jsx)(t.h3,{id:"show-entity",children:"Show entity"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-ts",metastring:"title='./resources/apartments.ts'",children:'{\n  ...\n  hooks: {\n    show: {\n      afterDatasourceResponse: async ({\n        adminUser, response,\n      }: {\n        adminUser: AdminUser; response: any;\n      }) => {\n        if (adminUser.dbUser.role === "superadmin") {\n          return { ok: true, response };\n        }\n        if (response[0].realtor_id.pk !== adminUser.dbUser.id) {\n          return { ok: false, error: "You are not allowed to see this record" };\n        }\n        return { ok: true, response };\n      }\n    }\n  }\n}\n'})}),"\n",(0,s.jsxs)(t.blockquote,{children:["\n",(0,s.jsxs)(t.p,{children:["\ud83d\udc46 Please note that we use ",(0,s.jsx)(t.code,{children:"response[0].realtor_id.pk"})," because this fiel has ",(0,s.jsx)(t.code,{children:"foreignResource"})," in column option is set\nOtherwise you would use  just ",(0,s.jsx)(t.code,{children:"response[0].realtor_id"})]}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"Important notice: when using hook to filter out list of items for list page or list of items on dropdown makes a lot of sense (because gives ability to change filter of database request), using hook for show page is not reasonable:"}),"\n",(0,s.jsxs)(t.p,{children:["First of all it sematicaly better aligns with using allowedActions interface. For this particular case you must use ",(0,s.jsx)(t.a,{href:"/docs/tutorial/Customization/limitingAccess#disable-showing-the-resource-based-on-owner",children:"allowedActions.show"})]}),"\n",(0,s.jsx)(t.p,{children:"Secondly limiting access from this hook will not prevent executing other hooks (e.g. beforeDatasourceRequest), when allowedActions check\nalways performed before any hooks and any database requests."}),"\n",(0,s.jsx)(t.h2,{id:"all-hooks",children:"All hooks"}),"\n",(0,s.jsxs)(t.p,{children:["Check all hooks in the ",(0,s.jsx)(t.a,{href:"/docs/api/types/Back/interfaces/AdminForthResource",children:"API reference"}),"."]})]})}function u(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},8453:(e,t,n)=>{n.d(t,{R:()=>o,x:()=>a});var s=n(6540);const r={},i=s.createContext(r);function o(e){const t=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),s.createElement(i.Provider,{value:t},e.children)}}}]);