"use strict";(self.webpackChunkadminforth=self.webpackChunkadminforth||[]).push([[8974],{8085:(n,e,i)=>{i.r(e),i.d(e,{assets:()=>r,contentTitle:()=>s,default:()=>p,frontMatter:()=>d,metadata:()=>a,toc:()=>l});var t=i(4848),o=i(8453);const d={},s="Plugin development guide",a={id:"tutorial/Advanced/plugin-development",title:"Plugin development guide",description:"Creating a plugin is a powerful way to extend AdminForth functionality.",source:"@site/docs/tutorial/06-Advanced/01-plugin-development.md",sourceDirName:"tutorial/06-Advanced",slug:"/tutorial/Advanced/plugin-development",permalink:"/docs/tutorial/Advanced/plugin-development",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:1,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Upload",permalink:"/docs/tutorial/Plugins/upload"}},r={},l=[{value:"Concepts",id:"concepts",level:2},{value:"Boilerplate",id:"boilerplate",level:2},{value:"Creating plugin logic",id:"creating-plugin-logic",level:2},{value:"Installation of plugin",id:"installation-of-plugin",level:2}];function c(n){const e={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",p:"p",pre:"pre",...(0,o.R)(),...n.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(e.h1,{id:"plugin-development-guide",children:"Plugin development guide"}),"\n",(0,t.jsx)(e.p,{children:"Creating a plugin is a powerful way to extend AdminForth functionality."}),"\n",(0,t.jsx)(e.h2,{id:"concepts",children:"Concepts"}),"\n",(0,t.jsx)(e.p,{children:"Every plugin is installed to resource."}),"\n",(0,t.jsx)(e.p,{children:"Main concept is pretty simple: every plugin simply does modification of AdminForth config which developer passed on AdminForth initialization."}),"\n",(0,t.jsx)(e.p,{children:"Plugin can modify both config of resource where it is installed or whole global config."}),"\n",(0,t.jsxs)(e.p,{children:["To perform modification plugin defines a method ",(0,t.jsx)(e.code,{children:"modifyResourceConfig"})," which accepts ",(0,t.jsx)(e.code,{children:"config"})," object. The ",(0,t.jsx)(e.code,{children:"modifyResourceConfig"})," method called after first config validation and preprocessing.\nAfter all plugins did modifications, AdminForth calls validation and preprocessing again second time to make sure all plugins did not screw up the config."]}),"\n",(0,t.jsx)(e.p,{children:"Also plugins can define custom components and custom APIs."}),"\n",(0,t.jsx)(e.h2,{id:"boilerplate",children:"Boilerplate"}),"\n",(0,t.jsx)(e.p,{children:"Let's create plugin which auto-completes text in strings"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"mkdir -p af-plugin-chatgpt\ncd af-plugin-chatgpt\nnpm init -y\ntouch index.ts\nnpm i --save-dev typescript @types/node\n"})}),"\n",(0,t.jsxs)(e.p,{children:["Edit ",(0,t.jsx)(e.code,{children:"package.json"}),":"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-json",metastring:"title='./af-plugin-chatgpt/package.json'",children:'{\n  ...\n//diff-remove\n  "main": "index.js",\n//diff-add\n  "main": "dist/index.js",\n//diff-add\n  "types": "dist/index.d.ts",\n//diff-add\n  "type": "module",\n  "scripts": {\n//diff-remove\n    "test": "echo \\"Error: no test specified\\" && exit 1",\n//diff-add\n    "build": "tsc && rsync -av --exclude \'node_modules\' custom dist/",\n  },\n}\n'})}),"\n",(0,t.jsx)(e.p,{children:"Install AdminForth for types and classes imports:"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"npm i adminforth --save\n"})}),"\n",(0,t.jsxs)(e.p,{children:["Now create plugin boilerplate in ",(0,t.jsx)(e.code,{children:"index.ts"}),":"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-ts",metastring:"title='./af-plugin-chatgpt/index.ts'",children:"\nimport { AdminForthResourcePages, IAdminForth, IHttpServer, AdminForthPlugin, AdminForthResourceColumn, AdminForthResource, AdminForthDataTypes  } from \"adminforth\";\nimport { PluginOptions } from './types.js';\n\n\nexport default class ChatGptPlugin extends AdminForthPlugin {\n  options: PluginOptions;\n\n  constructor(options: PluginOptions) {\n    super(options, import.meta.url);\n    this.options = options;\n  }\n\n  async modifyResourceConfig(adminforth: IAdminForth, resourceConfig: AdminForthResource) {\n    super.modifyResourceConfig(adminforth, resourceConfig);\n    this.resourceConfig = resourceConfig;\n  \n    // simply modify resourceConfig or adminforth.config. You can get access to plugin options via this.options;\n  }\n  \n  validateConfigAfterDiscover(adminforth: IAdminForth, resourceConfig: AdminForthResource) {\n    // optional method where you can safely check field types after database discovery was performed\n  }\n\n  instanceUniqueRepresentation(pluginOptions: any) : string {\n    // optional method to return unique string representation of plugin instance. \n    // Needed if plugin can have multiple instances on one resource \n    return `single`;\n  }\n\n  setupEndpoints(server: IHttpServer) {\n    server.endpoint({\n      method: 'POST',\n      path: `/plugin/${this.pluginInstanceId}/example`,\n      handler: async ({ body }) => {\n        const { name } = body;\n        return { hey: `Hello ${name}` };\n      }\n    });\n  }\n\n}\n"})}),"\n",(0,t.jsxs)(e.p,{children:["Create ",(0,t.jsx)(e.code,{children:"types.ts"})," file:"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-ts",metastring:"title='./af-plugin-chatgpt/types.ts'",children:"\nexport interface PluginOptions {\n  \n}\n"})}),"\n",(0,t.jsxs)(e.p,{children:["Create ",(0,t.jsx)(e.code,{children:"./af-plugin-chatgpt/tsconfig.json"})," file:"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-json",metastring:"title='./af-plugin-chatgpt/tsconfig.json'",children:'{\n  "compilerOptions": {\n    "target": "es2016",                                  /* Set the JavaScript language version for emitted JavaScript and include*/ \n    "module": "node16",                                /* Specify what module code is generated. */\n    "outDir": "./dist",                                   /* Specify an output folder for all emitted files. */\n    "esModuleInterop": true,                             /* Emit additional JavaScript to ease support for importing CommonJS modules.  */\n    "forceConsistentCasingInFileNames": true,            /* Ensure that casing is correct in imports. */\n    "strict": false,                                     /* Enable all strict type-checking options. */\n    "skipLibCheck": true,                                 /* Skip type checking all .d.ts files. */\n  },\n  "exclude": ["node_modules", "dist", "custom"],           /* Exclude files from compilation. */\n}\n\n'})}),"\n",(0,t.jsx)(e.h2,{id:"creating-plugin-logic",children:"Creating plugin logic"}),"\n",(0,t.jsx)(e.p,{children:"In previous section we created boilerplate which is a must for every plugin.\nNow let's implement plugin logic."}),"\n",(0,t.jsx)(e.p,{children:"First of all we want one plugin installation to be able to set custom Vue component on create and edit pages."}),"\n",(0,t.jsxs)(e.p,{children:["In plugin options we will pass field name and ",(0,t.jsx)(e.code,{children:"OPENAI_API_KEY"}),"."]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-ts",metastring:"title='./af-plugin-chatgpt/types.ts'",children:"\nexport interface PluginOptions {\n\n//diff-add\n  /**\n//diff-add\n   * Field where plugin will auto-complete text. Should be string or text field.\n//diff-add\n   */\n//diff-add\n  fieldName: string;\n\n//diff-add\n  /**\n//diff-add\n   * OpenAI API key. Go to https://platform.openai.com/, go to Dashboard -> API keys -> Create new secret key\n//diff-add\n   * Paste value in your .env file OPENAI_API_KEY=your_key\n//diff-add\n   * Set openAiApiKey: process.env.OPENAI_API_KEY to access it\n//diff-add\n   */\n//diff-add\n  openAiApiKey: string;\n\n//diff-add\n  /**\n//diff-add\n   * Model name. Go to https://platform.openai.com/docs/models, select model and copy name.\n//diff-add\n   * Default is `gpt-3.5-turbo`. Use e.g. more expensive `gpt-4o` for more powerful model.\n//diff-add\n   */\n//diff-add\n  model?: string;\n\n//diff-add\n  /**\n//diff-add\n   * Expert settings\n//diff-add\n   */\n//diff-add\n  expert?: {\n\n//diff-add\n    /**\n//diff-add\n     * Number of tokens to generate. Default is 50. 1 token ~= \xbe words \n//diff-add\n     */\n//diff-add\n    maxTokens?: number;\n//diff-add\n  }\n\n\n}\n"})}),"\n",(0,t.jsx)(e.p,{children:"Now we have to create custom Vue component which will be used in plugin. To do it create custom folder:"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"mkdir -p af-plugin-chatgpt/custom\n"})}),"\n",(0,t.jsxs)(e.p,{children:["We will use ",(0,t.jsx)(e.code,{children:"vue-suggestion-input"})," package in our frontend component.\nTo install package into frontend component, first of all we have to initialize npm package in custom folder:"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"cd af-plugin-chatgpt/custom\nnpm init -y\n"})}),"\n",(0,t.jsx)(e.p,{children:"Now install our dependency:"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"npm i --save-dev vue-suggestion-input \n"})}),"\n",(0,t.jsxs)(e.p,{children:["Create file ",(0,t.jsx)(e.code,{children:"completionInput.vue"}),":"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-html",metastring:"title='./af-plugin-chatgpt/custom/completionInput.vue'",children:"<template>\n  <SuggestionInput \n    class=\"bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 \n      focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400\n      dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500 whitespace-normal\"\n      v-model=\"currentValue\"\n      :type=\"column.type\"\n      :completionRequest=\"complete\"\n      :debounceTime=\"meta.debounceTime\"\n    />\n</template>\n\n<script setup lang=\"ts\">\nimport { ref, onMounted, watch, Ref  } from 'vue';\nimport { callAdminForthApi } from '@/utils';\nimport { AdminForthColumn } from '@/types/AdminForthConfig';\nimport SuggestionInput from 'vue-suggestion-input';\nimport 'vue-suggestion-input/dist/style.css';\n\nconst props = defineProps<{\n  column: AdminForthColumn,\n  record: any,\n  meta: any,\n}>();\n\nconst emit = defineEmits([\n  'update:value',\n]);\n\nconst currentValue: Ref<string> = ref('');\n\nonMounted(() => {\n  currentValue.value = props.record[props.column.name] || '';\n});\n\nwatch(() => currentValue.value, (value) => {\n  emit('update:value', value);\n});\n\nwatch(() => props.record, (value) => {\n  currentValue.value = value[props.column.name] || '';\n});\n\nasync function complete() {\n  const res = await callAdminForthApi({\n      path: `/plugin/${props.meta.pluginInstanceId}/doComplete`,\n      method: 'POST',\n      body: {\n        record: props.record\n      },\n  });\n\n  return res.completion;\n}\n\n<\/script>\n\n"})}),"\n",(0,t.jsxs)(e.p,{children:["As you can see we call API endpoint ",(0,t.jsx)(e.code,{children:"/plugin/${props.meta.pluginInstanceId}/doComplete"})," to get completion."]}),"\n",(0,t.jsxs)(e.blockquote,{children:["\n",(0,t.jsx)(e.p,{children:"For all your API calls from your own plugins we recommend to use same url format which includes pluginInstanceId. This way you can be sure that your API calls are unique for each plugin installation."}),"\n"]}),"\n",(0,t.jsx)(e.p,{children:"Let's define API endpoint in our plugin:"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-ts",metastring:"title='./af-plugin-chatgpt/index.ts'",children:"  setupEndpoints(server: IHttpServer) {\n    server.endpoint({\n      method: 'POST',\n//diff-remove\n      path: `/plugin/${this.pluginInstanceId}/example`,\n//diff-add\n      path: `/plugin/${this.pluginInstanceId}/doComplete`,\n      handler: async ({ body }) => {\n//diff-remove\n        const { name } = body;\n//diff-remove\n        return { hey: `Hello ${name}` };\n//diff-add\n        const { record } = body;\n//diff-add\n        const recordNoField = {...record};\n//diff-add\n        delete recordNoField[this.options.fieldName];\n//diff-add\n        let currentVal = record[this.options.fieldName];\n//diff-add\n        const promptLimit = 500;\n//diff-add\n        if (currentVal && currentVal.length > promptLimit) {\n//diff-add\n          currentVal = currentVal.slice(-promptLimit);\n//diff-add\n        }\n//diff-add\n        const resLabel = this.resourceConfig.label;\n//diff-add\n        let content;\n//diff-add\n        if (currentVal) {\n//diff-add\n          content = `Continue writing for text/string field \"${this.options.fieldName}\" in the table \"${resLabel}\"\\n` +\n//diff-add\n              (Object.keys(recordNoField).length > 0 ? `Record has values for the context: ${JSON.stringify(recordNoField)}\\n` : '') +\n//diff-add\n              `Current field value: ${currentVal}\\n` +\n//diff-add\n              \"Don't talk to me. Just write text. No quotes. Don't repeat current field value, just write completion\\n\";\n//diff-add\n        } else {\n//diff-add\n          content = `Fill text/string field \"${this.options.fieldName}\" in the table \"${resLabel}\"\\n` +\n//diff-add\n              (Object.keys(recordNoField).length > 0 ? `Record has values for the context: ${JSON.stringify(recordNoField)}\\n` : '') +\n//diff-add\n              \"Be short, clear and precise. No quotes. Don't talk to me. Just write text\\n\";\n//diff-add\n        }\n//diff-add\n        const resp = await fetch('https://api.openai.com/v1/chat/completions', {\n//diff-add\n          method: 'POST',\n//diff-add\n          headers: {\n//diff-add\n            'Content-Type': 'application/json',\n//diff-add\n            'Authorization': `Bearer ${this.options.openAiApiKey}`\n//diff-add\n          },\n//diff-add\n          body: JSON.stringify({\n//diff-add\n            model: this.options.model || 'gpt-3.5-turbo',\n//diff-add\n            messages: [{ role: 'user', content, }],\n//diff-add\n            temperature: 0.7,\n//diff-add\n            max_tokens: this.options.expert?.maxTokens || 50,\n//diff-add\n            stop: ['.'],\n//diff-add\n          })\n//diff-add\n        });\n//diff-add\n        const data = await resp.json();\n//diff-add\n        let suggestion = data.choices[0].message.content + (\n//diff-add\n          data.choices[0].finish_reason === 'stop' ? (\n//diff-add\n            this.columnType === AdminForthDataTypes.TEXT ? '. ' : ''\n//diff-add\n          ) : ''\n//diff-add\n        );\n//diff-add\n        if (suggestion.startsWith(currentVal)) {\n//diff-add\n          suggestion = suggestion.slice(currentVal.length);\n//diff-add\n        }\n//diff-add\n        return { completion: suggestion };\n//diff-add\n      }\n    });\n  }\n"})}),"\n",(0,t.jsx)(e.p,{children:"Now we have to set custom input on create and edit pages for field which user defined in fieldName:"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-ts",metastring:"title='./af-plugin-chatgpt/index.ts'",children:"\nexport default class ChatGptPlugin extends AdminForthPlugin {\n  options: PluginOptions;\n\n//diff-add\n  resourceConfig!: AdminForthResource;\n//diff-add\n  columnType!: AdminForthDataTypes;\n\n  ...\n\n  async modifyResourceConfig(adminforth: IAdminForth, resourceConfig: AdminForthResource) {\n    super.modifyResourceConfig(adminforth, resourceConfig);\n//diff-add\n    this.resourceConfig = resourceConfig;\n//diff-add\n    if (!this.options.openAiApiKey) {\n//diff-add\n      throw new Error('OPENAI_API_KEY is required');\n//diff-add\n    }\n//diff-add\n    // ensure that column exists\n//diff-add\n    const column = this.resourceConfig.columns.find(f => f.name === this.options.fieldName);\n//diff-add\n    if (!column) {\n//diff-add\n      throw new Error(`Field ${this.options.fieldName} not found in resource ${this.resourceConfig.label}`);\n//diff-add\n    }\n//diff-add\n    if (!column.components) {\n//diff-add\n      column.components = {};\n//diff-add\n    }\n//diff-add\n    const filed = {\n//diff-add\n      file: this.componentPath('completionInput.vue'),\n//diff-add\n      meta: {\n//diff-add\n        pluginInstanceId: this.pluginInstanceId,\n//diff-add\n        fieldName: this.options.fieldName,\n//diff-add\n        debounceTime: 300,\n//diff-add\n      }\n//diff-add\n    }\n//diff-add\n    column.components.create = filed;\n//diff-add\n    column.components.edit = filed;\n//diff-add\n    this.columnType = column.type!;\n  }\n\n"})}),"\n",(0,t.jsx)(e.p,{children:"Additionally we should check that column type is string or text, otherwise our input will not work properly.\nFrom first sight we can make this validation in modifyResourceConfig method, but it is not good idea because we can't be sure that column type is\ndefined and known at this stage. If user defined it manually then it will be there, but if type is auto-discovered then it will be undefined at this stage."}),"\n",(0,t.jsxs)(e.p,{children:["That is why we will use ",(0,t.jsx)(e.code,{children:"validateConfigAfterDiscover"})," method:"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-ts",metastring:"title='./af-plugin-chatgpt/index.ts'",children:"  validateConfigAfterDiscover(adminforth: IAdminForth, resourceConfig: AdminForthResource) {\n//diff-add\n    const column = this.resourceConfig.columns.find(f => f.name === this.options.fieldName);\n//diff-add\n    if (![AdminForthDataTypes.STRING, AdminForthDataTypes.TEXT].includes(column!.type!)) {\n//diff-add\n      throw new Error(`Field ${this.options.fieldName} should be string or text type, but it is ${column!.type}`);\n//diff-add\n    }\n  }\n"})}),"\n",(0,t.jsxs)(e.p,{children:["Finally, since we want to support multiple installations on one resource (e.g. one plugin installation for ",(0,t.jsx)(e.code,{children:"title"})," field and another for ",(0,t.jsx)(e.code,{children:"description"})," field), we have to define plugin instance unique representation. Best idea in this case to use field name which will be different for each installation:"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-ts",metastring:"title='./af-plugin-chatgpt/index.ts'",children:"  instanceUniqueRepresentation(pluginOptions: any) : string {\n//diff-add\n    return `${pluginOptions.fieldName}`;\n//diff-remove\n    return `single`;\n  }\n"})}),"\n",(0,t.jsx)(e.p,{children:"Ro compile plugin run:"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"npm run build\n"})}),"\n",(0,t.jsxs)(e.p,{children:["You can also publish your plugin to npm using ",(0,t.jsx)(e.code,{children:"npm publish"}),"."]}),"\n",(0,t.jsx)(e.h2,{id:"installation-of-plugin",children:"Installation of plugin"}),"\n",(0,t.jsx)(e.p,{children:"If you want to test your plugin locally before publishing, enter plugin dir and run:"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"cd af-plugin-chatgpt\nnpm link\n"})}),"\n",(0,t.jsx)(e.p,{children:"Then enter your AdminForth project and run:"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"npm link af-plugin-chatgpt\n"})}),"\n",(0,t.jsxs)(e.p,{children:["Now  in your app ",(0,t.jsx)(e.code,{children:"index.ts"})," file:"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-ts",metastring:"title='./index.ts'",children:"\nimport ChatGptPlugin from 'af-plugin-chatgpt';\n\n...\n\n{\n  resourceId: 'aparts',\n  ...\n  plugins: [\n    ...\n    new ChatGptPlugin({\n      openAiApiKey: process.env.OPENAI_API_KEY as string,\n      fieldName: 'title',\n    }),\n    new ChatGptPlugin({\n      openAiApiKey: process.env.OPENAI_API_KEY as string,\n      fieldName: 'description',\n    }),\n  ]\n}\n\n"})}),"\n",(0,t.jsxs)(e.p,{children:["Go to ",(0,t.jsx)(e.a,{href:"https://platform.openai.com/",children:"https://platform.openai.com/"}),", go to Dashboard -> API keys -> Create new secret key. Paste value in your ",(0,t.jsx)(e.code,{children:".env"})," file OPENAI_API_KEY=your_key"]}),"\n",(0,t.jsxs)(e.blockquote,{children:["\n",(0,t.jsxs)(e.p,{children:["\ud83e\udee8 Using ",(0,t.jsx)(e.code,{children:"npm link"})," approach still requires ",(0,t.jsx)(e.code,{children:"npm run build"})," in plugin dir after each change because plugin entry point is defined as ",(0,t.jsx)(e.code,{children:"dist/index.js"})," in\n",(0,t.jsx)(e.code,{children:"package.json"})," file. To speed up plugin development you can also don't use ",(0,t.jsx)(e.code,{children:"npm link"})," and just import plugin main file from your demo file:"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{children:"import ChatGptPlugin from '<path to af plugin>/af-plugin-chatgpt/index.js';\n"})}),"\n"]}),"\n",(0,t.jsxs)(e.blockquote,{children:["\n",(0,t.jsxs)(e.p,{children:["\ud83c\udf93 Homework: Extend ",(0,t.jsx)(e.code,{children:"expert"})," settings section to include next parameters: ",(0,t.jsx)(e.code,{children:"temperature"}),", ",(0,t.jsx)(e.code,{children:"promptLimit"}),", ",(0,t.jsx)(e.code,{children:"debounceTime"}),","]}),"\n"]})]})}function p(n={}){const{wrapper:e}={...(0,o.R)(),...n.components};return e?(0,t.jsx)(e,{...n,children:(0,t.jsx)(c,{...n})}):c(n)}},8453:(n,e,i)=>{i.d(e,{R:()=>s,x:()=>a});var t=i(6540);const o={},d=t.createContext(o);function s(n){const e=t.useContext(d);return t.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function a(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(o):n.components||o:s(n.components),t.createElement(d.Provider,{value:e},n.children)}}}]);