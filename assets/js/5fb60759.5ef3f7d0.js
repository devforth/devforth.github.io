"use strict";(self.webpackChunkadminforth=self.webpackChunkadminforth||[]).push([[5859],{63885:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>a,default:()=>h,frontMatter:()=>t,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"tutorial/Customization/security","title":"Security","description":"Security and privacy if adminforth users is one of the most important aspects of AdminForth.","source":"@site/docs/tutorial/03-Customization/12-security.md","sourceDirName":"tutorial/03-Customization","slug":"/tutorial/Customization/security","permalink":"/docs/tutorial/Customization/security","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":12,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Data API","permalink":"/docs/tutorial/Customization/dataApi"},"next":{"title":"Standard pages tuning","permalink":"/docs/tutorial/Customization/standardPagesTuning"}}');var r=s(74848),o=s(28453);const t={},a="Security",d={},l=[{value:"How long does user login last?",id:"how-long-does-user-login-last",level:2},{value:"Password strength",id:"password-strength",level:2},{value:"Trusting client IP addresses",id:"trusting-client-ip-addresses",level:2},{value:"Using proxing CDNs",id:"using-proxing-cdns",level:3},{value:"Using reverse proxy",id:"using-reverse-proxy",level:3},{value:"Backend-only fields",id:"backend-only-fields",level:3},{value:"Dynamically hide fields depending on user ACL / role",id:"dynamically-hide-fields-depending-on-user-acl--role",level:4},{value:"Custom user authorization hook",id:"custom-user-authorization-hook",level:2}];function c(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"security",children:"Security"})}),"\n",(0,r.jsx)(n.p,{children:"Security and privacy if adminforth users is one of the most important aspects of AdminForth."}),"\n",(0,r.jsx)(n.h2,{id:"how-long-does-user-login-last",children:"How long does user login last?"}),"\n",(0,r.jsxs)(n.p,{children:["By default after authentication user session lasts for 24 hours. After that user is redirected to login page.\nYou can tweak login cookie expiration time by setting environment ",(0,r.jsx)(n.code,{children:"ADMINFORTH_AUTH_EXPIRESIN"}),". For example to set it to 1 hour:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"ADMINFORTH_AUTH_EXPIRESIN=1h\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Also you can set ",(0,r.jsx)(n.code,{children:"auth.rememberMeDays"}),' in the config to set how long "remember me" logins will last.\nFor example to set it to 7 days:']}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",metastring:"./index.ts",children:"new AdminForth({\n  ...\n  auth: {\n    rememberMeDays: 7\n  }\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:'In this case users who will check "Remember me" checkbox will be logged in for 7 days instead of 24 hours.'}),"\n",(0,r.jsx)(n.h2,{id:"password-strength",children:"Password strength"}),"\n",(0,r.jsxs)(n.p,{children:["AdminForth allows to set validation RegExp based rules for any field. This can be reused for password strength validation.\n",(0,r.jsx)(n.a,{href:"/docs/tutorial/gettingStarted",children:"Getting started"})," guide suggests you to set next parameters for password field:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",metastring:"./index.ts",children:"  minLength: 8,\n  validation: [\n    AdminForth.Utils.PASSWORD_VALIDATORS.UP_LOW_NUM,\n  ],\n"})}),"\n",(0,r.jsx)(n.p,{children:"So when admin user will create another user, password will be validated against next rules:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"At least 8 characters"}),"\n",(0,r.jsx)(n.li,{children:"At least one uppercase letter"}),"\n",(0,r.jsx)(n.li,{children:"At least one lowercase letter"}),"\n",(0,r.jsx)(n.li,{children:"At least one number"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"For improving requirement you might also request special character:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",metastring:"./index.ts",children:"  minLength: 8,\n  validation: [\n    AdminForth.Utils.PASSWORD_VALIDATORS.UP_LOW_NUM_SPECIAL\n  ],\n"})}),"\n",(0,r.jsx)(n.p,{children:"Also you can add custom rules. For example to prevent popular words:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",metastring:"./index.ts",children:"  minLength: 8,\n  validation: [\n    {\n      regExp: '^(?!.*(?:qwerty|password|user|login|qwerty|123456)).*$',\n      message: 'Password cannot contain easily guessed words'\n    },\n    AdminForth.Utils.PASSWORD_VALIDATORS.UP_LOW_NUM_SPECIAL,\n  ],\n"})}),"\n",(0,r.jsxs)(n.p,{children:["All rules defined in password column will be also delivered to ",(0,r.jsx)(n.a,{href:"/docs/tutorial/Plugins/email-password-reset",children:"password reset plugin"})," if you are using it to ensure that password reset will also respect same rules."]}),"\n",(0,r.jsx)(n.h2,{id:"trusting-client-ip-addresses",children:"Trusting client IP addresses"}),"\n",(0,r.jsxs)(n.p,{children:["Adminforth provides ",(0,r.jsx)(n.code,{children:"admin.auth.getClientIp(headers)"})," function to get client IP address."]}),"\n",(0,r.jsx)(n.p,{children:"This function is used for:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Rate limiting in some standard plugins like those who are using OpenAI to protect against abuse"}),"\n",(0,r.jsx)(n.li,{children:"Securely logging user actions e.g. in Audit Log plugin"}),"\n",(0,r.jsx)(n.li,{children:"Can be used by your own code e.g. hooks to write first login/last login IP address to db"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["By default it reads ",(0,r.jsx)(n.code,{children:"X-Forwarded-For"})," header from request headers to determine client IP address.\nAdminForth does not understand whether this header can be trusted or no. In some cases it might be spoofed by client like this:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'curl -H "X-Forwarded-For: <made-out IP>" http://your-server/api...\n'})}),"\n",(0,r.jsx)(n.p,{children:"So you should take additional care to make sure that this header is not spoofed."}),"\n",(0,r.jsx)(n.h3,{id:"using-proxing-cdns",children:"Using proxing CDNs"}),"\n",(0,r.jsx)(n.p,{children:"If you are using proxying CDN like Cloudflare before your app which is probably best approach for security and performance, you should 3 things:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Make sure you use orange cloud in Cloudflare on domain serving app to proxy all traffic through Cloudflare."}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Set config auth.clientIpHeader to the header that CDN uses to pass client IP address.\nFor Cloudflare it is ",(0,r.jsx)(n.code,{children:"CF-Connecting-IP"}),":"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",metastring:"./index.ts",children:"new AdminForth({\n  ...\n  auth: {\n    clientIpHeader: 'CF-Connecting-IP'\n  }\n}\n"})}),"\n",(0,r.jsxs)(n.ol,{start:"3",children:["\n",(0,r.jsxs)(n.li,{children:["Make sure that your server is only accepting requests from CDN IP addresses (or ranges). For Cloudflare this info is here: ",(0,r.jsx)(n.a,{href:"https://www.cloudflare.com/ips/",children:"https://www.cloudflare.com/ips/"})," . You can set it in firewall e.g. in AWS security group, or in software firewall like UFW. There is even a script which you can use in cron ",(0,r.jsx)(n.a,{href:"https://github.com/Paul-Reed/cloudflare-ufw",children:"https://github.com/Paul-Reed/cloudflare-ufw"})," (just in case if list of IPs will change in future)."]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"using-reverse-proxy",children:"Using reverse proxy"}),"\n",(0,r.jsxs)(n.p,{children:["If first client-facing point is reverse proxy like Nginx, or Traefik and there is no more proxies like CDN behind it, you should take care of reliably setting ",(0,r.jsx)(n.code,{children:"X-Forwarded-For"})," header to the client IP address.\nMain trick here is to make sure that proxy strips any ",(0,r.jsx)(n.code,{children:"X-Forwarded-For"})," headers that are already present in the requeqst and hardly overwrites it with client IP address coming from TCP connection (it can't be spoofed by client)."]}),"\n",(0,r.jsxs)(n.p,{children:["In Traefik to set ",(0,r.jsx)(n.code,{children:"X-Forwarded-For"})," header you should set ",(0,r.jsx)(n.code,{children:"forwardedHeaders"})," in traefik config:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'\n adminforth:\n    build: ./app\n    environment:\n      - NODE_ENV=production\n      - ADMINFORTH_SECRET=!CHANGEME! # \u261d\ufe0f replace with your secret\n      ...\n    labels:\n    - "traefik.http.middlewares.sanitize-headers.headers.customRequestHeaders.X-Forwarded-For=$remote_addr"\n    # enable middleware\n    - "traefik.http.routers.adminforth.middlewares=sanitize-headers"\n'})}),"\n",(0,r.jsxs)(n.p,{children:["For nginx you should set ",(0,r.jsx)(n.code,{children:"proxy_set_header X-Forwarded-For $remote_addr;"})," in your nginx config:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-nginx",children:"server {\n    ...\n    location / {\n        proxy_pass http://localhost:3000;\n        proxy_set_header X-Forwarded-For $remote_addr;\n    }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"backend-only-fields",children:"Backend-only fields"}),"\n",(0,r.jsxs)(n.p,{children:["Some fields should never be accessed on frontend. For example, ",(0,r.jsx)(n.code,{children:"hashed_password"})," field which is always created using CLI initial app, should never be passed to frontend due to security reasons.\nIf any user of system can read ",(0,r.jsx)(n.code,{children:"hashed_password"})," of another user, it can lead to account compromise."]}),"\n",(0,r.jsx)(n.p,{children:"To eliminate it we have 2 options:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Do not list ",(0,r.jsx)(n.code,{children:"password_hash"})," in the ",(0,r.jsx)(n.code,{children:"columns"})," array of the resource. If AdminForth knows nothing about field\nit will never pass this field to frontend!"]}),"\n",(0,r.jsxs)(n.li,{children:["Define ",(0,r.jsx)(n.code,{children:"password_hash"})," in columns way but set ",(0,r.jsx)(n.code,{children:"backendOnly"}),"."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"The second option is more explicit and should be preferred. This option is used by default in CLI-bootstrapped projects:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"{\n  name: 'password_hash',\n  type: AdminForthDataTypes.STRING,\n  showIn: { all: false },\n  backendOnly: true,  // will never go to frontend\n}\n"})}),"\n",(0,r.jsx)(n.h4,{id:"dynamically-hide-fields-depending-on-user-acl--role",children:"Dynamically hide fields depending on user ACL / role"}),"\n",(0,r.jsxs)(n.p,{children:["You can use ",(0,r.jsx)(n.code,{children:"column.showIn"})," to show or hide column for user depending on his role."]}),"\n",(0,r.jsxs)(n.p,{children:["However even if ",(0,r.jsx)(n.code,{children:"showIn"})," value (or value returned by showIn function) is ",(0,r.jsx)(n.code,{children:"false"}),", record value will still go to frontend and will be\nvisible in the Network tab, so advanced user can still access field value. We did it in this way to provide AdminForth developers with ability to quickly use any record field in custom components."]}),"\n",(0,r.jsxs)(n.p,{children:["However if you need securely hide only certain fields depending on role, you should use ",(0,r.jsx)(n.code,{children:"column.backendOnly"})," and pass function there."]}),"\n",(0,r.jsx)(n.p,{children:"Let's consider example:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"{\n  name: 'email',\n  type: AdminForthDataTypes.STRING,\n  showIn: { \n//diff-add\n    all: false, \n//diff-add\n    list: ({ adminUser }: { adminUser: AdminUser }) => adminUser.dbUser.role === 'superadmin',\n  },\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"So if you will configure the email column in user resource like this, only superadmin will be able to see emails, and only in the list view.\nHowever, the email will still be present in the record and can be accessed by advanced users through the Network tab."}),"\n",(0,r.jsxs)(n.p,{children:["So to completely hide the email field from all users apart superadmins, you should use ",(0,r.jsx)(n.code,{children:"column.backendOnly"})," and pass a function there."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"{\n  name: 'email',\n  type: AdminForthDataTypes.STRING,\n//diff-add\n  backendOnly: ({ adminUser }: { adminUser: AdminUser }) => adminUser.dbUser.role === 'superadmin',\n  showIn: { \n    all: false, \n    list: ({ adminUser }: { adminUser: AdminUser }) => adminUser.dbUser.role === 'superadmin',\n  },\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"So if you will configure the email column in user resource like this, only superadmin will be able to see emails, and only in the list view."}),"\n",(0,r.jsx)(n.h2,{id:"custom-user-authorization-hook",children:"Custom user authorization hook"}),"\n",(0,r.jsx)(n.p,{children:"Default user authorization checks that cookie with JWT token is valid, signed and not expired.\nYou can use custom hook to decide whether to allow exections of all default and cusotm API endpoints (wraped by authorize middleware) based on user fields."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",metastring:'title="./index.ts"',children:"export const admin = new AdminForth({\n\n  ...\n\n  auth: {\n    adminUserAuthorize: [\n      async ({adminUser, adminforth, extra}) => {\n        if (adminUser.dbUser.status === 'banned') {\n          return { allowed: false, error: \"User is banned\" };\n        }\n        return { allowed: true };\n      }]\n  }\n\n  ...\n\n})\n\n"})}),"\n",(0,r.jsx)(n.p,{children:'Now, if a user\u2019s field "status" is changed to "banned", they won\u2019t be able to perform any actions and will be automatically logged out upon accessing the page.'})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},28453:(e,n,s)=>{s.d(n,{R:()=>t,x:()=>a});var i=s(96540);const r={},o=i.createContext(r);function t(e){const n=i.useContext(o);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:t(e.components),i.createElement(o.Provider,{value:n},e.children)}}}]);